#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

url="$("$DOROTHY/commands/ask-mandatory" 'What URL to format to the protocol?' "${1-}")"
protocol="$("$DOROTHY/commands/git-protocol-ask" "${2-}")"

# remove ssh prefix
url="${url#*git@}"
# remove https prefix
url="${url#*://}"
# remove .git suffix
url="${url%.git*}"

# fetch domain
domain="${url%:*}"
if test -z "$domain" -o "$domain" = "$url"; then
	domain="${url%/*}" # trims repo
	domain="${domain%/*}" # trims user
fi
# echo "domain=$domain"

# fetch path
path="${url#*:}"
if test -z "$path" -o "$path" = "$url"; then
	path="${url#*/}"
fi
# echo "path=$path"

# note that the format is not as expected
if test "$protocol" = 'https'; then
	# https: ssh://git@github.com/balupton/dotfiles.git

	# this: "https://$domain/$path.git"
	# gets converted to the below
	echo "ssh://git@$domain/$path.git"

	# > git remote rm origin
	# > git remote add origin 'https://github.com/balupton/dotfiles.git'
	# > git remote -v
	# origin	ssh://git@github.com/balupton/dotfiles.git (fetch)
elif test "$protocol" = 'ssh'; then
	# ssh: git@github.com:balupton/dotfiles.git
	echo "git@$domain:$path.git"
else
	exit 1
fi
