#!/usr/bin/env bash

# https://github.com/ghostty-org/ghostty
# https://ghostty.org/docs/install/binary

# https://github.com/ghostty-org/ghostty/releases
# ghostty-macos-universal-debug-fast.zip
# ghostty-macos-universal-debug-slow.zip
# ghostty-macos-universal.zip
# ghostty-source.tar.gz
# Ghostty.dmg

# https://github.com/dariogriffo/ghostty-debian/releases
# ghostty_1.2.3-1+forky_amd64.deb
# ghostty_1.2.3-1+sid_amd64.deb
# ghostty_1.2.3-1+trixie_amd64.deb

# https://github.com/mkasberg/ghostty-ubuntu/releases
# ghostty_1.2.3-0.ppa1_amd64_24.04.deb
# ghostty_1.2.3-0.ppa1_amd64_25.04.deb
# ghostty_1.2.3-0.ppa1_amd64_25.10.deb
# ghostty_1.2.3-0.ppa1_amd64_trixie.deb
# ghostty_1.2.3-0.ppa1_arm64_24.04.deb
# ghostty_1.2.3-0.ppa1_arm64_25.04.deb
# ghostty_1.2.3-0.ppa1_arm64_25.10.deb
# ghostty_1.2.3-0.ppa1_arm64_trixie.deb

# https://github.com/pkgforge-dev/ghostty-appimage/releases
# Ghostty-1.2.3-aarch64.AppImage
# Ghostty-1.2.3-x86_64.AppImage

# https://repology.org/project/ghostty/versions

function setup_util_ghostty() (
	source "$DOROTHY/sources/bash.bash"

	# setup
	local app_options=(
		--app='Ghostty'
		--app='com.mitchellh.ghostty' # linux .desktop
	)
	local options=(
		--name='ghostty'
		"${app_options[@]}"
		"$@"
	)
	if __is_windows; then
		options+=(
			SCOOP_BUCKET='extras'
			SCOOP='ghostty'
			WINGET='smartfrigde.ghostty'
		)
	else
		# improve performance for detectable utilities with conditional assets
		if setup-util --check "${app_options[@]}" "$@"; then
			return 0
		fi

		# setup
		options+=(
			AUR='ghostty'
			CASK='ghostty'
			DNF_COPR='scottames/ghostty'
			DNF='ghostty'
			NIX='ghostty'
			MACPORTS='ghostty'
			# SOAR='ghostty'
			# PACSTALL='ghostty-deb'
		)
		local arch
		arch="$(__get_arch)"
		function __get_github_asset_url {
			local repo="$1" suffix="$2" regexp
			regexp="$(echo-escape-regexp -- "$suffix")$" || return $?
			github-download --dry --slug="$repo" --latest --asset-regexp="$regexp" | echo-first-line || return $?
		}
		function __add_download_option {
			local repo="$1" suffix="$2" url
			url="$(__get_github_asset_url "$repo" "$suffix")" || return $?
			options+=(DOWNLOAD="$url")
		}
		function __add_deb_option {
			local repo="$1" suffix="$2" url
			url="$(__get_github_asset_url "$repo" "$suffix")" || return $?
			options+=(DEB="$url")
		}
		function __add_download_appimage_option {
			local repo="$1" suffix="$2" url
			url="$(__get_github_asset_url "$repo" "$suffix")" || return $?
			options+=(
				DOWNLOAD="$url"
				DOWNLOAD_FILENAME='Ghostty.appimage'
			)
		}
		if __is_macos; then
			__add_download_option 'ghostty-org/ghostty' '-macos-universal.zip' || :
		elif __is_linux; then
			if [[ $arch == 'a64' ]]; then
				__add_download_appimage_option 'pkgforge-dev/ghostty-appimage' '-aarch64.AppImage' || :
			elif [[ $arch == 'x64' ]]; then
				__add_download_appimage_option 'pkgforge-dev/ghostty-appimage' '-x86_64.AppImage' || :
			fi
			if is-system --debian; then
				local codename
				codename="$(get-system --codename)" || :
				if [[ -n $codename && $arch == 'x64' ]]; then
					__add_deb_option 'dariogriffo/ghostty-debian' "+${codename}_amd64.deb" || :
				fi
			elif is-system --ubuntu; then
				local version
				version="$(get-system --version)" || :
				if [[ -n $version ]]; then
					if [[ $arch == 'a64' ]]; then
						__add_deb_option 'mkasberg/ghostty-ubuntu' "_arm64_${version}.deb" || :
					elif [[ $arch == 'x64' ]]; then
						__add_deb_option 'mkasberg/ghostty-ubuntu' "_amd64_${version}.deb" || :
					fi
				fi
			fi
		fi
	fi
	setup-util "${options[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_ghostty "$@"
fi
