#!/usr/bin/env bash

# https://github.com/yt-dlp/yt-dlp
# https://github.com/yt-dlp/yt-dlp?tab=readme-ov-file#installation
# https://github.com/yt-dlp/yt-dlp/releases

# yt-dlp Platform-independent zipimport binary. Needs Python (recommended for Linux/BSD)
# yt-dlp.exe Windows (Win8+) standalone x64 binary (recommended for Windows)
# yt-dlp.tar.gz Source tarball
# yt-dlp_linux Linux standalone x64 binary
# yt-dlp_linux_aarch64 Linux standalone aarch64 (64-bit) binary
# yt-dlp_linux_armv7l Linux standalone armv7l (32-bit) binary
# yt-dlp_macos Universal MacOS (10.15+) standalone executable (recommended for MacOS)
# yt-dlp_macos.zip Unpackaged MacOS (10.15+) executable (no auto-update)
# yt-dlp_macos_legacy MacOS (10.9+) standalone x64 executable
# yt-dlp_win.zip Unpackaged Windows executable (no auto-update)
# yt-dlp_x86.exe Windows (Win8+) standalone x86 (32-bit) binary

function setup_util_yt_dlp() (
	source "$DOROTHY/sources/bash.bash"

	# don't improve performance, as we want to ensure correct cli

	# uninstall all options and download directly, so nothing lags behind
	# python option is unusable now, as it also lags behind, and has externally-managed-environment complexities
	local arch options=(
		--uninstall
		--quiet
		--name='yt-dlp'
		APT_REPO='ppa:yt-dlp/stable'
		APT='yt-dlp' # UBUNTU
		AUR='yt-dlp' # ARCH
		BREW='yt-dlp'
		CHOCO='yt-dlp'
		PKG='yt-dlp'
		PORT='yt-dlp'
		SCOOP='yt-dlp'
		UV='yt-dlp'
		WINGET='yt-dlp'
	)
	setup-util "${options[@]}" || :

	# only use pip
	options=(
		--optional
		--cli='yt-dlp'
		--name='yt-dlp'
		"$@"
	)
	function get_github_asset_url {
		github-download \
			--dry \
			--slug='yt-dlp/yt-dlp' \
			--latest \
			--asset-regexp="^$(echo-escape-regexp -- "$1")$" | echo-first-line || :
	}
	function add_download_option {
		options+=(
			DOWNLOAD="$(get_github_asset_url "$1")"
		)
	}
	arch="$(get-arch)"
	if is-mac; then
		add_download_option 'yt-dlp_macos'
	elif is-linux; then
		if [[ $arch == 'a64' ]]; then
			add_download_option 'yt-dlp_linux_aarch64'
		elif [[ $arch == 'a32' ]]; then
			add_download_option 'yt-dlp_linux_armv7l'
		elif [[ $arch == 'x64' ]]; then
			add_download_option 'yt-dlp_linux'
		fi
	elif is-windows; then
		if [[ $arch == 'x64' ]]; then
			add_download_option 'yt-dlp.exe'
		elif [[ $arch == 'x32' ]]; then
			add_download_option 'yt-dlp_x86.exe'
		fi
	fi
	setup-util "${options[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_yt_dlp "$@"
fi
