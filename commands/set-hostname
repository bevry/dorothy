#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# @todo: investigate macOS support.

new_hostname="$1"

if command-exists setup-hostname; then
	# https://wiki.alpinelinux.org/wiki/Alpine_setup_scripts#setup-hostname
	setup-hostname -n "$new_hostname"
elif command-exists 'hostnamectl'; then
	# old hostname
	old_hostname="$(get-hostname)"

	# apply the hostname
	sudo hostnamectl set-hostname "$new_hostname"

	# write the hostname to the /etc/hosts file, this was necessary for a forgotten reason
	# instead of two --expression, can also do -e 's//; s//'
	# don't use sd, as this runs in initial setup
	sudo sed --null-data --in-place --regexp-extended \
		--expression="s#127.0.0.1\s+(${old_hostname}|${new_hostname})\n##g" \
		--expression="s#(\s+)localhost\n#\1localhost\n127.0.0.1\1${new_hostname}\n#" \
		/etc/hosts
	# cat /etc/hosts

	# restart the name server
	sudo systemctl restart nmbd
fi
