#!/usr/bin/env bash

function echo_filter_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- echo-filter --help

	eval-tester --name='no args' -- \
		echo-filter

	eval-tester --name='no args' -- \
		echo-filter --

	# respect case
	eval-tester --stdout=$'A\nC\ne\na\nb\n' --trailing-newlines -- \
		echo-filter -- A C e a b a b

	__print_lines A C e a b a b | eval-tester --stdout=$'A\nC\ne\na\nb\n' --trailing-newlines -- \
		echo-filter --stdin

	# ignore case
	eval-tester --stdout=$'a\nc\ne\nb\n' --trailing-newlines -- \
		echo-filter --ignore-case -- A C e a b a b

	__print_lines A c e a b a b | eval-tester --stdout=$'a\nc\ne\nb\n' --trailing-newlines -- \
		echo-filter --stdin --ignore-case

	return 0
)
function echo_filter() (
	source "$DOROTHY/sources/stdinargs.bash"

	# =====================================
	# Arguments

	function __help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Filter each <input> by the options.

			USAGE:
			\`echo-filter [...options] [--] ...<input>\`
			\`echo-lines ...<input> | echo-filter [...options]\`

			OPTIONS:
			--case=lower | --lowercase
			    Compare elements of <input> irrespective of case, and return a lowercase result.
			--case=upper | --uppercase
			    Compare elements of <input> irrespective of case, and return an uppercase result.
			--case=ignore | --ignore-case
			    Compare elements of <input> irrespective of case.
			--case=sensitive
			    Compare elements of <input> normally, respecting case. The default behaviour.

			$(__stdinargs__help_options --)
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item options_filter=() option_stdinargs=()
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--no-color'* | '--color' | '--no-stdin'* | '--stdin' | '--no-timeout'* | '--timeout' | '--no-inline'* | '--inline' | '--max-args=' | '-' | '--') option_stdinargs+=("$item") ;;
		'--'*) options_filter+=("$item") ;;
		*) option_stdinargs+=("$item") ;;
		esac
	done

	# =====================================
	# Action

	local pieces=()
	function __on_piece {
		pieces+=("$1")
	}
	function __on_finish {
		local results=()
		__filter --source={pieces} --target={results} "${options_filter[@]}" || return $?
		__print_lines "${results[@]}" || return $?
	}

	stdinargs "${option_stdinargs[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		echo_filter_test
	else
		echo_filter "$@"
	fi
fi
