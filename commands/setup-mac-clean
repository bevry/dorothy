#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# log
echo-segment --h1='Clean macOS'

# Clean brew
echo-segment --h2='Cleaning homebrew caches'
eval-collapse --- brew cleanup
echo-segment --g2='Cleaning homebrew caches'

# Remove updates that are not cleaned automatically
echo-segment --h2='Cleaning application update caches'
rm -Rf "$HOME/Library/Application Support/Plex Media Server/Updates"
rm -Rf "$HOME/Library/Application Support/Spotify/PersistentCache/Update"
echo-segment --g2='Cleaned application update caches'

# Remove cache
echo-segment --h2='Cleaning system caches'
rm -Rf "$HOME/.cache"
mkdir -p "$HOME/Library/Caches"
mkdir -p "$HOME/.cache/gems"
mkdir -p "$HOME/.cache/pip/http"
mkdir -p "$HOME/Library/Caches/pip/http"
echo-segment --g2='Cleaned system caches'

# npm
if command-exists npm; then
	{
		echo-segment --h2='Cleaning npm caches'
		source "$DOROTHY/sources/nvm.sh"
		{
			# use `|| :`` as nvm is a function
			nvm use node || :
			npm cache clean --force || :
			nvm use system || :
			npm cache clean --force || :
			nvm use default || :
			npm cache clean --force || :
		} &>/dev/null
		echo-segment --g2='Cleaned npm caches'
	} || {
		echo-segment --e2='Cleaned npm caches'
	}
fi

# done
echo-segment --g1='Clean macOS'
