#!/usr/bin/env bash

function echo_style_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- echo-style --help
)

function echo_style() (
	source "$DOROTHY/sources/bash.bash"
	source "$DOROTHY/sources/styles.bash" # load style names

	function __get_names_of_all_styles {
		# this will have duplicates from monocolor/multicolor/end combinations
		declare -p | echo-regexp -gon 'STYLE__[A-Z_]*([^ =]+)' '$1' | sort -u
	}
	function __help {
		# trunk-ignore(shellcheck/SC2034)
		local styles=()
		__split --target={styles} --no-zero-length --invoke -- __get_names_of_all_styles
		__print_help "$@" <<-EOF || return $?
			USAGE:
			\`echo-style [...options] [--<style>] [--<style>+<style>] <value> [--<style>=<value>] [--<style>+<style>=<value>]\`

			OPTIONS:
			--[no-]trail
			    If disabled, des not output a trailing newline.

			--[no-]color | --[no-]colors
			    If enabled, enforces multicolor styles.
			    If disabled, enforces monocolor styles.

			EXPLANATION:
			* \`--<style>=<value>\` will apply the <style> only to that <value>.
			* \`--<style> <value> <value>\` will apply the <style> to all subsequent <value>s, until \`--reset\` is provided.
			* \`--blue+bold=<value> <value>\` will make the first <value> blue and bold, with no style to the second <value>.
			* \`--blue --bold <value> <value>\` will make the <value>s blue and bold.
			* Dashes \`-\` in <style>s are converted to underscores \`_\`, e.g. \`foreground-red\` is becomes the underlying \`foreground_red\`.
			* Some styles have a combination of \`MONOCOLOR\`, \`MULTICOLOR\`, and \`END\` variants.

			MONOCOLOR VS MULTICOLOR:
			If \`env COLOR=no\` or \`--no-color[s]/--color[s]=no\` then monocolor styles are applied.
			Use \`--multicolor=<value>\` to indicate the value should only be outputted if colors are.
			Use \`--monocolor=<value>\` to indicate the value should only be outputted if colors are not.

			SHORTHAND STYLES:
			* \`<color>\` is shorthand for \`foreground_<color>\`
			* \`intense_<color>\` is shorthand for \`foreground_intense_<color>\`
			* \`/<style>\` is shorthand for \`slash_<style>\`
			* \`<style>/\` is shorthand for \`<style>_slash\`

			TYPICAL STYLES:
			* Colors: $(__join --style=code --between=', ' -- black red green yellow blue magenta cyan white)
			* Intensities: $(__join --style=code --between=', ' -- bold dim)
			* Decorations: $(__join --style=code --between=', ' -- italic underline double_underline invert conceal strike framed circled overlined)
			* Special: $(__join --style=code --between=', ' -- reset newline tab space ellipsis)
			* Terminal: $(__join --style=code --between=', ' -- bell backspace home terminal_title terminal_resize terminal_clipboard clear_line delete_line clear_screen)

			SPECIAL STYLES:
			* \`status\` adjusts style based on success exit status zero, or failure exit status non-zero
			* \`multicolor\` only outputs the value if colors are enabled
			* \`monocolor\` only outputs the value if colors are disabled
			* \`stdout\`, \`stderr\`, \`tty\`, \`debug\`, \`null\` set the target
			* \`value\` outputs the <value> with value styling
			* \`variable\` treats the <value> as a variable name, outputting the variable name and its value
			* \`variable-value\` treats the <value> as a variable name, outputting only its value
			* \`help\` process the <value> with \`__print_help\`
			* \`error\` outputs the <value> with error styling, however you should use \`echo-error\` or \`__print_error\` for errors instead
			* \`key\` styles the <value> as a keyboard key
			* \`element\`, \`/element\`, \`element/\` styles the <value> as an opening element, a closing element, and a self-closing element respectively
			* \`h1\` outputs a level 1 segment header
			* \`n1\` outputs a level 1 segment footer
			* \`e1\` outputs a level 1 error-styled segment footer
			* \`g1\` outputs a level 1 success-styled segment footer

			EXAMPLES:
			\`\`\`
			echo-style --blue+bold='this is blue and bold' ' and this is normal'
			\`\`\`
			Outputs: $(echo-style --blue+bold='this is blue and bold' ' and this is normal')

			\`\`\`
			echo-style --blue --bold 'this is blue and bold' ' and so is this'
			\`\`\`
			Outputs: $(echo-style --blue --bold 'this is blue and bold' ' and so is this')

			\`\`\`
			echo-style --bold --blue 'this is bold and blue' ' and so is this' --yellow ' this is yellow and bold' ' and so is this' --reset ' and' ' these' ' are' ' normal'
			\`\`\`
			Outputs: $(echo-style --bold --blue 'this is bold and blue' ' and so is this' --yellow ' this is yellow and bold' ' and so is this' --reset ' and' ' these' ' are' ' normal')

			\`\`\`
			echo-style --bold='first' --monocolor=' ' --multicolor+dim=' → ' --bold='second'
			\`\`\`
			Outputs: $(echo-style --bold='first' --monocolor=' ' --multicolor+dim=' → ' --bold='second')

			\`\`\`
			env COLOR=no echo-style --bold='first' --monocolor=' ' --multicolor+dim=' → ' --bold='second'
			\`\`\`
			Outputs: $(env COLOR=no echo-style --bold='first' --monocolor=' ' --multicolor+dim=' → ' --bold='second')

			ALL STYLES:
			$(__join --source={styles} --style=code --join=', ').
			Styles are defined in \`$DOROTHY/sources/styles.bash\`
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	if [[ $* == '--help' ]]; then
		__help || return $?
	else
		__print_style "$@" || return $?
	fi
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		echo_style_test
	else
		echo_style "$@"
	fi
fi
