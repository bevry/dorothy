#!/usr/bin/env bash

# https://github.com/obsproject/obs-studio/releases
# OBS-Studio-30.0-Full-Installer-x64.exe
# OBS-Studio-30.0.0-macOS-Apple-dSYMs.tar.xz
# OBS-Studio-30.0.0-macOS-Apple.dmg
# OBS-Studio-30.0.0-macOS-Intel-dSYMs.tar.xz
# OBS-Studio-30.0.0-macOS-Intel.dmg
# OBS-Studio-30.0.0-Ubuntu-x86_64-dbsym.ddeb
# OBS-Studio-30.0.0-Ubuntu-x86_64.deb
# OBS-Studio-30.0.zip
# obs-studio_30.0.0-0obsproject1.jammy_amd64.deb
# obs-studio_30.0.0-0obsproject1.lunar_amd64.deb
# obs-studio_30.0.0-0obsproject1.mantic_amd64.deb

# https://obsproject.com/download#linux

function setup_util_obs() (
	source "$DOROTHY/sources/bash.bash"

	# options
	local option_reconfigure='yes' app_options=(
		--app='OBS'        # macos
		--app='OBS Studio' # flatpak
	)
	__flag --target={option_reconfigure} --name='reconfigure' --affirmative --coerce -- "$@"

	# helpers
	function __reconfigure {
		# if reconfigure is not desired, or if not installed, then don't reconfigure
		if [[ $option_reconfigure == 'no' ]] || get-app --first --quiet "${app_options[@]}"; then
			return 0
		fi

		# Flatpak
		if is-system --flatpak && get-app --quiet "${app_options[@]}" --source='flatpak'; then
			# Fix flatpak via wayland not having access to youtube plugin and codecs
			bash -c "$(fetch https://raw.githubusercontent.com/vol1t/OBS-Studio-Flatpak-XWayland-Universal-Fix/refs/heads/Main/obs-xwayland-fix.sh)"
		fi
	}

	# determine options
	local options=(
		--name='Open Broadcaster Software'
		"${app_options[@]}"
		# prefer flatpak as with modifications it actually works, the others work but are half baked - no youtube plugins, no proper codec access
		--order='flatpak ...'
		"$@"
	)
	if __is_windows; then
		options+=(
			WINGET='XPFFH613W8V6LV'
		)
	else
		# improve performance for detectable utilities with conditional assets
		if setup-util "$@" --check "${app_options[@]}"; then
			__reconfigure
			return 0
		fi

		# setup
		options+=(
			CASK='obs'
			FLATPAK='com.obsproject.Studio'
		)
		local arch
		arch="$(__get_arch)"
		function __get_github_asset_url {
			local suffix="$1" regexp
			regexp="$(echo-escape-regexp -- "$suffix")$" || return $?
			github-download --dry --slug='obsproject/obs-studio' --latest --asset-regexp="$regexp" | echo-first-line || return $?
		}
		function __add_download_app_option {
			local suffix="$1" url
			url="$(__get_github_asset_url "$suffix")" || return $?
			options+=(
				DOWNLOAD="$url"
				DOWNLOAD_ARCHIVE_GLOB='*/OBS.app'
				DOWNLOAD_FILENAME='OBS.app'
			)
		}
		function __add_deb_option {
			local suffix="$1" url
			url="$(__get_github_asset_url "$suffix")" || return $?
			options+=(DEB="$url")
		}
		if __is_macos; then
			if [[ $arch == 'a64' ]]; then
				__add_download_app_option '-macOS-Apple.dmg' || :
			elif [[ $arch == 'x64' ]]; then
				__add_download_app_option '-macOS-Intel.dmg' || :
			fi
		elif [[ $arch == 'x64' ]] && is-system --ubuntu; then
			__add_deb_option ".$(get-system --codename)_amd64.deb" || :
		fi
	fi
	setup-util "${options[@]}"
	__reconfigure
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_obs "$@"
fi
