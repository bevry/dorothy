#!/usr/bin/env bash

function is_touchable_test() (
	source "$DOROTHY/sources/is-fs-tests.bash"
	echo-style --h1="TEST: $0"

	local root command='is-touchable'
	root="$(is_fs_tests__prep "$command")"

	eval-tester --name='no args' --status=22 --ignore-stderr -- \
		"$command" --

	# test no escalation
	local tuples=(
		22 ''

		0 "$root/missing-dir/missing-file"
		0 "$root/missing-file"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unaccessible-filled-dir/missing-dir/missing-file"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unaccessible-filled-dir/missing-file"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unexecutable-filled-dir/missing-dir/missing-file"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unexecutable-filled-dir/missing-file"
		"$(__status__root_or_nonroot 0 0)" "$root/targets/unreadable-filled-dir/missing-dir/missing-file"
		"$(__status__root_or_nonroot 0 0)" "$root/targets/unreadable-filled-dir/missing-file"
		"$(__status__root_or_nonroot 0 93)" "$root/targets/unwritable-filled-dir/missing-dir/missing-file"
		"$(__status__root_or_nonroot 0 93)" "$root/targets/unwritable-filled-dir/missing-file"

		0 "$root/targets/empty-dir"
		0 "$root/targets/empty-file"
		0 "$root/targets/filled-dir/empty-subfile"
		0 "$root/targets/filled-dir/filled-subdir"
		0 "$root/targets/filled-dir/filled-subdir/empty-subdir"
		0 "$root/targets/filled-dir/filled-subfile"
		0 "$root/targets/filled-file"
		# these aren't executable because they are only executable to root
		# so in which case a fs-own +x on these, results in
		# chmod: Unable to change file mode on /Users/balupton/.cache/dorothy/is-executable/targets/unaccessible-empty-file: Operation not permitted
		# in which we need to detect that, and elevate to root, so there needs to be a is-owned command too, which fs-own uses
		"$(__status__root_or_nonroot 0 93)" "$root/targets/unaccessible-empty-dir"
		"$(__status__root_or_nonroot 0 93)" "$root/targets/unaccessible-empty-file"
		"$(__status__root_or_nonroot 0 93)" "$root/targets/unaccessible-filled-dir"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unaccessible-filled-dir/empty-subfile"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unaccessible-filled-dir/filled-subdir"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unaccessible-filled-dir/filled-subdir/empty-subdir"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unaccessible-filled-dir/filled-subfile"
		"$(__status__root_or_nonroot 0 93)" "$root/targets/unaccessible-filled-file"
		0 "$root/targets/unexecutable-empty-dir"
		0 "$root/targets/unexecutable-empty-file"
		0 "$root/targets/unexecutable-filled-dir"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unexecutable-filled-dir/empty-subfile"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unexecutable-filled-dir/filled-subdir"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unexecutable-filled-dir/filled-subdir/empty-subdir"
		"$(__status__root_or_nonroot 0 13)" "$root/targets/unexecutable-filled-dir/filled-subfile"
		0 "$root/targets/unexecutable-filled-file"
		0 "$root/targets/unreadable-empty-dir"
		0 "$root/targets/unreadable-empty-file"
		0 "$root/targets/unreadable-filled-dir"
		0 "$root/targets/unreadable-filled-dir/empty-subfile"
		0 "$root/targets/unreadable-filled-dir/filled-subdir"
		0 "$root/targets/unreadable-filled-dir/filled-subdir/empty-subdir"
		0 "$root/targets/unreadable-filled-dir/filled-subfile"
		0 "$root/targets/unreadable-filled-file"
		"$(__status__root_or_nonroot 0 93)" "$root/targets/unwritable-empty-dir"
		"$(__status__root_or_nonroot 0 93)" "$root/targets/unwritable-empty-file"
		"$(__status__root_or_nonroot 0 93)" "$root/targets/unwritable-filled-dir"
		0 "$root/targets/unwritable-filled-dir/empty-subfile"
		0 "$root/targets/unwritable-filled-dir/filled-subdir"
		0 "$root/targets/unwritable-filled-dir/filled-subdir/empty-subdir"
		0 "$root/targets/unwritable-filled-dir/filled-subfile"
		"$(__status__root_or_nonroot 0 93)" "$root/targets/unwritable-filled-file"

		0 "$root/symlinks/empty-dir"
		0 "$root/symlinks/empty-file"
		0 "$root/symlinks/filled-dir--empty-subfile"
		0 "$root/symlinks/filled-dir--filled-subdir"
		0 "$root/symlinks/filled-dir--filled-subdir--empty-subdir"
		0 "$root/symlinks/filled-dir--filled-subfile"
		0 "$root/symlinks/filled-file"
		"$(__status__root_or_nonroot 0 93)" "$root/symlinks/unaccessible-empty-dir"
		"$(__status__root_or_nonroot 0 93)" "$root/symlinks/unaccessible-empty-file"
		"$(__status__root_or_nonroot 0 93)" "$root/symlinks/unaccessible-filled-dir"
		"$(__status__root_or_nonroot 0 13)" "$root/symlinks/unaccessible-filled-dir--empty-subfile"
		"$(__status__root_or_nonroot 0 13)" "$root/symlinks/unaccessible-filled-dir--filled-subdir"
		"$(__status__root_or_nonroot 0 13)" "$root/symlinks/unaccessible-filled-dir--filled-subdir--empty-subdir"
		"$(__status__root_or_nonroot 0 13)" "$root/symlinks/unaccessible-filled-dir--filled-subfile"
		"$(__status__root_or_nonroot 0 93)" "$root/symlinks/unaccessible-filled-file"
		0 "$root/symlinks/unexecutable-empty-dir"
		0 "$root/symlinks/unexecutable-empty-file"
		0 "$root/symlinks/unexecutable-filled-dir"
		"$(__status__root_or_nonroot 0 13)" "$root/symlinks/unexecutable-filled-dir--empty-subfile"
		"$(__status__root_or_nonroot 0 13)" "$root/symlinks/unexecutable-filled-dir--filled-subdir"
		"$(__status__root_or_nonroot 0 13)" "$root/symlinks/unexecutable-filled-dir--filled-subdir--empty-subdir"
		"$(__status__root_or_nonroot 0 13)" "$root/symlinks/unexecutable-filled-dir--filled-subfile"
		0 "$root/symlinks/unexecutable-filled-file"
		0 "$root/symlinks/unreadable-empty-dir"
		0 "$root/symlinks/unreadable-empty-file"
		0 "$root/symlinks/unreadable-filled-dir"
		0 "$root/symlinks/unreadable-filled-dir--empty-subfile"
		0 "$root/symlinks/unreadable-filled-dir--filled-subdir"
		0 "$root/symlinks/unreadable-filled-dir--filled-subdir--empty-subdir"
		0 "$root/symlinks/unreadable-filled-dir--filled-subfile"
		0 "$root/symlinks/unreadable-filled-file"
		"$(__status__root_or_nonroot 0 93)" "$root/symlinks/unwritable-empty-dir"
		"$(__status__root_or_nonroot 0 93)" "$root/symlinks/unwritable-empty-file"
		"$(__status__root_or_nonroot 0 93)" "$root/symlinks/unwritable-filled-dir"
		0 "$root/symlinks/unwritable-filled-dir--empty-subfile"
		0 "$root/symlinks/unwritable-filled-dir--filled-subdir"
		0 "$root/symlinks/unwritable-filled-dir--filled-subdir--empty-subdir"
		0 "$root/symlinks/unwritable-filled-dir--filled-subfile"
		"$(__status__root_or_nonroot 0 93)" "$root/symlinks/unwritable-filled-file"
	)
	is_fs_tests__tuples --group='test no escalation' "$command" --no-sudo -- "${tuples[@]}"

	# test default escalation
	tuples=(
		0 "$root/targets/unaccessible-filled-dir/empty-subfile"
		0 "$root/targets/unaccessible-filled-dir/filled-subdir"
		0 "$root/targets/unaccessible-filled-dir/filled-subdir/empty-subdir"
		0 "$root/targets/unaccessible-filled-dir/filled-subfile"
		0 "$root/targets/unexecutable-filled-dir/empty-subfile"
		0 "$root/targets/unexecutable-filled-dir/filled-subdir"
		0 "$root/targets/unexecutable-filled-dir/filled-subdir/empty-subdir"
		0 "$root/targets/unexecutable-filled-dir/filled-subfile"
		0 "$root/symlinks/unaccessible-filled-dir--empty-subfile"
		0 "$root/symlinks/unaccessible-filled-dir--filled-subdir"
		0 "$root/symlinks/unaccessible-filled-dir--filled-subdir--empty-subdir"
		0 "$root/symlinks/unaccessible-filled-dir--filled-subfile"
		0 "$root/symlinks/unexecutable-filled-dir--empty-subfile"
		0 "$root/symlinks/unexecutable-filled-dir--filled-subdir"
		0 "$root/symlinks/unexecutable-filled-dir--filled-subdir--empty-subdir"
		0 "$root/symlinks/unexecutable-filled-dir--filled-subfile"
	)
	is_fs_tests__tuples --group='test default escalation' "$command" -- "${tuples[@]}"

	# test with escalation
	tuples=(
		0 "$root/targets/unaccessible-filled-dir/empty-subfile"
		0 "$root/targets/unaccessible-filled-dir/filled-subdir"
		0 "$root/targets/unaccessible-filled-dir/filled-subdir/empty-subdir"
		0 "$root/targets/unaccessible-filled-dir/filled-subfile"
		0 "$root/targets/unexecutable-filled-dir/empty-subfile"
		0 "$root/targets/unexecutable-filled-dir/filled-subdir"
		0 "$root/targets/unexecutable-filled-dir/filled-subdir/empty-subdir"
		0 "$root/targets/unexecutable-filled-dir/filled-subfile"
		0 "$root/symlinks/unaccessible-filled-dir--empty-subfile"
		0 "$root/symlinks/unaccessible-filled-dir--filled-subdir"
		0 "$root/symlinks/unaccessible-filled-dir--filled-subdir--empty-subdir"
		0 "$root/symlinks/unaccessible-filled-dir--filled-subfile"
		0 "$root/symlinks/unexecutable-filled-dir--empty-subfile"
		0 "$root/symlinks/unexecutable-filled-dir--filled-subdir"
		0 "$root/symlinks/unexecutable-filled-dir--filled-subdir--empty-subdir"
		0 "$root/symlinks/unexecutable-filled-dir--filled-subfile"
	)
	is_fs_tests__tuples --group='test with escalation' "$command" --elevate -- "${tuples[@]}"

	# break the symlinks
	eval-helper --elevate -- rm -rf -- "$root/targets"
	tuples=(
		9 "$root/symlinks/empty-dir"
		9 "$root/symlinks/empty-file"
		9 "$root/symlinks/filled-dir--empty-subfile"
		9 "$root/symlinks/filled-dir--filled-subdir"
		9 "$root/symlinks/filled-dir--filled-subdir--empty-subdir"
		9 "$root/symlinks/filled-dir--filled-subfile"
		9 "$root/symlinks/filled-file"
		9 "$root/symlinks/unaccessible-empty-dir"
		9 "$root/symlinks/unaccessible-empty-file"
		9 "$root/symlinks/unaccessible-filled-dir"
		9 "$root/symlinks/unaccessible-filled-dir--empty-subfile"
		9 "$root/symlinks/unaccessible-filled-dir--filled-subdir"
		9 "$root/symlinks/unaccessible-filled-dir--filled-subdir--empty-subdir"
		9 "$root/symlinks/unaccessible-filled-dir--filled-subfile"
		9 "$root/symlinks/unaccessible-filled-file"
		9 "$root/symlinks/unexecutable-empty-dir"
		9 "$root/symlinks/unexecutable-empty-file"
		9 "$root/symlinks/unexecutable-filled-dir"
		9 "$root/symlinks/unexecutable-filled-dir--empty-subfile"
		9 "$root/symlinks/unexecutable-filled-dir--filled-subdir"
		9 "$root/symlinks/unexecutable-filled-dir--filled-subdir--empty-subdir"
		9 "$root/symlinks/unexecutable-filled-dir--filled-subfile"
		9 "$root/symlinks/unexecutable-filled-file"
		9 "$root/symlinks/unreadable-empty-dir"
		9 "$root/symlinks/unreadable-empty-file"
		9 "$root/symlinks/unreadable-filled-dir"
		9 "$root/symlinks/unreadable-filled-dir--empty-subfile"
		9 "$root/symlinks/unreadable-filled-dir--filled-subdir"
		9 "$root/symlinks/unreadable-filled-dir--filled-subdir--empty-subdir"
		9 "$root/symlinks/unreadable-filled-dir--filled-subfile"
		9 "$root/symlinks/unreadable-filled-file"
		9 "$root/symlinks/unwritable-empty-dir"
		9 "$root/symlinks/unwritable-empty-file"
		9 "$root/symlinks/unwritable-filled-dir"
		9 "$root/symlinks/unwritable-filled-dir--empty-subfile"
		9 "$root/symlinks/unwritable-filled-dir--filled-subdir"
		9 "$root/symlinks/unwritable-filled-dir--filled-subdir--empty-subdir"
		9 "$root/symlinks/unwritable-filled-dir--filled-subfile"
		9 "$root/symlinks/unwritable-filled-file"
	)
	is_fs_tests__tuples --group='test broken symlinks' "$command" -- "${tuples[@]}"

	echo-style --g1="TEST: $0"
	return 0
)
function is_touchable() (
	source "$DOROTHY/sources/is-fs.bash"

	# =====================================
	# Arguments

	function help {
		cat <<-EOF >&2
			ABOUT:
			Check if all <path>s are touchable (able to be created and written to).

			USAGE:
			is-touchable [...options] [--] ...<path>

			OPTIONS:
			$(is_fs_options '13')

			RETURNS:
			[0] if all <path>s are touchable
			[9] if a <path> was a broken symlink
			[13] if a <path> was not accessible
			[22] if empty arguments were provided
			[93] if a <path> was was not touchable

			QUIRKS:
			Files in unreadable directories can still be created, written, and read.
		EOF
		if [[ $# -ne 0 ]]; then
			echo-error "$@"
		fi
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	is_fs_args "$@"

	# invoke
	is_fs_invoke 'is-touchable.bash' '13'

	# if verbose and failure, output contextual failure
	if [[ $option_quiet == 'no' && $fs_status -ne 0 ]]; then
		case "$fs_status" in
		9) echo-style --stderr --error1='The path was a broken symlink: ' --code-error1="$fs_failed_path" ;;
		13) echo-style --stderr --error1='The path was not accessible: ' --code-error1="$fs_failed_path" ;;
		22) echo-style --stderr --error1='The path was not a valid argument: ' --code-error1="$fs_failed_path" ;;
		93) echo-style --stderr --error1='The path was was not touchable: ' --code-error1="$fs_failed_path" ;;
		*) is_fs_unknown_error ;;
		esac
	fi

	# done
	return "$fs_status"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		is_touchable_test
	else
		is_touchable "$@"
	fi
fi
