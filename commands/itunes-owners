#!/usr/bin/env bash
# dependencies: ffmpeg, php, pv

function itunes-owners() (
	source "$DOROTHY/sources/strict.bash"

	# =====================================
	# Arguments

	function help {
		cat <<-EOF >/dev/stderr
			ABOUT:
			Outputs ownership data for your iTunes media library.

			USAGE:
			itunes-owners
		EOF
		if test "$#" -ne 0; then
			echo-error "$@"
		fi
		return 22 # Invalid argument
	}

	# process
	local item
	while test "$#" -ne 0; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--'*) help "An unrecognised flag was provided: $item" ;;
		*) help "An unrecognised argument was provided: $item" ;;
		esac
	done

	# =====================================
	# Dependencies

	source "$DOROTHY/sources/ripgrep.bash"
	setup-util-pv --quiet

	# =====================================
	# Action

	local song_list owner_list missing_list database
	song_list="$(fs-temp --directory='itunes-owners' --file='songs.txt' --touch)"
	owner_list="$(fs-temp --directory='itunes-owners' --file='owner.txt' --touch)"
	missing_list="$(fs-temp --directory='itunes-owners' --file='missing.txt' --touch)"
	database="$HOME/Music/iTunes/iTunes Music Library.xml"
	echo-style --h2="Reading $database"

	# fetch songs
	local song_count=0
	function fetch_songs {
		echo-style --h2="Fetching songs to $song_list"
		rg -o '<string>file://(.+)</string>' --replace '$1' <"$database" |
			echo-decode-url |
			echo-decode-html >"$song_list"
		song_count="$(wc -l <"$song_list" | xargs)"
		echo-style --g2="...found $song_count media files."
	}
	fetch_songs # @todo use eval-helper

	# fetch owners
	function fetch_owners {
		local song owner
		echo-style --h2="Fetching owners to $owner_list"
		while read -r song; do
			# echo -n X # why? perhaps for pv?

			# check
			if test ! -f "$song"; then
				echo-style "$song" ' ' --notice='is missing'
				echo "$song" >>"$missing_list"
				continue
			fi

			# fetch owner
			owner="$(ffprobe -i "$song" |& rg -o 'account_id\s*:\s*(.+)' --replace '$1' || :)"

			# write
			if test -n "$owner"; then
				echo-style "$song" ' ' --green='owner is' ' ' --bold="$owner"
				printf '%s\t%s' "$owner" "$song" >>"$owner_list"
				# else
				# echo-style --notice='ðŸ‘† owner is missing'
			fi
		done <"$song_list" # | pv -s "$song_count" - >/dev/null
	}
	fetch_owners

	# extract
	local owners owner_count owned_count
	owners="$(cut -f1 -s <"$owner_list" | sort | uniq)"
	owner_count="$(echo "$owners" | wc -l | xargs)"
	owned_count="$(wc -l <"$owner_list" | xargs)"

	echo-style --h2="$owner_count UNIQUE OWNERS:"
	echo "$owners"
	echo

	echo-style --h2="$owned_count OWNED MEDIA:"
	sort <"$owner_list" | column -t -s $'\t'
	echo

	echo-style --h2="$(wc -l <"$missing_list" | xargs) MISSING MEDIA:"
	sort <"$missing_list"
	echo
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	itunes-owners "$@"
fi
