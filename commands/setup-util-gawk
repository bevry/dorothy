#!/usr/bin/env bash

# awk, not gawk:
# https://repology.org/project/awk/versions
# https://community.chocolatey.org/packages/awk
# https://en.wikipedia.org/wiki/AWK
# https://github.com/onetrueawk/awk

# gawk:
# https://repology.org/project/gawk/versions
# https://stackoverflow.com/q/24332942/130638 <-- macos implementation diverges, so like other GNU utils, best to ensure GNU version is uawk
# https://www.gnu.org/software/gawk/

# nawk is the one bundled in macos
# mawk is the one bundled in ubuntu

function setup_util_gawk() (
	source "$DOROTHY/sources/bash.bash"

	# remove deprecated gawk => awk bash link, as echo-gnu-command is a better solution
	if test -e "$XDG_BIN_HOME/gawk" && grep --quiet --fixed-strings --regexp='bash' <"$XDG_BIN_HOME/gawk"; then
		fs-rm --no-confirm -- "$XDG_BIN_HOME/gawk"
	fi

	# enable DOWNLOAD_BUILD_INSTALL
	source "$(type -P setup-util)"

	# setup
	local options=(
		--name='GNU awk utility'
		--cli='gawk'
		"$@"
		APK='gawk' # ALPINE
		APT='gawk' # UBUNTU
		AUR='gawk' # ARCH
		BREW='gawk'
		CHOCOLATEY='gawk' # WINDOWS
		RPM='gawk'        # FEDORA
		SCOOP='gawk'      # WINDOWS
		ZYPPER='gawk'     # SUSE
	)
	function do_install {
		# dependencies
		setup-util-devel --quiet
		source "$DOROTHY/sources/environment.sh"

		# build
		./configure
		make install
	}
	function do_uninstall {
		# dependencies
		setup-util-devel --quiet
		source "$DOROTHY/sources/environment.sh"

		# build
		./configure
		make uninstall
	}
	local arch macos_release bottle_url=''
	arch="$(get-arch)"
	if is-mac; then
		# fetch the bottle urls via: brew info --json gawk | jq -r ".[].bottle.stable.files"
		macos_release="$(get-macos-release-name)"
		if test "$arch" = 'a64'; then
			if test "$macos_release" = 'sonoma'; then
				bottle_url='https://ghcr.io/v2/homebrew/core/gawk/blobs/sha256:73d743d915e4c9841f9bdc289710ef4ea071ccf1f026542f1fcc8ba4a870e8f5'
			elif test "$macos_release" = 'ventura'; then
				bottle_url='https://ghcr.io/v2/homebrew/core/gawk/blobs/sha256:36265210141086740f625d2e672b6275a2247de4de1f1df9747ed51b409a5e24'
			elif test "$macos_release" = 'monterey'; then
				bottle_url='https://ghcr.io/v2/homebrew/core/gawk/blobs/sha256:24956ab7119678bf5168a66ace1b5e735cede929084ff756da14ab74a1c8f63a'
			fi
		elif test "$arch" = 'x64'; then
			if test "$macos_release" = 'sonoma'; then
				bottle_url='"https://ghcr.io/v2/homebrew/core/gawk/blobs/sha256:786aa0d52925e6816ece520d4ca45778862775249186e9bea85022dc96653c38'
			elif test "$macos_release" = 'ventura'; then
				bottle_url='https://ghcr.io/v2/homebrew/core/gawk/blobs/sha256:30185c073065bff4138f1512603315c789babcb83a3253a8155b670e4baa32c1'
			elif test "$macos_release" = 'monterey'; then
				bottle_url='https://ghcr.io/v2/homebrew/core/gawk/blobs/sha256:ee33b62eba04ca68cc6346b7fa51466696b9380f67e2a2bedaa367a1a154c9a4'
			fi
		fi
		# add the bottle url as an option
		if test -n "$bottle_url" && fetch --bearer-token='QQ==' --ok "$bottle_url"; then
			options+=(
				DOWNLOAD="$bottle_url"
				DOWNLOAD_FILENAME='gawk'
				DOWNLOAD_BEARER_TOKEN='QQ=='
				DOWNLOAD_ARCHIVE_FORMAT='tar'
				DOWNLOAD_ARCHIVE_GLOB='gawk/*/bin/gawk'
			)
		fi
	fi
	# DOWNLOAD source url if no bottle url
	if test -z "$bottle_url"; then
		options+=(
			# https://ftp.gnu.org/gnu/gawk/?C=M;O=D
			DOWNLOAD="https://ftp.gnu.org/gnu/gawk/gawk-5.3.0.tar.xz"
			DOWNLOAD_ARCHIVE_FORMAT='tar'
			DOWNLOAD_ARCHIVE_GLOB='gawk-*/*'
			DOWNLOAD_TARGET_PATH='/usr/local/bin/gawk'
			DOWNLOAD_BUILD_INSTALL='do_install'
			DOWNLOAD_BUILD_UNINSTALL='do_uninstall'
		)
	fi
	setup_util "${options[@]}"
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	setup_util_gawk "$@"
fi
