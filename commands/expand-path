#!/usr/bin/env bash

# escape-spaces converts the intuitive
# expand-path -- '/Applications/Visual *'
# into the correct
# expand-path -- '/Applications/Visual\\ *'

function expand_path_test() (
	source "$DOROTHY/sources/bash.bash"
	source "$(type -P eval-tester)"
	eval_tester --ignore-stderr --status=22 -- expand-path --help

	eval_tester --name='test non-existent path without glob' --stdout='' -- \
		expand-path -- '/i/do/not exist'

	eval_tester --name='test non-existent path with glob' --stdout='' -- \
		expand-path -- '/i/do/not exist*'

	eval_tester --name='test existent path' --stdout="$DOROTHY/commands/expand-path" -- \
		expand-path -- "$DOROTHY/*/expand-path"

	return 0
)
function expand_path() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Get the size of a path in bytes.

			USAGE:
			\`expand-path [--] ...<path>\`
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_paths=()
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--path='*) option_paths+=("${item#*=}") ;;
		'--')
			option_paths+=("$@")
			shift $#
			break
			;;
		'--'*) help 'An unrecognised flag was provided: ' --variable-value={item} ;;
		*) option_paths+=("$item") ;;
		esac
	done

	# check
	if [[ ${#option_paths[@]} -eq 0 ]]; then
		help --help='No <path>s provided.'
	fi

	# =====================================
	# Action

	local expanded_paths=()

	# using zsh then bash, works around macos which has old bash, but new zsh
	# so this is needed so setup-paths-commands can do its thing
	if [[ $BASH_CAN_GLOBSTAR == 'yes' ]] || ! is-globstar -- "$*"; then
		for path in "${option_paths[@]}"; do
			__split --target={expanded_paths} --append --no-zero-length --invoke=try -- \
				eval __print_lines "$(echo-escape-spaces -- "$path")"
		done
	elif __command_exists -- zsh; then
		__split --target={expanded_paths} --append --no-zero-length --invoke=try -- \
			expand-path.zsh -- "${option_paths[@]}"
	else
		__print_error 'Could not find a suitable shell to expand paths with.'
		return 1
	fi

	# now, only output paths that exist
	if [[ "${#expanded_paths[@]}" -ne 0 ]]; then
		is-present --echo --optional -- "${expanded_paths[@]}"
	fi
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		expand_path_test
	else
		expand_path "$@"
	fi
fi
