#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# options
action="$(choose-option --question='What action would you like to do?' --filter="${1-}" -- create open)"
if test "$action" = 'open'; then
	option_path="$(ask --question='Enter its path.')"

	echo
	echo 'Compacting...'
	(hdiutil compact "$option_path" && echo 'Compacted.') || echo 'Compact failed, not an issue, continuing.'

	echo
	echo 'Mounting...'
	hdiutil mount "$option_path"
	echo 'Mounted.'
else
	option_name="$(ask --question='Enter its name.')"
	option_size="$(ask --question='Enter its maximum size. E.g. MAXSIZE|100g|1t')"
	option_type="$(choose-option --question='Enter its type.' -- sparseimage sparsebundle)"

	vol=$(basename "$option_name")
	version=$(sw_vers -productVersion | awk -F '.' '{print $2}')
	create_args=(
		'-encryption' 'AES-256'
		'-size' "$option_size"
		'-volname' "$vol"
	)

	if test "$version" -ge "13"; then
		create_args+=('-fs' 'APFS')
	else
		create_args+=('-fs' 'Journaled HFS+')
	fi
	if test "$option_type" = 'sparseimage'; then
		create_args+=('-type' 'SPARSE')
		filename="${option_name}.sparseimage"
	else
		create_args+=('-type' 'SPARSEBUNDLE')
		filename="${option_name}.sparsebundle"
	fi

	echo
	echo 'Creating...'
	hdiutil create "${create_args[@]}" "$option_name"
	echo 'Created.'

	echo
	echo 'Mounting...'
	hdiutil mount "$filename"
	echo 'Mounted.'
fi
