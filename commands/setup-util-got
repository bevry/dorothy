#!/usr/bin/env bash

# https://github.com/melbahja/got

# https://github.com/melbahja/got/releases
# got_0.7.0_Darwin_amd64.tar.gz
# got_0.7.0_Darwin_arm64.tar.gz
# got_0.7.0_Freebsd_32bit.tar.gz
# got_0.7.0_Freebsd_amd64.tar.gz
# got_0.7.0_Freebsd_arm64.tar.gz
# got_0.7.0_Freebsd_armv6.tar.gz
# got_0.7.0_Linux_32bit.tar.gz
# got_0.7.0_Linux_amd64.tar.gz

# Unmaintained. Last release: 2022-08-01
# https://github.com/melbahja/got
# got [global options] command [command options] [arguments...]
# --dir directory, -d directory    Save downloaded file to a directory.
# --header value, -H value         Set these HTTP-Headers on the requests. The format has to be: -H "Key: Value"
# --output path, -o path           Download path, if dir passed, the path will be `dir + output`.

function setup_util_got() (
	source "$DOROTHY/sources/bash.bash"

	# improve performance for detectable utilities with conditional assets
	if setup-util --check --cli=got "$@"; then
		return 0
	fi

	# setup
	local arch options=(
		--cli=got
		"$@"
		GO='github.com/melbahja/got' # /cmd/got
	)
	function __get_github_asset_url {
		local suffix="$1" regexp
		regexp="$(echo-escape-regexp -- "$suffix")$" || return $?
		github-download --dry --slug='melbahja/got' --latest --asset-regexp="$regexp" | echo-first-line || return $?
	}
	function __add_download_option {
		local suffix="$1" url
		url="$(__get_github_asset_url "$suffix")" || return $?
		options+=(
			DOWNLOAD="$url"
			DOWNLOAD_ARCHIVE_GLOB='got'
		)
	}
	arch="$(__get_arch)"
	if __is_macos; then
		if [[ $arch == 'a64' ]]; then
			__add_download_option '_Darwin_arm64.tar.gz' || :
		elif [[ $arch == 'x64' ]]; then
			__add_download_option '_Darwin_amd64.tar.gz' || :
		fi
	elif __is_linux; then
		if [[ $arch == 'x64' ]]; then
			__add_download_option '_Linux_amd64.tar.gz' || :
		elif [[ $arch == 'x32' ]]; then
			__add_download_option '_Linux_32bit.tar.gz' || :
		fi
	fi
	setup-util "${options[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_got "$@"
fi
