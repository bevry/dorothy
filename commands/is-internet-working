#!/usr/bin/env bash

# fresh macos without brew has no ping
function is_internet_working() (
	source "$DOROTHY/sources/bash.bash"
	# trunk-ignore(shellcheck/SC2034)
	local all_tools=(ping whois fetch)

	# help
	function __help {
		cat <<-EOF >&2 || return
			ABOUT:
			Test if the internet is working.

			USAGE:
			is-internet-working [...options]

			OPTIONS:
			<hostname>
			    The hostname to test if the internet is working.
			    Defaults to: $(__print_style --code='cloudflare.com')

			--tool=<tool:$(__join --source={all_tools} --delimiter='|')|?>
			    The tool to use. Use [?] to prompt. Default is the first available tool.

			--quiet
			    Toggle verbosity by having this empty (the default), enabled (quiet mode), and disabled (verbose mode).

			RETURNS:
			[0] if the internet is working.
			[1] if the internet is not working.
		EOF
		if [[ $# -ne 0 ]]; then
			__print_error "$@" || return
		fi
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_url='' option_quiet='' option_tool=''
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') __help || return ;;
		'--tool='*) option_tool="${item#*=}" ;;
		'--no-verbose'* | '--verbose'*) __flag --source={item} --target={option_quiet} --non-affirmative --coerce || return ;;
		'--no-quiet'* | '--quiet'*) __flag --source={item} --target={option_quiet} --affirmative --coerce || return ;;
		'--'*) __help 'An unrecognised flag was provided: ' --variable-value={item} || return ;;
		*)
			if [[ -z $option_url ]]; then
				option_url="$item"
			else
				__help 'An unrecognised argument was provided: ' --variable-value={item} || return
			fi
			;;
		esac
	done

	# ensure url
	if [[ -z $option_url ]]; then
		option_url='cloudflare.com'
	fi

	# dependencies
	__tool --tool={option_tool} --tools={all_tools} --help={__help} || return

	# action

	local cmd
	if [[ $option_tool == 'ping' ]]; then
		cmd=(ping -c 1 "$option_url")
	elif [[ $option_tool == 'whois' ]]; then
		cmd=(whois "$option_url")
	elif [[ $option_tool == 'fetch' ]]; then
		cmd=(fetch --ok "$option_url")
	else
		return 19 # ENODEV 19 Operation not supported by device
	fi
	eval-helper --quiet="$option_quiet" --wrap \
		--pending="$(__print_style --notice2='Checking your internet connection...')" \
		--success="$(__print_style --good2='Internet is connected.')" \
		--failure="$(__print_style --error1='Internet is not working. If it is a DNS issue, then ' --code-error1='setup-dns' --error1=' may help.')" -- \
		"${cmd[@]}" || return
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	is_internet_working "$@"
fi
