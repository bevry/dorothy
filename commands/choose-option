#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"
source "$DOROTHY/sources/splitlines.bash"

# validate
if test "${3-}" != '--'; then
	stderr echo 'USAGE: choose-option <question> <selection> -- <option...>'
	exit 1
fi

# extract
question="${1-}"
selection="${2-}"

# extract jumbled options
if test "$#" -eq 4; then
	mapfile -t options <<<"$4"
else
	options=("${@:4}")
fi

# sanity check
if is-array-empty-or-partial "${options[@]}"; then
	stderr echo "no options or an invalid option was provided:"
	stderr echo-lines-verbose "${options[@]}"
	exit 1
fi

# filter
if test -n "$selection"; then
	filtered=()
	for option in "${options[@]}"; do
		if [[ "${option,,}" = *"${selection,,}"* ]]; then
			filtered+=("${option}")
		fi
	done

	# sanity check after filtering
	if is-array-empty "${filtered[@]}"; then
		stderr echo "no options matched your selection, available options are:"
		stderr echo-lines "${options[@]}"
		stderr echo
		stderr echo 'asking you again out of the available options...'
		stderr echo
		choose-option "$1" '' -- "${options[@]}"
		exit "$?"
	fi

	# apply
	options=("${filtered[@]}")
fi


# if we have one option, then use that
if is-array-count 1 "${options[@]}"; then
	echo "${options[0]}"
	exit
fi

# let the user pick
stderr echo "$question"
choose "${options[@]}"
