#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# =====================================
# Configuration

source "$DOROTHY/sources/config.sh"
load_dorothy_config 'setup.bash'
# ^ provides: CARGO_INSTALL/RUST_INSTALL

# =====================================
# Start

echo
echo-color --oh1 --h1='Setup Rust' --ch1

# clean
if is-brew && test -n "$(brew-installed -- rustup rust || :)"; then
	if confirm-positive 'Rust is currently installed via homebrew. Confirm that you want Dorothy to use rustup to manage rust instead. Rustup is the official and only endorsed method of managing rust.'; then
		brew uninstall -f rustup rust
	fi
fi

echo-color --oh2 --h2="Install build dependencies" --ch2
setup-util-build
echo-color --og2 --g2="Install build dependencies" --cg2

echo-color --oh2 --h2="Install rustup" --ch2
if command-exists rustup; then
	rustup update
else
	# https://rust-lang.github.io/rustup/installation/other.html
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --no-modify-path
fi
echo-color --og2 --g2="Install rustup" --cg2

# install cargos
function install_each_cargo_crate() {
	echo-color --oh2 --h2="Install $# rust crates" --ch2
	log-performance
	for line in "$@"; do
		env NAME="cargo:$line" CARGO="$line" setup-util cargo
	done
	echo-color --og2 --g2="Install $# rust crates" --cg2
}
if test -v 'CARGO_INSTALL'; then
	install_each_cargo_crate "${CARGO_INSTALL[@]}"
fi
if test -v 'RUST_INSTALL'; then
	install_each_cargo_crate "${RUST_INSTALL[@]}"
fi

# =====================================
# Done

echo-color --og1 --g1='Setup Rust' --cg1
