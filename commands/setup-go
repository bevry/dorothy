#!/usr/bin/env bash
# shellcheck disable=SC2164,SC1091
source "$DOROTHY/sources/strict.bash"
source "$(which eval-collapse)"

# =====================================
# Configuration

source "$DOROTHY/sources/config.sh"
load_dorothy_config 'setup.bash'
if test ! -v 'GO_INSTALL'; then
	GO_INSTALL=()
fi

# =====================================
# Start

echo-segment --h1='Setup Go'

# =====================================
# Install

setup-util-go
source "$DOROTHY/sources/environment.sh"

# =====================================
# Adjustments

if confirm-negative "Do you also want to install go linting packages? This is desired if you plan to code with go."; then
	# https://github.com/golang/vscode-go/blob/master/docs/tools.md
	# https://github.com/golang/tools/blob/master/gopls/README.md
	GO_INSTALL+=(
		golang.org/x/tools/gopls
		github.com/go-delve/delve/cmd/dlv
		# github.com/uudashr/gopkgs/cmd/gopkgs
		github.com/ramya-rao-a/go-outline
		# github.com/haya14busa/goplay/cmd/goplay
		github.com/fatih/gomodifytags
		github.com/josharian/impl
		github.com/cweill/gotests/...
	)
fi

# =====================================
# Packages

function go_install() {
	echo-segment --h2="Install $# go packages"
	for item in "$@"; do
		env NAME="go:$item" OPTIONAL='yes' GO="$item" setup-util go
	done
	echo-segment --g2="Install $# go packages"
}
go_install "${GO_INSTALL[@]}"

# =====================================
# Linting

if command-exists gometalinter; then
	echo-segment --h2="complete [gometalinter] setup"
	eval_collapse --- gometalinter --install || :
	echo-segment --g2="complete [gometalinter] setup"
fi

# =====================================
# Done

echo-segment --g1='Setup Go'
