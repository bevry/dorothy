#!/usr/bin/env bash

# https://flathub.org/en/apps/com.plexamp.Plexamp

# https://plexampproject.com/download#linux
# https://www.plex.tv/media-server-downloads/?cat=computer&plat=linux

# https://www.plex.tv/wp-json/plex/v1/downloads/plexamp
# https://plexamp.plex.tv/plexamp.plex.tv/desktop/Plexamp-4.13.0.AppImage
# https://plexamp.plex.tv/plexamp.plex.tv/desktop/Plexamp-4.12.4-arm64.dmg
# https://plexamp.plex.tv/plexamp.plex.tv/desktop/Plexamp-4.12.4-x64.dmg
# https://plexamp.plex.tv/plexamp.plex.tv/desktop/Plexamp%20Setup%204.12.3.exe
# https://plexamp.plex.tv/headless/Plexamp-Linux-headless-v4.12.4.tar.bz2 (headless)

# https://repology.org/project/plexamp/versions

function setup_util_plexamp() (
	source "$DOROTHY/sources/bash.bash"

	# improve performance for detectable utilities with conditional assets
	if setup-util "$@" --check --app='Plexamp'; then
		return 0
	fi

	# setup
	local options=(
		--app='Plexamp'
		"$@"
	)
	if __is_windows; then
		# no scoop
		options+=(
			WINGET='Plex.Plexamp'
		)
	else
		options+=(
			AUR='plexamp-bin' # also available: plexamp-appimage
			CASK='plexamp'
			FLATPAK='com.plexamp.Plexamp'
			NIX='plexamp'
		)
		local arch platform urls=() url
		if __is_macos; then
			platform='macos'
		elif __is_linux; then
			platform='linux'
		else
			platform='unexpected'
		fi
		arch="$(__get_arch)"
		function __add_download_app_option {
			local url="$1"
			options+=(
				DOWNLOAD="$url"
				DOWNLOAD_ARCHIVE_GLOB='*/Plexamp.app'
				DOWNLOAD_FILENAME='Plexamp.app'
			)
		}
		function __add_download_appimage_option {
			local url="$1"
			options+=(
				DOWNLOAD="$url"
				DOWNLOAD_FILENAME='Plexamp.appimage'
			)
		}
		function __fetch_urls {
			fetch 'https://www.plex.tv/wp-json/plex/v1/downloads/plexamp' | echo-regexp -igon --regexp='url": *"([^"]+)' --replace='$1' | echo-regexp -g --regexp='\\/' --replace='/' || return $?
		}
		__split --target={urls} --no-zero-length --invoke -- \
			__fetch_urls
		for url in "${urls[@]}"; do
			case "$url" in
			*'-x64.dmg')
				# macOS x86
				if [[ $platform == 'macos' && $arch == 'x86' ]]; then
					__add_download_app_option "$url"
					break
				fi
				;;
			*'-arm64.dmg')
				# macOS a64
				if [[ $platform == 'macos' && $arch == 'a64' ]]; then
					__add_download_app_option "$url"
					break
				fi
				;;
			*'.AppImage')
				# Linux AppImage
				if [[ $platform == 'linux' ]]; then
					__add_download_app_option "$url"
				fi
				;;
			esac
		done
	fi
	setup-util "${options[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_plexamp "$@"
fi
