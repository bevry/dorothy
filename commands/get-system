#!/usr/bin/env bash

function get_system() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Get details of the system.
			Companion to \`is-system\`.

			USAGE:
			\`get-system [...options]\`

			OPTIONS:
			--code | --codename | --code-name | --release-name | --name
			    Get only the lowercased release code name, e.g. \`jammy\`, \`noble\`, \`questing\`

			--version | --version-number | --number | --release-number
			    Get only the release version number, e.g. \`22.04\`, \`24.04\`, \`25.10\`

			--distro | --distribution
			    Get only the lowercased distribution name, e.g. \`ubuntu\`

			--long | --description
			    Get only the long description, e.g. \`Ubuntu 22.04.2 LTS\`
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	function __reply_with_trailing_newline {
		REPLY=''
		__read_whole || return $?
		__replace --source={REPLY} --target={REPLY} --optional --leading-whitespace --trailing-whitespace || return $?
		REPLY+=$'\n'
	}
	function __ensure_trailing_newline {
		local REPLY
		__reply_with_trailing_newline || return $?
		__print_string "$REPLY" || return $?
	}
	function __lowercase_stdin {
		local REPLY
		__read_whole || return $?
		__get_lowercase_string "$REPLY" || return $?
	}
	function __via_lsb {
		local field="$1"
		lsb_release "--${field}" --short 2>/dev/null | __ensure_trailing_newline || return $?
	}
	function __via_regexp {
		local field="$1"
		echo-regexp -fiomn --regexp="^${field}=\"?(.+?)\"?$" --replace='$1' </etc/os-release 2>/dev/null
	}
	function __via_config_helper {
		local field="$1"
		config-helper --file='/etc/os-release' -- --field="${field}" 2>/dev/null | __ensure_trailing_newline || return $?
	}
	function __get_code {
		# __via_lsb 'codename' | __lowercase_stdin || return $? # 0.034s
		# __via_config_helper 'VERSION_CODENAME' | __lowercase_stdin || return $? # 1.646s
		__via_regexp 'VERSION_CODENAME' | __lowercase_stdin || return $? # 0.115s
	}
	function __get_version {
		# __via_lsb 'release' | __lowercase_stdin || return
		# __via_config_helper 'VERSION_ID' | __lowercase_stdin || return
		__via_regexp 'VERSION_ID' | __lowercase_stdin || return $?
	}
	function __get_distro {
		# __via_lsb 'id' | __lowercase_stdin || return
		# __via_config_helper 'ID' | __lowercase_stdin || return
		__via_regexp 'ID' | __lowercase_stdin || return $?
	}
	function __get_long {
		# __via_lsb 'description' || return
		# __via_config_helper 'PRETTY_NAME' || return
		__via_regexp 'PRETTY_NAME' || return $?
	}
	function __get_all {
		# lsb_release --all 2>/dev/null || return $?
		cat /etc/os-release || return $?
	}

	# process
	local item had_action='no'
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--code' | '--codename' | '--code-name' | '--release-name' | '--name')
			__get_code
			had_action='yes'
			;;
		'--version' | '--version-number' | '--number' | '--release-number')
			__get_version
			had_action='yes'
			;;
		'--distro' | '--distribution')
			__get_distro
			had_action='yes'
			;;
		'--long' | '--description')
			__get_long
			had_action='yes'
			;;
		'--all')
			__get_all
			had_action='yes'
			;;
		'--'*) help 'An unrecognised flag was provided: ' --variable-value={item} ;;
		*) help 'An unrecognised argument was provided: ' --variable-value={item} ;;
		esac
	done

	# leftover action
	if [[ $had_action == 'no' ]]; then
		__get_all
	fi
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	get_system "$@"
fi
