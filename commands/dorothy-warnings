#!/usr/bin/env bash

function dorothy_warnings() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function help {
		cat <<-EOF >&2
			ABOUT:
			Interact with the Dorothy warnings file.

			USAGE:
			dorothy-warnings <action>

			ACTIONS:
			--free | free
				Returns [0] if there are no warnings, [1] if there are warnings.

			--has | has
				Returns [0] if there are warnings, [1] if there are no warnings.

			--clear | clear | --remove | remove | --reset | reset
			    Clear the warnings file.
			    Returns [0] always.

			--warn | warn
			    Output the warnings file with appropriate messaging, only if there are new warnings from last time.
			    Returns [0] always.

			--list | list
			    Output the warnings file with appropriate messaging.
			    Returns [0] always.
			    This is the default action.

			--add ...<message> | add ...<message>
			    Add a warning message to the warnings file.
			    Returns [0] always.
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item action='list' option_args=()
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--free' | 'free') action='free' ;;
		'--has' | 'has' | '--check' | 'check' | '--exists' | 'exists') action='has' ;;
		'--clear' | 'clear' | '--remove' | 'remove' | '--reset' | 'reset') action='clear' ;;
		'--warn' | 'warn') action='warn' ;;
		'--list' | 'list') action='list' ;;
		'--add' | 'add')
			action='add'
			option_args+=("$@")
			shift $#
			;;
		'--'*) help "An unrecognised flag was provided: $item" ;;
		*) help "An unrecognised argument was provided: $item" ;;
		esac
	done

	# =====================================
	# Act

	local file="$DOROTHY/state/warnings.txt"

	function __free {
		if is-empty-file --verbose -- "$file"; then
			return 0 # we are free from warning
		else
			return 1 # there are warnings
		fi
	}
	function __has {
		if is-empty-file --verbose -- "$file"; then
			return 1 # there are no warnings
		else
			return 0 # there are warnings
		fi
	}
	function __clear {
		: >"$file" || return
	}
	function __list {
		echo-style --stderr \
			--notice1='Dorothy has encountered warnings:' --newline \
			--="$(echo-file -- "$file")" --newline \
			--notice1='For help with these warnings, see: ' --code-notice1='https://github.com/bevry/dorothy/issues/185' --newline \
			--notice1='To clear these warnings, run: ' --code-notice1='dorothy-warnings clear' || return
	}
	function __warn {
		# -s and -N as if we have cleared the file, that is a new modification, so we need to check if it is actually non-empty AND modified
		if [[ -s $file && -N $file ]]; then
			__list || return
		fi
	}
	function __add {
		echo-style "${option_args[@]}" >>"$file" || return
	}

	case "$action" in
	'free') __free ;;
	'has') __has ;;
	'clear') __clear ;;
	'warn') __warn ;;
	'list') __list ;;
	'add') __add ;;
	*) help "An unrecognised action was provided: $action" ;;
	esac
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	dorothy_warnings "$@"
fi
