#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

remote="$(ask --question='What remote to configure?' --default="${1:-"origin"}" --required)"
protocol="$(git-protocol-ask "${2-}")"
ourl="$(git-remote-url "$remote")"
hurl="$(git-protocol-format "$ourl" https)"
surl="$(git-protocol-format "$ourl" ssh)"

{
	echo "git-protocol-ensure"
	echo "Directory:    $(pwd)"
	echo "Remote:       $remote"
	echo "Remote URI:   $ourl"
	echo "SSH URI:      $surl"
	echo "HTTPS URI:    $hurl"
	echo "Preference:   $protocol"
} >/dev/tty

if test "$protocol" = 'ssh'; then
	git-protocol-apply "$remote" ssh || {
		echo 'SSH failed, attempting HTTPS...' >/dev/stderr
		git-protocol-apply "$remote" https
	}
else
	git-protocol-apply "$remote" https
fi
