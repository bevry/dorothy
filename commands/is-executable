#!/usr/bin/env bash

function is_executable_test() (
	source "$DOROTHY/sources/is-fs-tests.bash"
	local root command='is-executable' tuples=()
	root="$(is_fs_tests__prep "$command")"

	eval-tester --ignore-stderr --status=22 -- "$command" --help
	eval-tester --name='no args' --status=22 --ignore-stderr -- "$command" --

	# NOTE:
	# unaccessible paths aren't actually accessible to only root
	# it's more that root doesn't care, and bypasses the permissions anyway
	# so [chmod a-rwx] removes access to everything, but root doesn't care
	# however, unless [chown 0:0] is also done, then a standard user could undo the [chmod a-rwx]

	# NOTE:
	# chmod a-x -- <dir> <file>
	# sudo test -x <dir> # 0
	# sudo test -x <file> # 1
	# chown '0:0' -- <dir> <file>
	# sudo test -x <dir> # 0
	# sudo test -x <dir> # 1
	# the reason for this:
	# root disregards dir/file read/write/exec permissions, except file exec permissions
	# this is because everything, except bin execution, must be available to root
	# this means that encryption is the only protection against root
	# so make sure your volumes/secrets are encrypted to avoid a root user from accessing them
	# such as via attaching the volume to a new sudo machine

	# test no privilege elevation
	tuples=(
		--path='' --status=22

		--path="$root/missing-dir/missing-file" --status=2
		--path="$root/missing-file" --status=2

		--path="$root/targets/empty-dir"
		--path="$root/targets/empty-file"
		--path="$root/targets/filled-dir/empty-subfile"
		--path="$root/targets/filled-dir/filled-subdir"
		--path="$root/targets/filled-dir/filled-subdir/empty-subdir"
		--path="$root/targets/filled-dir/filled-subfile"
		--path="$root/targets/filled-file"
		--path="$root/targets/unaccessible-empty-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unaccessible-empty-file" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unaccessible-filled-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unaccessible-filled-dir/empty-subfile" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/targets/unaccessible-filled-dir/filled-subdir" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/targets/unaccessible-filled-dir/filled-subdir/empty-subdir" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/targets/unaccessible-filled-dir/filled-subfile" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/targets/unaccessible-filled-file" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unexecutable-empty-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unexecutable-empty-file" --status=93
		--path="$root/targets/unexecutable-filled-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unexecutable-filled-dir/empty-subfile" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/targets/unexecutable-filled-dir/filled-subdir" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/targets/unexecutable-filled-dir/filled-subdir/empty-subdir" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/targets/unexecutable-filled-dir/filled-subfile" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/targets/unexecutable-filled-file" --status=93
		--path="$root/targets/unreadable-empty-dir"
		--path="$root/targets/unreadable-empty-file"
		--path="$root/targets/unreadable-filled-dir"
		--path="$root/targets/unreadable-filled-dir/empty-subfile"
		--path="$root/targets/unreadable-filled-dir/filled-subdir"
		--path="$root/targets/unreadable-filled-dir/filled-subdir/empty-subdir"
		--path="$root/targets/unreadable-filled-dir/filled-subfile"
		--path="$root/targets/unreadable-filled-file"
		--path="$root/targets/unwritable-empty-dir"
		--path="$root/targets/unwritable-empty-file"
		--path="$root/targets/unwritable-filled-dir"
		--path="$root/targets/unwritable-filled-dir/empty-subfile"
		--path="$root/targets/unwritable-filled-dir/filled-subdir"
		--path="$root/targets/unwritable-filled-dir/filled-subdir/empty-subdir"
		--path="$root/targets/unwritable-filled-dir/filled-subfile"
		--path="$root/targets/unwritable-filled-file"

		--path="$root/symlinks/empty-dir"
		--path="$root/symlinks/empty-file"
		--path="$root/symlinks/filled-dir--empty-subfile"
		--path="$root/symlinks/filled-dir--filled-subdir"
		--path="$root/symlinks/filled-dir--filled-subdir--empty-subdir"
		--path="$root/symlinks/filled-dir--filled-subfile"
		--path="$root/symlinks/filled-file"
		--path="$root/symlinks/unaccessible-empty-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unaccessible-empty-file" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unaccessible-filled-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unaccessible-filled-dir--empty-subfile" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/symlinks/unaccessible-filled-dir--filled-subdir" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/symlinks/unaccessible-filled-dir--filled-subdir--empty-subdir" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/symlinks/unaccessible-filled-dir--filled-subfile" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/symlinks/unaccessible-filled-file" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unexecutable-empty-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unexecutable-empty-file" --status=93
		--path="$root/symlinks/unexecutable-filled-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unexecutable-filled-dir--empty-subfile" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/symlinks/unexecutable-filled-dir--filled-subdir" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/symlinks/unexecutable-filled-dir--filled-subdir--empty-subdir" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/symlinks/unexecutable-filled-dir--filled-subfile" --status="$(__is_fs_tests__print_root_or_nonroot 0 13)"
		--path="$root/symlinks/unexecutable-filled-file" --status=93
		--path="$root/symlinks/unreadable-empty-dir"
		--path="$root/symlinks/unreadable-empty-file"
		--path="$root/symlinks/unreadable-filled-dir"
		--path="$root/symlinks/unreadable-filled-dir--empty-subfile"
		--path="$root/symlinks/unreadable-filled-dir--filled-subdir"
		--path="$root/symlinks/unreadable-filled-dir--filled-subdir--empty-subdir"
		--path="$root/symlinks/unreadable-filled-dir--filled-subfile"
		--path="$root/symlinks/unreadable-filled-file"
		--path="$root/symlinks/unwritable-empty-dir"
		--path="$root/symlinks/unwritable-empty-file"
		--path="$root/symlinks/unwritable-filled-dir"
		--path="$root/symlinks/unwritable-filled-dir--empty-subfile"
		--path="$root/symlinks/unwritable-filled-dir--filled-subdir"
		--path="$root/symlinks/unwritable-filled-dir--filled-subdir--empty-subdir"
		--path="$root/symlinks/unwritable-filled-dir--filled-subfile"
		--path="$root/symlinks/unwritable-filled-file"
	)
	is_fs_tests__tuples --group='test no privilege elevation' "$command" --no-elevate -- "${tuples[@]}"

	# test with privilege elevation
	tuples=(
		--path="$root/targets/unaccessible-empty-dir"
		--path="$root/targets/unaccessible-empty-file"
		--path="$root/targets/unaccessible-filled-dir"
		--path="$root/targets/unaccessible-filled-dir/empty-subfile"
		--path="$root/targets/unaccessible-filled-dir/filled-subdir"
		--path="$root/targets/unaccessible-filled-dir/filled-subdir/empty-subdir"
		--path="$root/targets/unaccessible-filled-dir/filled-subfile"
		--path="$root/targets/unaccessible-filled-file"
		--path="$root/targets/unexecutable-empty-dir"
		--path="$root/targets/unexecutable-empty-file" --status=93
		--path="$root/targets/unexecutable-filled-dir"
		--path="$root/targets/unexecutable-filled-dir/empty-subfile"
		--path="$root/targets/unexecutable-filled-dir/filled-subdir"
		--path="$root/targets/unexecutable-filled-dir/filled-subdir/empty-subdir"
		--path="$root/targets/unexecutable-filled-dir/filled-subfile"
		--path="$root/targets/unexecutable-filled-file" --status=93

		--path="$root/symlinks/unaccessible-empty-dir"
		--path="$root/symlinks/unaccessible-empty-file"
		--path="$root/symlinks/unaccessible-filled-dir"
		--path="$root/symlinks/unaccessible-filled-dir--empty-subfile"
		--path="$root/symlinks/unaccessible-filled-dir--filled-subdir"
		--path="$root/symlinks/unaccessible-filled-dir--filled-subdir--empty-subdir"
		--path="$root/symlinks/unaccessible-filled-dir--filled-subfile"
		--path="$root/symlinks/unaccessible-filled-file"
		--path="$root/symlinks/unexecutable-empty-dir"
		--path="$root/symlinks/unexecutable-empty-file" --status=93
		--path="$root/symlinks/unexecutable-filled-dir"
		--path="$root/symlinks/unexecutable-filled-dir--empty-subfile"
		--path="$root/symlinks/unexecutable-filled-dir--filled-subdir"
		--path="$root/symlinks/unexecutable-filled-dir--filled-subdir--empty-subdir"
		--path="$root/symlinks/unexecutable-filled-dir--filled-subfile"
		--path="$root/symlinks/unexecutable-filled-file" --status=93
	)
	is_fs_tests__tuples --group='test with privilege elevation' "$command" --elevate -- "${tuples[@]}"

	# test default privilege elevation
	tuples=(
		--path="$root/targets/unaccessible-empty-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unaccessible-empty-file" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unaccessible-filled-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unaccessible-filled-dir/empty-subfile"
		--path="$root/targets/unaccessible-filled-dir/filled-subdir"
		--path="$root/targets/unaccessible-filled-dir/filled-subdir/empty-subdir"
		--path="$root/targets/unaccessible-filled-dir/filled-subfile"
		--path="$root/targets/unaccessible-filled-file" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unexecutable-empty-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unexecutable-empty-file" --status=93
		--path="$root/targets/unexecutable-filled-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/targets/unexecutable-filled-dir/empty-subfile"
		--path="$root/targets/unexecutable-filled-dir/filled-subdir"
		--path="$root/targets/unexecutable-filled-dir/filled-subdir/empty-subdir"
		--path="$root/targets/unexecutable-filled-dir/filled-subfile"
		--path="$root/targets/unexecutable-filled-file" --status=93

		--path="$root/symlinks/unaccessible-empty-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unaccessible-empty-file" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unaccessible-filled-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unaccessible-filled-dir--empty-subfile"
		--path="$root/symlinks/unaccessible-filled-dir--filled-subdir"
		--path="$root/symlinks/unaccessible-filled-dir--filled-subdir--empty-subdir"
		--path="$root/symlinks/unaccessible-filled-dir--filled-subfile"
		--path="$root/symlinks/unaccessible-filled-file" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unexecutable-empty-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unexecutable-empty-file" --status=93
		--path="$root/symlinks/unexecutable-filled-dir" --status="$(__is_fs_tests__print_root_or_nonroot 0 93)"
		--path="$root/symlinks/unexecutable-filled-dir--empty-subfile"
		--path="$root/symlinks/unexecutable-filled-dir--filled-subdir"
		--path="$root/symlinks/unexecutable-filled-dir--filled-subdir--empty-subdir"
		--path="$root/symlinks/unexecutable-filled-dir--filled-subfile"
		--path="$root/symlinks/unexecutable-filled-file" --status=93
	)
	is_fs_tests__tuples --group='test default privilege elevation' "$command" -- "${tuples[@]}"

	# break the symlinks
	is_fs_tests__break_symlinks
	tuples=(
		--path="$root/symlinks/empty-dir" --status=9
		--path="$root/symlinks/empty-file" --status=9
		--path="$root/symlinks/filled-dir--empty-subfile" --status=9
		--path="$root/symlinks/filled-dir--filled-subdir" --status=9
		--path="$root/symlinks/filled-dir--filled-subdir--empty-subdir" --status=9
		--path="$root/symlinks/filled-dir--filled-subfile" --status=9
		--path="$root/symlinks/filled-file" --status=9
		--path="$root/symlinks/unaccessible-empty-dir" --status=9
		--path="$root/symlinks/unaccessible-empty-file" --status=9
		--path="$root/symlinks/unaccessible-filled-dir" --status=9
		--path="$root/symlinks/unaccessible-filled-dir--empty-subfile" --status=9
		--path="$root/symlinks/unaccessible-filled-dir--filled-subdir" --status=9
		--path="$root/symlinks/unaccessible-filled-dir--filled-subdir--empty-subdir" --status=9
		--path="$root/symlinks/unaccessible-filled-dir--filled-subfile" --status=9
		--path="$root/symlinks/unaccessible-filled-file" --status=9
		--path="$root/symlinks/unexecutable-empty-dir" --status=9
		--path="$root/symlinks/unexecutable-empty-file" --status=9
		--path="$root/symlinks/unexecutable-filled-dir" --status=9
		--path="$root/symlinks/unexecutable-filled-dir--empty-subfile" --status=9
		--path="$root/symlinks/unexecutable-filled-dir--filled-subdir" --status=9
		--path="$root/symlinks/unexecutable-filled-dir--filled-subdir--empty-subdir" --status=9
		--path="$root/symlinks/unexecutable-filled-dir--filled-subfile" --status=9
		--path="$root/symlinks/unexecutable-filled-file" --status=9
		--path="$root/symlinks/unreadable-empty-dir" --status=9
		--path="$root/symlinks/unreadable-empty-file" --status=9
		--path="$root/symlinks/unreadable-filled-dir" --status=9
		--path="$root/symlinks/unreadable-filled-dir--empty-subfile" --status=9
		--path="$root/symlinks/unreadable-filled-dir--filled-subdir" --status=9
		--path="$root/symlinks/unreadable-filled-dir--filled-subdir--empty-subdir" --status=9
		--path="$root/symlinks/unreadable-filled-dir--filled-subfile" --status=9
		--path="$root/symlinks/unreadable-filled-file" --status=9
		--path="$root/symlinks/unwritable-empty-dir" --status=9
		--path="$root/symlinks/unwritable-empty-file" --status=9
		--path="$root/symlinks/unwritable-filled-dir" --status=9
		--path="$root/symlinks/unwritable-filled-dir--empty-subfile" --status=9
		--path="$root/symlinks/unwritable-filled-dir--filled-subdir" --status=9
		--path="$root/symlinks/unwritable-filled-dir--filled-subdir--empty-subdir" --status=9
		--path="$root/symlinks/unwritable-filled-dir--filled-subfile" --status=9
		--path="$root/symlinks/unwritable-filled-file" --status=9
	)
	is_fs_tests__tuples --group='test broken symlinks' "$command" -- "${tuples[@]}"

	return 0
)
function is_executable() (
	source "$DOROTHY/sources/is-fs.bash"

	# =====================================
	# Arguments

	function __help {
		local fodder
		fodder="$(__is_fs__options '13')" || return $?
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Check if all <path>s are executable.
			Companion to: $(__join --style=code --between=', ' -- 'echo-if-executable').

			USAGE:
			\`is-executable [...options] [--] ...<path>\`

			OPTIONS:
			$fodder

			RETURNS:
			[0] if all <path>s were executable
			[2] if a <path> was missing
			[9] if a <path> was a broken symlink
			[13] if a <path> was not accessible
			[22] if empty arguments were provided
			[93] if a <path> was present, but was not executable
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	__is_fs__args "$@" || return $?

	# invoke
	__is_fs__invoke 'is-executable.bash' '13' || return $?

	# errors
	case "$fs_status" in
	93) __is_fs__error 'The <path> was present, but was not executable:' || return $? ;;
	*) __is_fs__error || return $? ;;
	esac

	# done
	return "$fs_status"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		is_executable_test
	else
		is_executable "$@"
	fi
fi
