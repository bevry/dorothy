#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"
source "$DOROTHY/sources/arrays.bash"
requires_array_support 'mapfile' 'empty'

# dependencies
source "$DOROTHY/sources/ripgrep.bash"
env QUIET=yes setup-util-jq

# options
slug="$(
	ask --required \
		--question='What is the repository slug? org/repo' \
		--default="${1-}"
)"
filter="$(get-flag-value filter -- "$@")" # filter of the release files

# prepare
url="https://api.github.com/repos/$slug/releases/latest"
urls=()
filtered=()
exact=''

# fetch
names=()
values=()
while read -r line || test -n "$line"; do
	if test "${names[@]}" -eq "${#values[@]}"; then
		names+=("$line")
	else
		values+=("$line")
	fi
done < <(fetch "$url" | jq -r ".assets[] | (.name, .browser_download_url)")

# cycle
for i in "${!names[@]}"; do
	name="${names[$i]}"
	value="${values[$i]}"
	if rg -q '.(mini)?sig$' <<<"$name"; then
		continue
	elif test -z "$filter"; then
		urls+=("$value")
	elif test "$filter" = "$name"; then
		exact="$value"
		break
	elif rg -q "$filter" <<<"$name"; then
		filtered+=("$value")
	else
		urls+=("$value")
	fi
done

# finish
if test -n "$exact"; then
	echo "$exact"
elif test "${#filtered[@]}" -ne 0; then
	echo-lines -- "${filtered[@]}"
elif test -n "$filter" -a "${#urls[@]}" -ne 0; then
	stderr echo "The the filter excluded all ${#urls[@]} results."
	exit 1
else
	echo-lines -- "${urls[@]}"
fi
