#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# dependencies
env QUIET=y setup-util-ripgrep
env QUIET=y setup-util-jq

# act
slug="${1:?"USAGE: github-release-file <org/repo> [file]"}"
url="https://api.github.com/repos/$slug/releases/latest"
file="${2-}"

curl -s "$url" | \
	jq -r ".assets[] | select(.name) | .browser_download_url" | \
	rg  --invert-match  '.(mini)?sig$' | \
	fail-on-empty-stdin 'the release contains no downloads' | {
		if test -z "$file"; then
			# output all the files if no filter was provided
			cat
		else
			# filter the files
			mapfile -t urls
			# exact match
			echo-lines "${urls[@]}" | rg --line-regexp "$file" || {
				# partial matches
				echo-lines "${urls[@]}" | rg "$file"
			} | fail-on-empty-stdin "filtering by [$file] returned no results"
		fi
}
