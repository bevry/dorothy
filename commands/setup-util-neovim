#!/usr/bin/env bash

# https://github.com/neovim/neovim
# https://github.com/neovim/neovim/wiki/Installing-Neovim

# https://github.com/neovim/neovim/releases
# only support the installer and appimage, as the extras require complex {bin,libs,lib,share} setup
# nvim-linux64.tar.gz
# nvim-macos.tar.gz
# nvim-win64.msi
# nvim-win64.zip
# nvim.appimage

# https://packages.debian.org/sid/amd64/neovim/filelist
# /usr/bin/nvim

function setup_util_neovim() (
	source "$DOROTHY/sources/bash.bash"

	# improve performance for detectable utilities with conditional assets
	if setup-util --check --cli=nvim "$@"; then
		return 0
	fi

	# despite docs, no apk
	# yum install is undocumented but works
	local options=(
		--name='Neovim'
		--cli='nvim'
		"$@"
		APT='neovim'
		AUR='neovim-git'
		BREW='neovim'
		CASK='neovim'
		GUIX='neovim'
		NIX='nixpkgs.neovim'
		PORT='neovim'
		RPM='neovim'
		SCOOP='neovim'
		ZYPPER='neovim'
	)
	function __get_github_asset_url {
		local suffix="$1" regexp
		regexp="$(echo-escape-regexp -- "$suffix")$" || return $?
		github-download --dry --slug='neovim/neovim' --latest --asset-regexp="$regexp" | echo-first-line || return $?
	}
	function __add_download_appimage_option {
		local suffix="$1" url
		url="$(__get_github_asset_url "$suffix")" || return $?
		options+=(
			DOWNLOAD="$url"
			DOWNLOAD_FILENAME='nvim.appimage'
		)
	}
	if is-system --appimage; then
		__add_download_appimage_option '.appimage' || :
	fi
	setup-util "${options[@]}"
	# .msi failed with: This installation package could not be opened. Contact the application vendor to verify that this is a valid Windows Installer package.
	# function __add_installer_option {
	# 	local url
	# 	url="$(__get_github_asset_url "$1")" || return $?
	# 	options+=(
	# 		INSTALLER="$url"
	# 		INSTALLER_OPEN=yes
	# 	)
	# }
	# elif __is_windows; then
	# 	arch="$(__get_arch)"
	# 	if [[ "$arch" = 'x64' ]]; then
	# 		__add_installer_option '-win64.msi' || :
	# 	fi
	# fi
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_neovim "$@"
fi
