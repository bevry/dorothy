#!/usr/bin/env bash

# @todo deprecate this for `git-helper commit --first`

function get_first_commit_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- get-first-commit --help
)

function get_first_commit() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Get the first commit of a repository.

			USAGE:
			get-first-commit [...options] <repo>

			OPTIONS:
			<repo> | --repo=<repo> | --slug=<repo>
			    The repository slug or url to get the first commit of.
			    Defaults to using the current working directory.
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_repo='' option_open=''
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--repo='* | '--slug='*) option_repo="${item#*=}" ;;
		'--no-open'* | '--open'*) __flag --source={item} --target={option_open} --affirmative ;;
		'--'*) help 'An unrecognised flag was provided: ' --variable-value={item} ;;
		*)
			if [[ -z $option_repo ]]; then
				option_repo="$item"
			else
				help 'An unrecognised argument was provided: ' --variable-value={item}
			fi
			;;
		esac
	done

	# open
	if [[ -z $option_open ]]; then
		if is-system --headful; then
			option_open='yes'
		else
			option_open='no'
		fi
	fi

	# =====================================
	# Action

	# helper
	function act {
		if [[ $option_open == 'no' ]]; then
			git-helper first-commit-entry
		else
			local url
			url="$(git-helper first-commit-url)"
			open "$url"
		fi
	}

	if [[ -n $option_repo ]]; then
		__command_required -- 'gh' || return $?
		local tempdir
		tempdir="$(fs-temp --directory='dorothy' --directory='get-first-commit' --directory)"
		gh repo clone "$option_repo" "$tempdir" -- --quiet
		cd "$tempdir"
		act
		fs-remove --quiet --no-confirm -- "$tempdir"
	else
		act
	fi
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		get_first_commit_test
	else
		get_first_commit "$@"
	fi
fi
