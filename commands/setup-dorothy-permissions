#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"
source "$DOROTHY/sources/globstar.bash"
source "$DOROTHY/sources/nullglob.bash"
if test "$NULLGLOB" = 'no' -o "$GLOBSTAR" = 'no'; then
	exit 95 # Operation not supported
fi

# perform the act
cd "$DOROTHY" || exit 2 # No such file or directory

# user/secrets may need sudo
echo-color --header 'correcting permissions...'
mapfile -t dirs < <(find-directories)
cmds=(
	"$DOROTHY/commands/"*
	"$DOROTHY/user/commands/"*
	"$DOROTHY/user/commands.local/"*
)
chmod-helper --changes --permissions='+rwx' -- "${dirs[@]}" "${cmds[@]}"

echo-color --header 'staging new files...'
# The following paths are ignored by one of your .gitignore files: ...
# hint: Use -f if you really want to add them.
# hint: Turn this message off by running
# hint: "git config advice.addIgnoredFile false"
ok silent git add --ignore-errors "$DOROTHY"/**

echo-color --header 'staging changed files...'
ok git add -u

echo-color --header 'removing junk...'
rm-junk
