#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"
source "$DOROTHY/sources/globstar.bash"
source "$DOROTHY/sources/nullglob.bash"
if test "$NULLGLOB" = 'no' -o "$GLOBSTAR" = 'no'; then
	exit 95 # Operation not supported
fi

# perform the act
cd "$DOROTHY" || exit 2 # No such file or directory

# user/secrets may need sudo
echo 'correcting permissions...'
echo-lines ./** | while read -r file; do
	chmod -f +rwx "$file" || echo "unable to +rwx: $file"
done
echo-lines ./**/*.md ./sources/*.* ./user/**/*.* | while read -r file; do
	chmod -f -x "$file" || echo "unable to -x: $file"
done
echo-lines ./**/commands/* | while read -r file; do
	chmod -f +x "$file" || echo "unable to +x: $file"
done

echo 'stage new files...'
ok silent git add --ignore-errors ./**

echo 'stage changed files...'
ok git add -u

echo 'unstage sensitive files...'
# prevent [git add ./*.sh] from adding [env.*] if it exists
mkdir -p ./user/env
silent git rm --ignore-unmatch --cached -r ./**/env/
silent git rm --ignore-unmatch --cached ./**/env.*

echo 'removing junk...'
rm-junk
