#!/usr/bin/env bash

# NOTES
# Do not do .insteadof changes, as it messages with our git-helper commands
# https://hub.github.com/hub.1.html
# https://stackoverflow.com/a/22027731/130638

# TODO
# Update for these:
# https://unix.stackexchange.com/a/177310/50703
# https://unix.stackexchange.com/a/552708/50703
# https://security.stackexchange.com/a/129477/110805
# https://security.stackexchange.com/a/243798/110805
# Note that edit-key and delete require no-tty to be removed from gpg.conf

function setup_git_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- setup-git --help
)

function setup_git() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Configures git, gpg, and ssh for your preferences and for the system capabilities.

			USAGE:
			\`setup-git [...options] <action>\`

			OPTIONS:
			--[no-]reconfigure
			    Whether to re-prompt and re-save configuration settings.
			--[no-]fallback
			    If disabled, prevents installation of fallbacks to install dependencies.
			--[no-]deps
			    If disabled, prevents installation of dependencies, such as gpg etc.
			--[no-]slim
			    If enabled, disables reconfiguration, fallbacks, and dependencies.

			ACTIONS
			setup
			update
			install|configure
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_reconfigure='' option_fallback='' option_deps=''
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		# <shared arguments between many setup commands>
		'setup')
			action='setup'
			# option_reconfigure will autodetect
			;;
		'update')
			action='setup'
			if [[ -z $option_reconfigure ]]; then
				option_reconfigure='no'
			fi
			;;
		'install' | 'configure')
			action='setup'
			if [[ -z $option_reconfigure ]]; then
				option_reconfigure='yes'
			fi
			;;
		# </shared actions between many setup commands>
		# <shared options between many setup commands>
		'--no-reconfigure'* | '--reconfigure'*) __flag --source={item} --target={option_reconfigure} --affirmative --coerce ;;
		'--no-fallback'* | '--fallback'*) __flag --source={item} --target={option_fallback} --affirmative --coerce ;;
		'--no-deps'* | '--deps'*) __flag --source={item} --target={option_deps} --affirmative --coerce ;;
		'--no-slim'* | '--slim'*) __flag --source={item} --target={option_reconfigure} --target={option_fallback} --target={option_deps} --affirmative --coerce ;;
		# </shared options between many setup commands>
		'--'*) help 'An unrecognised flag was provided: ' --variable-value={item} ;;
		*) help 'An unrecognised argument was provided: ' --variable-value={item} ;;
		esac
	done

	# slim options
	local slim_options=(
		--reconfigure="$option_reconfigure"
		--fallback="$option_fallback"
		--deps="$option_deps"
	)

	# =====================================
	# Prepare

	__print_style --h1='Setup Git'

	# dependencies
	if [[ $option_deps != 'no' ]] || __command_missing -- git; then
		__print_style --h2='Install Git'
		setup-util-git "${slim_options[@]}"
		__print_style --g2='Install Git'
	fi

	# vars
	local protocol_options=(
		ssh
		https
	)
	local merge_tools=()
	if __command_exists -- meld; then
		merge_tools+=(meld)
	fi
	if __command_exists -- delta; then
		merge_tools+=(delta)
	fi
	if __command_exists -- opendiff; then
		merge_tools+=(opendiff)
	fi
	if __command_exists -- diff; then
		merge_tools+=(diff)
	fi

	# =====================================
	# Configuration

	source "$DOROTHY/sources/config.sh"

	# git.bash provides:
	local GIT_DEFAULT_BRANCH='main'
	local GIT_PROTOCOL='' # 'https', or 'ssh'
	local GIT_NAME=''
	local GIT_EMAIL=''
	local MERGE_TOOL=''
	local GITHUB_USERNAME=''
	local GITLAB_USERNAME=''
	local GPG_SIGNING_KEY=''
	local GPG_SIGNING_AGENT='' # 'op' for 1password, 'krypton' for Krypt.co, 'default' for system default
	local KRYPTON_GPG=''       # deprecated, use GPG_SIGNING_KEY=krypton
	local HUB_PROTOCOL=''      # deprecated, replaced by GIT_PROTOCOL
	load_dorothy_config 'git.bash'
	if [[ $GPG_SIGNING_KEY == '1password' ]]; then
		GPG_SIGNING_KEY='op'
	fi

	# handle deprecations
	if [[ $GPG_SIGNING_KEY =~ ^(op|1password)$ ]]; then
		GPG_SIGNING_AGENT='op'
		dorothy-config 'git.bash' -- \
			--field='GPG_SIGNING_KEY' --replace= \
			--field='GPG_SIGNING_AGENT' --value='op'
	fi
	if [[ $GPG_SIGNING_KEY == 'krypton' ]]; then
		GPG_SIGNING_AGENT='krypton'
		dorothy-config 'git.bash' -- \
			--field='KRYPTON_GPG' --replace= \
			--field='GPG_SIGNING_KEY' --replace= \
			--field='GPG_SIGNING_AGENT' --value='krypton'
	fi
	if [[ $KRYPTON_GPG == 'yes' ]]; then
		GPG_SIGNING_AGENT='krypton'
		dorothy-config 'git.bash' -- \
			--field='KRYPTON_GPG' --replace= \
			--field='GPG_SIGNING_AGENT' --value='krypton'
	fi
	if [[ -z $GIT_PROTOCOL && -n $HUB_PROTOCOL ]]; then
		GIT_PROTOCOL="$HUB_PROTOCOL"
		dorothy-config 'git.bash' -- \
			--field='HUB_PROTOCOL' --replace= \
			--field='GIT_PROTOCOL' --value="$HUB_PROTOCOL"
	fi

	# =====================================
	# Reconfiguration

	# optional:
	# GITHUB_USERNAME
	# GITLAB_USERNAME

	# required
	if [[ -z $option_reconfigure ]]; then
		if [[ -z $GIT_NAME || -z $GIT_EMAIL || -z $GIT_DEFAULT_BRANCH ]] ||
			! __has --source={protocol_options} -- "$GIT_PROTOCOL" ||
			! __has --source={merge_tools} -- "$MERGE_TOOL"; then
			option_reconfigure='yes'
		fi
	fi

	# fetch 1password ssh signing agent
	local op_ssh_sign_potential_paths=(
		"$(type -P op-ssh-sign)"
		'/Applications/1Password.app/Contents/MacOS/op-ssh-sign' # macOS
		'/opt/1Password/op-ssh-sign'                             # linux
	) op_ssh_sign_potential_path op_ssh_sign_path=''
	for op_ssh_sign_potential_path in "${op_ssh_sign_potential_paths[@]}"; do
		if [[ -n $op_ssh_sign_potential_path && -e $op_ssh_sign_potential_path ]]; then
			if [[ ! -f $op_ssh_sign_potential_path ]]; then
				__print_style --path="$op_ssh_sign_potential_path" ' ' --warning='was found, but it is not a file.'
			elif [[ ! -x $op_ssh_sign_potential_path ]]; then
				__print_style --path="$op_ssh_sign_potential_path" ' ' --warning='was found, but it is not executable.'
			else
				op_ssh_sign_path="$op_ssh_sign_potential_path"
				break
			fi
		fi
	done

	# configure
	if [[ $option_reconfigure == 'yes' ]]; then
		# required
		GIT_NAME="$(
			ask --required --linger \
				--question='What is the name that you want to configure git with?' \
				--default="${GIT_NAME:-"$(get-profile name -- git ... || :)"}"
		)"
		GIT_EMAIL="$(
			ask --required --linger \
				--question='What is the email that you want to configure git with?' \
				--default="${GIT_EMAIL:-"$(get-profile email -- git ... || :)"}"
		)"
		# optional
		GITHUB_USERNAME="$(
			ask --linger \
				--question='What is the GitHub username that you want to configure git with?' \
				--default="${GITHUB_USERNAME:-"$(get-profile username -- git ... || :)"}"
		)"
		GITLAB_USERNAME="$(
			ask --linger \
				--question='What is the GitLab username that you want to configure git with?' \
				--default="${GITLAB_USERNAME:-"$(get-profile username -- git ... || :)"}"
		)"
		# required
		GIT_PROTOCOL="$(
			choose --required --confirm --linger \
				--question='Which git protocol to prefer?' \
				--default="$GIT_PROTOCOL" -- "${protocol_options[@]}"
		)"
		MERGE_TOOL="$(
			choose --required --confirm --linger \
				--question='Which merge/diff tool to prefer?' \
				--default="$MERGE_TOOL" -- "${merge_tools[@]}"
		)"
		GIT_DEFAULT_BRANCH="$(
			ask --required --linger \
				--question='Which branch to use as the default for new repositories?' \
				--default="$GIT_DEFAULT_BRANCH"
		)"

		# prefer 1password
		if [[ -n $op_ssh_sign_path ]]; then
			if [[ -z $GPG_SIGNING_AGENT ]] && confirm --linger --positive --ppid=$$ -- '1Password SSH Signing Agent is available for GPG, use it?'; then
				GPG_SIGNING_AGENT='op'
			fi
		fi
		if __command_exists -- krgpg; then
			if [[ -z $GPG_SIGNING_AGENT ]] && confirm --linger --positive --ppid=$$ -- 'Krypton is available for GPG, use it?'; then
				GPG_SIGNING_AGENT='krypton'
			fi
		fi
		if [[ $GPG_SIGNING_AGENT != 'op' && $GPG_SIGNING_AGENT != 'krypton' ]]; then
			# 2>/dev/null || : in case there are no gpg keys
			GPG_SIGNING_KEY="$(gpg-helper "${slim_options[@]}" get private 2>/dev/null || :)"
		fi

		# save
		local new_config=(
			--field='GIT_DEFAULT_BRANCH' --value="$GIT_DEFAULT_BRANCH"
			--field='GIT_EMAIL' --value="$GIT_EMAIL"
			--field='GIT_NAME' --value="$GIT_NAME"
			--field='GIT_PROTOCOL' --value="$GIT_PROTOCOL"
			--field='GITHUB_USERNAME' --value="$GITHUB_USERNAME"
			--field='GITLAB_USERNAME' --value="$GITLAB_USERNAME"
			--field='GPG_SIGNING_KEY' --value="$GPG_SIGNING_KEY"
			--field='MERGE_TOOL' --value="$MERGE_TOOL"
		)
		# do not update agent if ssh, unless it is headless, in which ssh is the usual
		# aka, do not update if ssh and headful, in which case this config is a temporary workaround, and not the usual
		if ! (is-ssh && is-system --headful); then
			new_config+=(
				--field='GPG_SIGNING_AGENT' --value="$GPG_SIGNING_AGENT"
			)
		fi
		dorothy-config 'git.bash' --prefer=local -- "${new_config[@]}"
	fi

	# =====================================
	# Apply Configuration

	# General
	__print_style --header2='Git Configuration: General'
	git config --global core.excludesfile "$HOME/.gitignore_global"
	git config --global push.default simple
	git config --global mergetool.keepBackup false
	git config --global color.ui auto
	if [[ -n $GIT_DEFAULT_BRANCH ]]; then
		git config --global init.defaultBranch "$GIT_DEFAULT_BRANCH"
	fi

	# Profile
	__print_style --header2='Git Configuration: Profile'
	if [[ -n $GIT_NAME ]]; then
		git config --global user.name "$GIT_NAME"
	fi
	if [[ -n $GIT_EMAIL ]]; then
		git config --global user.email "$GIT_EMAIL"
	fi
	if [[ -n $GIT_PROTOCOL ]]; then
		git config --global git.protocol "$GIT_PROTOCOL"
	fi

	# Authorizations
	__print_style --header2='Git Configuration: Auth'
	if [[ -n $GITHUB_USERNAME ]]; then
		git config --global github.user "$GITHUB_USERNAME"
	else
		git config --global --unset github.user || : # will fail if already unset
	fi
	if [[ -n $GITLAB_USERNAME ]]; then
		git config --global gitlab.user "$GITLAB_USERNAME"
	else
		git config --global --unset gitlab.user || : # will fail if already unset
	fi

	# Merge Tool
	__print_style --header2='Git Configuration: Merge/Diff Tool:' ' ' --code="$MERGE_TOOL"
	if [[ -n $MERGE_TOOL ]]; then
		git config --global diff.tool "$MERGE_TOOL"
		git config --global merge.tool "$MERGE_TOOL"
	fi

	# Editor
	local editor
	editor="$(edit --dry --wait || :)"
	if [[ -n $editor ]]; then
		__print_style --header2='Git Configuration: Editor:' ' ' --code="$editor"
		git config --global core.editor "$editor"
	fi

	# Authentication
	# Use MacOS Credential Helper if available, otherwise default to time cache
	if __is_macos; then
		__print_style --header2='Git Configuration: MacOS Credentials'
		git config --global credential.helper osxkeychain
		git config --global difftool.prompt false
	else
		__print_style --header2='Git Configuration: Linux Credentials'
		git config --global credential.helper 'cache --timeout=86400'
	fi

	# =====================================
	# GPG

	# https://gist.github.com/troyfontaine/18c9146295168ee9ca2b30c00bd1b41e

	function sign_enable {
		# Enable Signing for Git
		git config --global tag.gpgsign true
		git config --global commit.gpgsign true

		# git config --global push.gpgsign true
		# ^ github doesnâ€™t support this with:
		#   fatal: receiving end does not support --signed push
		#   fatal: the receiving end does not support --signed push

		# done
		__print_style --header2='Git Configuration: Signing:' ' ' --positive='Enabled'
	}
	function sign_check_key {
		# Check we have a key
		if [[ -z $key ]]; then
			__print_style --stderr \
				--error1='Git Configuration: Signing:' --newline \
				--error1='Signing was desired, however there was no key specified.' --newline \
				--notice1='Run ' --code-notice1='setup-git --reconfigure' --notice1=' to configure.'
			return 29 # ESPIPE 29 Illegal seek
		fi

		# Check the key exists
		if [[ ! -f $key ]]; then
			__print_style --stderr \
				--error1='Git Configuration: Signing:' --newline \
				--error1='Signing was desired, however the key does not exist: ' --code-error1="$key" --newline \
				--notice1='Run ' --code-notice1='setup-git --reconfigure' --notice1=' to configure.'
			return 29 # ESPIPE 29 Illegal seek
		fi
	}
	function sign_disable {
		# Disable Signing for Git
		git config --global --unset gpg.format || :
		git config --global --unset gpg.program || :
		git config --global --unset gpg.ssh.program || :
		git config --global --unset tag.gpgsign || :
		git config --global --unset commit.gpgsign || :
		git config --global --unset user.signingkey || :
		__print_style --header2='Git Configuration: Signing:' ' ' --negative='Disabled'
	}
	function sign_krypton {
		# Use Krypton for Signing
		setup-util-krypton "${slim_options[@]}"
		kr pair # krgpg and kr are both installed above
		# configure git for krypton
		git config --global gpg.program "$(type -P krgpg)"
		git config --global --unset user.signingkey || :
		__print_style --header2='Git Configuration: Krypton:' ' ' --positive='Enabled'
	}
	function sign_gnu {
		# Use GnuPG (GPG) Key for Signing
		local key="${1-}"
		sign_check_key "$key"

		# key
		__print_style --header2='Git Configuration: Signing: GPG Key:' ' ' --path="$key"
		git config --using GnuPGlobal gpg.program "$(type -P gpg)"
		git config --global user.signingkey "$key"

		# configure
		gpg-helper "${slim_options[@]}" configure
	}
	function sign_ssh {
		# Use SSH Key for Signing
		local key="${1-}"
		sign_check_key "$key"

		# key
		__print_style --header2='Git Configuration: Signing: SSH Key:' ' ' --path="$key"
		git config --global gpg.format ssh
		git config --global user.signingkey "$key"
	}
	function sign_op {
		# Use 1Password SSH Signing for GPG
		local op_pub="$GPG_SIGNING_KEY"
		if [[ -n $op_pub ]]; then
			if [[ -f "$op_pub.pub" ]]; then
				op_pub="$op_pub.pub"
			elif [[ -f $op_pub ]]; then
				:
			else
				op_pub=''
			fi
		fi
		if [[ -z $op_pub ]]; then
			op_pub="$(ssh-helper "${slim_options[@]}" export --raw || :)"
			GPG_SIGNING_KEY="$op_pub"
		fi
		if [[ -n $op_ssh_sign_path ]]; then
			if [[ -n $op_pub ]]; then
				git config --global gpg.format ssh
				git config --global user.signingkey "$op_pub"
				git config --global gpg.ssh.program "$op_ssh_sign_path"
				# @todo use the GitHub CLI (gh) to automatically do this
				# @todo or use fetch to check it, as I believe GitHub exposes such things
				__print_style --header2='Git Configuration: Signing:' ' ' --code='1Password' --newline \
					'Ensure the public key of ' --path="$op_pub" ' is a SSH signing key at ' --url='https://github.com/settings/ssh/new'
			else
				__print_style --stderr \
					--error2='Git Configuration: Signing:' ' ' --code='1Password' --newline \
					'GPG using 1Password was desired, however ' --negative='unable to find a public key.'
				return 1
			fi
		else
			__print_style --stderr \
				--error2='Git Configuration: Signing:' ' ' --code='1Password' --newline \
				'GPG using 1Password was desired, however ' --negative='1Password does not appear to be installed on this system.' ' ' --notice='Install it first via:' --newline \
				--code='setup-util-1password' --newline \
				--code='setup-util-1password-cli'
			return 1
		fi
	}
	function sign_setup {
		__print_style --header2='Git Configuration: Signing'

		# adjust
		if [[ $GPG_SIGNING_AGENT == 'op' ]]; then
			sign_op
		elif [[ $GPG_SIGNING_AGENT == 'krypton' ]]; then
			sign_krypton
		elif [[ $GPG_SIGNING_KEY == *".ssh"* ]]; then
			sign_ssh "$GPG_SIGNING_KEY"
		else
			sign_gnu "$GPG_SIGNING_KEY"
		fi
	}
	function sign_setup_and_enable {
		local -i setup_status enable_status
		__try {setup_status} -- sign_setup
		if [[ $setup_status -eq 0 ]]; then
			__try {enable_status} -- sign_enable
			return "$enable_status"
		else
			return "$setup_status"
		fi
	}

	# act
	if __command_exists -- gpg; then
		local -i setup_and_enable_status
		__try {setup_and_enable_status} -- sign_setup_and_enable
		if [[ $setup_and_enable_status -ne 0 ]]; then
			sign_disable
		fi
	fi

	# =====================================
	# Security

	__print_style --header2='Git Configuration: Permissions'
	ssh-helper "${slim_options[@]}" permissions
	gpg-helper "${slim_options[@]}" permissions
	# @todo apply the above --install flag
	# @todo github-download caching
	# @todo read -i version added and bash.bash update

	# =====================================
	# SSH

	ssh-helper "${slim_options[@]}" setup

	# =====================================
	# Authenticate with CLIs

	# Must be done here, as they depend on git and ssh being correctly configured
	if [[ -n $GITHUB_USERNAME && $option_deps != 'no' ]]; then
		setup-util-gh --optional "${slim_options[@]}"
	fi

	# =====================================
	# Configure protocols now that ssh is setup

	__print_style --header2='Git Configuration: Protocol:' ' ' --code="$GIT_PROTOCOL"
	if [[ -n $GIT_PROTOCOL ]]; then
		if [[ $GIT_PROTOCOL == 'ssh' ]] && ! ssh-helper "${slim_options[@]}" test; then
			__print_style --notice='SSH failed, temporarily configuring for HTTPS'
			GIT_PROTOCOL='https'
		fi
		git config --global git.protocol "$GIT_PROTOCOL"
		if __command_exists -- hub; then
			git config --global hub.protocol "$GIT_PROTOCOL"
		else
			git config --global --unset hub.protocol || :
		fi
		if __command_exists -- gh; then
			gh config set git_protocol "$GIT_PROTOCOL" || : # can fail
		fi
	fi

	# if [[ -n "$GITLAB_USERNAME" ]]; then
	# glab writes to stderr, grep needed as return status is not indicative
	# wrap in `! (` is to catch failures in the grep, and in the glab call
	# setup-util-glab--optional # only install if gitlab is configured
	# if ! (glab auth status 2>&1 | grep --quiet --fixed-strings --regexp='Logged in to '); then
	# 	glab auth login
	# fi
	# ^ currently broken
	# > glab auth login
	# failed to read configuration:  open /home/ubuntu/.config/glab-cli/.config.yml2800055398: permission denied
	# fi

	# =====================================
	# Done

	__print_style --g1='Setup Git'
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		setup_git_test
	else
		setup_git "$@"
	fi
fi
