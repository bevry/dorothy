#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"


# options
mapfile -t options < <(echo-before-separator "$@")
permissions="$(get-flag-value permissions -- "${options[@]}")"
recursive="$(get-flag-value recursive -- "${options[@]}")"
changes="$(get-flag-value changes -- "${options[@]}")"
partial="$(get-flag-value partial --mising=yes -- "${options[@]}")"
mapfile -t paths < <(echo-after-separator "$@")

# check
if test -z "$permissions" || is-array-empty-or-partial "${paths[@]}"; then
	stderr echo "USAGE:"
	stderr echo "chmod-helper [--no-partial] [--recursive] [--changes] --permissions=<permissions> -- <paths...>"
	stderr echo ""
	stderr echo "EXAMPLE:"
	stderr echo "chmod-helper --permissions='+x' -- path path path"
	exit 1
fi

# args
args=()
if test "$recursive" = 'yes'; then
	args+=('-R')  # --recursive doesn't work on macos
fi
if test "$changes" = 'yes' && ! is-mac; then
	args+=('--changes')  # --changes doesn't work on macos, and has no alternative
fi
args+=("$permissions")

# act
if test "$partial" = 'yes'; then
	for path in "${paths[@]}"; do
		chmod "${args[@]}" "$path" || :
	done
else
	chmod "${args[@]}" "${paths[@]}"
fi
