#!/usr/bin/env bash

# https://www.raspberrypi.com/software/
# https://downloads.raspberrypi.com/imager/imager_latest_amd64.AppImage
# https://downloads.raspberrypi.com/imager/imager_latest.exe
# https://downloads.raspberrypi.com/imager/imager_latest.dmg

# https://github.com/raspberrypi/rpi-imager/releases
# imager-v2.0.0.exe
# Raspberry_Pi_Imager-v2.0.0-cli-aarch64.AppImage
# Raspberry_Pi_Imager-v2.0.0-cli-x86_64.AppImage
# Raspberry_Pi_Imager-v2.0.0-desktop-aarch64.AppImage
# Raspberry_Pi_Imager-v2.0.0-desktop-x86_64.AppImage
# Raspberry_Pi_Imager-v2.0.0-embedded-aarch64.AppImage
# rpi-imager-cli_2.0.0_arm64.deb
# rpi-imager-embedded_2.0.0_arm64.deb
# rpi-imager-v2.0.0.dmg
# rpi-imager_2.0.0.tar.xz
# rpi-imager_2.0.0_arm64.deb

# https://repology.org/project/rpi-imager/versions

function setup_util_rpi_imager() (
	source "$DOROTHY/sources/bash.bash"

	# improve performance for detectable utilities with conditional assets
	if setup-util --check --app=github_desktop "$@"; then
		return 0
	fi

	# setup
	# out of date: apt, aur, nix, rpm, pacstall, void
	local arch options=(
		--app='Raspberry Pi Imager'
		"$@"
		CHOCO='rpi-imager'
	)
	arch="$(__get_arch)"
	function __get_github_asset_url {
		# have to use regexp due to inconsistent asset names: https://github.com/raspberrypi/rpi-imager/issues/1360
		local repo="$1" regexp="$2"
		github-download --dry --slug="$repo" --latest --asset-regexp="$regexp" | echo-first-line || return $?
	}
	function __add_download_option {
		local repo="$1" regexp="$2" url
		url="$(__get_github_asset_url "$repo" "$regexp")" || return $?
		options+=(DOWNLOAD="$url")
	}
	function __add_deb_option {
		local repo="$1" regexp="$2" url
		url="$(__get_github_asset_url "$repo" "$regexp")" || return $?
		options+=(DEB="$url")
	}
	function __add_download_appimage_option {
		local repo="$1" regexp="$2" url
		url="$(__get_github_asset_url "$repo" "$regexp")" || return $?
		options+=(
			DOWNLOAD="$url"
			DOWNLOAD_FILENAME='Raspberry Pi Imager.appimage'
		)
	}
	if __is_macos; then
		__add_download_option 'raspberrypi/rpi-imager' '^rpi-imager-v[.0-9]+[.]dmg$' || :
	elif __is_linux; then
		if [[ $arch == 'a64' ]]; then
			__add_deb_option 'raspberrypi/rpi-imager' '^rpi-imager_[.0-9]+_arm64[.]deb$' || :
			__add_download_appimage_option 'raspberrypi/rpi-imager' '-desktop-aarch64[.][Aa]pp[Ii]mage$' || :
		elif [[ $arch == 'x64' ]]; then
			__add_download_appimage_option 'raspberrypi/rpi-imager' '-desktop-x86_64[.][Aa]pp[Ii]mage$' || :
		fi
	elif __is_windows; then
		__add_download_option 'raspberrypi/rpi-imager' '^imager-v[.0-9]+[.]exe$' || :
	fi
	setup-util "${options[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_rpi_imager "$@"
fi
