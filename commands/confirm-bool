#!/usr/bin/env bash
# don't use strict, as we need exit codes
# strict mode, will cause exit code of 2 to explode and be exited

# 0=yes
# 1=no

function confirmer() {
	# prompt the user
	# timeout one hour
	read -t 3600 -r -n 1 -p "$1 (y/n) " answer
	if test "$?" -gt 128; then
		# timeout occured, should equal no
		exit 1
	fi

	# check for strange answers
	if test "$answer" = $'\x1b'; then
		# escape key should equal no
		return 1
	elif test "$answer" = ''; then
		# no answer / enter key
		echo  # newline, otherwise everything on same line
		# ask again
		confirmer "$1"
		return "$?"
	fi

	# check their answer
	"$DOROTHY/commands/is-affirmative" "$answer"
	ec="$?"

	# check if indeterminate, if so, ask again
	if test "$ec" -eq 2; then
		echo  # newline, otherwise everything on same line
		confirmer "$1"
		return "$?"
	fi

	# return if determinate
	echo # also add a newline as y/n do not
	return "$ec"
}

# confirm with the user
confirmer "$1"
