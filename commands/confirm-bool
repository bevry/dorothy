#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# 0=yes
# 1=no

function confirmer() {
	# prompt the user
	# timeout one hour
	read -t 3600 -r -n 1 -p "$1 (y/n) " answer
	if test "$?" -gt 128; then
		# timeout occured, should equal no
		exit 1
	fi

	# check for strange answers
	if test "$answer" = $'\x1b'; then
		# escape key should equal no
		return 1
	elif test "$answer" = ''; then
		# no answer / enter key
		echo  # newline, otherwise everything on same line
		# ask again
		confirmer "$1"
		return "$?"
	fi

	# check their answer
	set +e # disable hard fail so we can get the exit code
	is-affirmative "$answer"; ec="$?"
	set -e # reenable hard fail

	# check if indeterminate, if so, ask again
	if test "$ec" -eq 2; then
		echo  # newline, otherwise everything on same line
		confirmer "$1"
		return "$?"
	fi

	# return if determinate
	echo # also add a newline as y/n do not
	return "$ec"
}

# confirm with the user
confirmer "$1"
