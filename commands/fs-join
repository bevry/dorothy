#!/usr/bin/env bash

function fs_join() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Join <path>s together.

			USAGE:
			fs-join [--] ...<path>
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_paths=()
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--path='*) option_paths+=("${item#*=}") ;;
		'--')
			option_paths+=("$@")
			shift "$#"
			break
			;;
		'--'*) help 'An unrecognised flag was provided: ' --variable-value={item} ;;
		*)
			option_paths+=("$item" "$@")
			shift "$#"
			break
			;;
		esac
	done

	# =====================================
	# Action

	# allow leading slashes on first item
	# so /Volumes/... still works
	local result="${option_paths[0]}" i next
	for ((i = 1; i < ${#option_paths[@]}; i++)); do
		next="${option_paths[i]}"
		__replace --optional --source+target={result} --trailing-all='/' || return $?
		__replace --optional --source+target={next} --trailing-all='/' --leading-all='/' || return $?
		if [[ -n $result && -n $next ]]; then
			result="$result/$next"
		else
			result="$result$next"
		fi
	done
	__print_lines "$result"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	fs_join "$@"
fi
