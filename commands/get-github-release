#!/usr/bin/env bash

function get_github_release_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- get-github-release --help

	# @todo do tests for fetch as that is the main core of what this actually does

	# prepare
	local expected
	local slug='uw-labs/strongbox' alias='latest' tag='v1.0.0' id='53658169'
	# don't use jqlang/jq for release test as it is too popular, so between requests values like download counts can change
	# slug='jqlang/jq' alias='latest' tag='jq-1.7rc2' id='118848514'
	# slug='probonopd/go-appimage' tag='continuous'

	# install dependencies
	__command_required -- 'jq' || return $?
	__command_required -- 'gh' || return $?

	# check gh is authed, it is on most CI, but not windows WSL
	local -i gh_exit_status=0
	if __command_missing -- gh || ! gh auth status &>/dev/null; then
		gh_exit_status=6
	fi
	local gh_args=()
	function __adjust_gh_args {
		if [[ $gh_exit_status -eq 0 ]]; then
			gh_args=(--stdout="$expected")
		else
			gh_args=(--status="$gh_exit_status" --stderr='ERROR: The GitHub CLI is required and must be authenticated for the gh technique.')
		fi
	}

	## release ##

	# these output a ton of json so --discard-stdout so it doesn't bulk up the CI

	# release from default
	expected="$(get-github-release --jq --release --slug="$slug")"
	eval-tester --discard-stdout --name='release from default via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --release --slug="$slug"
	__adjust_gh_args || return $?
	eval-tester --discard-stdout --name='release from default via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --release --slug="$slug"

	# release from alias
	# default and alias are the same release, so data should be the same
	eval-tester --discard-stdout --name='release from alias via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --release --slug="$slug" --alias="$alias"
	__adjust_gh_args || return $?
	eval-tester --discard-stdout --name='release from alias via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --release --slug="$slug" --alias="$alias"

	# release from tag
	expected="$(get-github-release --jq --release --slug="$slug" --tag="$tag")"
	eval-tester --discard-stdout --name='release from tag via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --release --slug="$slug" --tag="$tag"
	__adjust_gh_args || return $?
	eval-tester --discard-stdout --name='release from tag via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --release --slug="$slug" --tag="$tag"

	# release from id
	# tag and id are the same release, so data should be the same
	eval-tester --discard-stdout --name='release from id via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --release --slug="$slug" --id="$id"
	__adjust_gh_args || return $?
	eval-tester --discard-stdout --name='release from id via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --release --slug="$slug" --id="$id"

	## api-url ##

	# api-url from default
	expected="$(get-github-release --jq --api-url --slug="$slug")"
	eval-tester --name='api-url from default via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --api-url --slug="$slug"
	__adjust_gh_args || return $?
	eval-tester --name='api-url from default via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --api-url --slug="$slug"

	# api-url from alias
	# default and alias are the same release, so data should be the same
	eval-tester --name='api-url from alias via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --api-url --slug="$slug" --alias="$alias"
	__adjust_gh_args || return $?
	eval-tester --name='api-url from alias via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --api-url --slug="$slug" --alias="$alias"

	# api-url from tag
	expected="$(get-github-release --jq --api-url --slug="$slug" --tag="$tag")"
	eval-tester --name='api-url from tag via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --api-url --slug="$slug" --tag="$tag"
	__adjust_gh_args || return $?
	eval-tester --name='api-url from tag via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --api-url --slug="$slug" --tag="$tag"

	# api-url from id
	# tag and id are the same release, so data should be the same
	eval-tester --name='api-url from id via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --api-url --slug="$slug" --id="$id"
	__adjust_gh_args || return $?
	eval-tester --name='api-url from id via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --api-url --slug="$slug" --id="$id"

	## tag ##

	# tag from default
	expected="$(get-github-release --jq --tag --slug="$slug")"
	eval-tester --name='tag from default via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --tag --slug="$slug"
	__adjust_gh_args || return $?
	eval-tester --name='tag from default via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --tag --slug="$slug"

	# tag from alias
	# default and alias are the same release, so data should be the same
	eval-tester --name='tag from alias via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --tag --slug="$slug" --alias="$alias"
	__adjust_gh_args || return $?
	eval-tester --name='tag from alias via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --tag --slug="$slug" --alias="$alias"

	# tag from tag
	expected="$(get-github-release --jq --tag --slug="$slug" --tag="$tag")"
	eval-tester --name='tag from tag via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --tag --slug="$slug" --tag="$tag"
	__adjust_gh_args || return $?
	eval-tester --name='tag from tag via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --tag --slug="$slug" --tag="$tag"

	# tag from id
	# tag and id are the same release, so data should be the same
	eval-tester --name='tag from id via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --tag --slug="$slug" --id="$id"
	# gh doesn't support ids

	## assets ##

	# assets from default
	expected="$(get-github-release --jq --assets --slug="$slug")"
	eval-tester --name='assets from default via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --assets --slug="$slug"
	__adjust_gh_args || return $?
	eval-tester --name='assets from default via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --assets --slug="$slug"

	# assets from alias
	# default and alias are the same release, so data should be the same
	eval-tester --name='assets from alias via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --assets --slug="$slug" --alias="$alias"
	__adjust_gh_args || return $?
	eval-tester --name='assets from alias via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --assets --slug="$slug" --alias="$alias"

	# assets from tag
	expected="$(get-github-release --jq --assets --slug="$slug" --tag="$tag")"
	eval-tester --name='assets from tag via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --assets --slug="$slug" --tag="$tag"
	__adjust_gh_args || return $?
	eval-tester --name='assets from tag via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --assets --slug="$slug" --tag="$tag"

	# assets from id
	# tag and id are the same release, so data should be the same
	eval-tester --name='assets from id via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --assets --slug="$slug" --id="$id"
	# gh doesn't support ids

	## tar ##

	# tar from default
	expected="$(get-github-release --jq --tar --slug="$slug")"
	eval-tester --name='tar from default via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --tar --slug="$slug"
	__adjust_gh_args || return $?
	eval-tester --name='tar from default via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --tar --slug="$slug"

	# tar from alias
	# default and alias are the same release, so data should be the same
	eval-tester --name='tar from alias via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --tar --slug="$slug" --alias="$alias"
	__adjust_gh_args || return $?
	eval-tester --name='tar from alias via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --tar --slug="$slug" --alias="$alias"

	# tar from tag
	expected="$(get-github-release --jq --tar --slug="$slug" --tag="$tag")"
	eval-tester --name='tar from tag via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --tar --slug="$slug" --tag="$tag"
	__adjust_gh_args || return $?
	eval-tester --name='tar from tag via gh was same as via jq' "${gh_args[@]}" -- \
		get-github-release --no-color --gh --tar --slug="$slug" --tag="$tag"

	# tar from id
	# tag and id are the same release, so data should be the same
	eval-tester --name='tar from id via diy was same as via jq' --stdout="$expected" -- \
		get-github-release --diy --tar --slug="$slug" --id="$id"
	# gh doesn't support ids
)
function get_github_release() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function __help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Get the latest release of a GitHub repository.

			USAGE:
			\`get-github-release [<org>/<repo>] [...options]\`

			OPTIONS:
			--slug=<org>/<repo> | <org>/<repo>
			    Use this repository, e.g. \`jqlang/jq\`.

			If no specific selection is provided, then \`--latest\` is used:
			--latest
			    Use the latest release. Alias for \`--alias=latest\`.
			--alias=<alias>
			    Use this release alias, e.g. \`latest\`.
			--tag=<tag>
			    Use this release tag name, e.g. \`jq-1.7rc2\`.
			--id=<id>
			    Use this release id, e.g. \`118848514\`.
			--release=<alias,tag,id>
			    Deprecated alias for either \`--alias=<alias>\`, \`--tag=<tag>\`, \`--id=<id>\`.

			If no specific action is provided, then \`--tag\` is used:
			--tag
			    Fetch the tag name of the release.
			--assets
			    Fetch the assets of the release.
			--tar
			    Fetch the tarball of the release.
			--api-url
			    Fetch the api url of the release.
			--release
			    Fetch the json of the release.
			--releases
			    Fetch the releases of the repository.
			--rate-limit
			    Fetch the current rate limits.

			If no specific techniques are specified, then autodetection is used:
			--gh
			    Enable using the GitHub CLI to fetch the release.
			--jq
			    Enable using jq to fetch the release.
			--diy
			    Enable using curl and awk to fetch the release.
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process, @todo rewrite with option_ prefix
	local item slug='' alias='' tag='' id='' release='' action='' techniques=() technique=''
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') __help || return $? ;;
		'--no-color'* | '--color'*) __flag --source={item} --target={COLOR} --affirmative --export || return $? ;;
		# repo
		'--slug='*) slug="${item#*=}" ;;
		# release
		'--latest') alias='latest' ;;
		'--alias='*) alias="${item#*=}" ;;
		'--tag='*) tag="${item#*=}" ;;
		'--id='*) id="${item#*=}" ;;
		'--release='*) release="${item#*=}" ;;
		# action
		'--tag') action='tag' ;;
		'--assets') action='assets' ;;
		'--tar') action='tar' ;;
		'--api-url') action='api-url' ;;
		'--release') action='release' ;;
		'--releases') action='releases' ;;
		'--rate-limit') action='rate-limit' ;;
		# technique
		'--gh') techniques+=('gh') ;;
		'--jq') techniques+=('jq') ;;
		'--diy') techniques+=('diy') ;;
		'--'*) __help 'An unrecognised flag was provided: ' --variable-value={item} || return $? ;;
		*)
			if [[ -z $slug ]]; then
				slug="$item"
			else
				__help 'An unrecognised argument was provided: ' --variable-value={item} || return $?
			fi
			;;
		esac
	done

	# =====================================
	# Dependencies

	local bin_gsed_or_sed bin_gawk_or_awk
	bin_gsed_or_sed="$(echo-gnu-command --install -- gsed)"
	bin_gawk_or_awk="$(echo-gnu-command --install -- gawk)"

	# =====================================
	# Adjustments

	# export so `gh` can access them, on the cases we are setting them below and/or they aren't exported
	export GITHUB_API_URL GITHUB_HOSTNAME GITHUB_TOKEN

	# GITHUB_API_URL
	# https://docs.github.com/en/actions/learn-github-actions/variables#default-environment-variables
	# default to the default
	if [[ -z ${GITHUB_API_URL-} ]]; then
		GITHUB_API_URL='https://api.github.com' # encounters rate limits when testing, even with authorization
	fi
	# if default, and if our CI, then use our caching proxy (however it currently doesn't return the same http error codes so ignore)
	# if [[ "$GITHUB_API_URL" = 'https://api.github.com' && -n "${GITHUB_ACTIONS-}" && "${GITHUB_REPOSITORY-}" = 'bevry/dorothy' ]]; then
	# 	GITHUB_API_URL='https://bevry.me/api/github' # caches results, to avoid rate limits
	# fi

	# GITHUB_HOSTNAME
	if [[ -z ${GITHUB_HOSTNAME-} ]]; then
		GITHUB_HOSTNAME='github.com'
	fi

	# GITHUB_TOKEN
	if [[ -z ${GITHUB_TOKEN-} ]]; then
		# if not already authed, and if on ci, `gh auth token` outputs a suggestion, so avoid that by checking auth before fetching: https://github.com/bevry/dorothy/actions/runs/20627731941/job/59240989047#step:3:743
		if __command_exists -- gh && gh auth status &>/dev/null; then
			GITHUB_TOKEN="$(gh auth token --hostname "$GITHUB_HOSTNAME" 2>/dev/null || :)"
		else
			GITHUB_TOKEN=''
		fi
	fi

	# essential helpers
	function __fetch_json {
		fetch --bearer-token="$GITHUB_TOKEN" "$1" || return $?
	}
	function __fetch_json_of_rate_limit {
		__fetch_json "$GITHUB_API_URL/rate_limit" || __return $? -- \
			__print_style --stderr --error1='Failed to fetch the GitHub API Rate Limit.' --notice1=' Authorize with the GitHub CLI: ' --code-notice1='gh auth login' || return $?
	}
	function __extract_value_from_json_property_from_stdin {
		local property="$1" awk_script
		awk_script="$(type -P get-json-property-value.awk)" || return $?
		# use -f instead of cat for bash v3 compat
		tr -d '\n' | "$bin_gawk_or_awk" -v option_property="$property" -f "$awk_script" || return $?
	}
	function __wait_on_rate_limit {
		local json remaining now reset seconds message
		json="$(__fetch_json_of_rate_limit)" || return $?
		# limit="$(extract_value_from_json_property_from_stdin 'limit' <<<"$json")"
		remaining="$(__extract_value_from_json_property_from_stdin 'remaining' <<<"$json")" || return $?
		if [[ $remaining -gt 5 ]]; then # we need at least a few requests to do anything, so 5 seems a reasonable limit
			return 0
		fi
		now="$(date-helper --unix)" || return $?
		reset="$(__extract_value_from_json_property_from_stdin 'reset' <<<"$json")" || return $?
		seconds="$((reset - now))"
		message="$(__print_style --notice1='Waiting for the GitHub API Rate Limit to reset... ' --code-notice1+blink="%s remaining")" || return $?
		waiter "$seconds" --message="$message" || return $?
	}

	# rate-limit action is here, to avoid the slug check for everything else
	if [[ $action == 'rate-limit' ]]; then
		__fetch_json_of_rate_limit || return $?
		return $?
	fi

	# enforcements
	if [[ -z $slug ]]; then
		__help 'A GitHub repository slug is required.' || return $?
	fi
	if [[ -n $release ]]; then
		# convert release into its modern format
		if [[ $release == 'latest' ]]; then
			__print_style --tty --notice1='deprecation warning: ' --code-notice1="--release=$release → --latest" || return $?
			if [[ -n $alias ]]; then
				__help --help="\`--release=latest\` and \`--alias=$alias\` are mutually exclusive, you should only use: \`--alias=$alias\`" || return $?
			fi
			alias='latest'
		elif __is_integer "$release"; then
			__print_style --tty --notice1='deprecation warning: ' --code-notice1="--release=$release → --id=$release" || return $?
			if [[ -n $id ]]; then
				__help --help="\`--release=$release\` and \`--id=$id\` are mutually exclusive, you should only use: \`--id=$id\`" || return $?
			fi
			id="$release"
		else
			__print_style --tty --notice1='deprecation warning: ' --code-notice1="--release=$release → --tag=$release"
			if [[ -n $tag ]]; then
				__help --help="\`--release=$release\` and \`--tag=$tag\` are mutually exclusive, you should only use: \`--tag=$tag\`" || return $?
			fi
			tag="$release"
		fi
	fi
	if [[ -n $alias && $alias != 'latest' ]]; then
		__help --help='<alias> can only be `latest`' || return $?
	fi
	if [[ -z $alias && -z $tag && -z $id ]]; then
		# set default
		alias='latest'
	fi

	# defaults
	if [[ -z $action ]]; then
		action='tag'
	fi
	if [[ ${#techniques[@]} -eq 0 ]]; then
		if __command_exists -- gh && gh auth status &>/dev/null; then
			techniques+=('gh')
		fi
		if __command_exists -- jq; then
			techniques+=('jq')
		fi
		techniques+=('diy')
	else
		for technique in "${techniques[@]}"; do
			if [[ $technique == 'gh' ]]; then
				if __command_missing -- gh || ! gh auth status &>/dev/null; then
					__print_error 'The GitHub CLI is required and must be authenticated for the gh technique.' || return $?
					return 6 # ENXIO 6 Device not configured
				fi
			elif [[ $technique == 'jq' ]]; then
				if __command_missing -- jq; then
					__print_error 'The jq utility is required for the jq technique.' || return $?
					return 3 # ESRCH 3 No such process
				fi
			fi
		done
	fi

	# =====================================
	# Helpers

	# fetch releases
	local RELEASES_API_URL="$GITHUB_API_URL/repos/$slug/releases"
	local RELEASE_API_URL_FROM_ALIAS="$GITHUB_API_URL/repos/$slug/releases/$alias"
	local RELEASE_API_URL_FROM_ID="$GITHUB_API_URL/repos/$slug/releases/$id"
	function __fetch_json_of_releases {
		__fetch_json "$RELEASES_API_URL" || return $?
	}
	function __fetch_table_of_releases {
		gh release list --repo "$slug" --limit 100 || return $? # @todo convert into json
	}

	# fetch json of release
	function __fetch_json_of_release_from_tag_via_gh {
		local url
		url="$(__fetch_api_url_of_release_from_tag_via_gh)" || return $?
		__fetch_json "$url" || return $?
	}
	function __fetch_json_of_release_from_tag_via_jq {
		__fetch_json_of_releases | __jq -r ".[] | select(.tag_name==\"$tag\")" || return $?
	}
	function __fetch_json_of_release_from_tag_via_diy {
		local url
		url="$(__fetch_api_url_of_release_from_tag_via_diy)" || return $?
		__fetch_json "$url" || return $?
	}

	# fetch api url
	function __fetch_api_url_of_release_from_alias_via_gh {
		gh release view --repo "$slug" --json apiUrl --jq '.apiUrl' || return $?
	}
	function __fetch_api_url_of_release_from_alias_via_jq {
		__fetch_json "$RELEASE_API_URL_FROM_ALIAS" | __jq -r '.url' || return $?
	}
	function __fetch_api_url_of_release_from_alias_via_diy {
		__fetch_json "$RELEASE_API_URL_FROM_ALIAS" | __extract_value_from_json_property_from_stdin 'url' || return $?
	}
	function __fetch_api_url_of_release_from_tag_via_gh {
		gh release view --repo "$slug" --json apiUrl --jq '.apiUrl' "$tag" || return $?
	}
	function __fetch_api_url_of_release_from_tag_via_jq {
		__fetch_json_of_releases | __jq -r ".[] | select(.tag_name==\"$tag\") | .url" || return $?
	}
	function __fetch_api_url_of_release_from_tag_via_diy {
		# this depends on tag_name being after url
		local awk_script
		awk_script="$(type -P get-json-api-url.awk)" || return $?
		__fetch_json_of_releases | tr -d '\n' | "$bin_gawk_or_awk" -v option_tag="$tag" -f "$awk_script" || return $?
	}

	# fetch tag name
	function __fetch_tag_of_release_from_alias_via_gh {
		gh release view --repo "$slug" --json tagName --jq '.tagName' || return $?
	}
	function __fetch_tag_of_release_from_alias_via_jq {
		__fetch_json "$RELEASE_API_URL_FROM_ALIAS" | __jq -r '.tag_name' || return $?
	}
	function __fetch_tag_of_release_from_alias_via_diy {
		__fetch_json "$RELEASE_API_URL_FROM_ALIAS" | __extract_value_from_json_property_from_stdin 'tag_name' || return $?
	}
	function __fetch_tag_of_release_from_id_via_jq {
		__fetch_json "$RELEASE_API_URL_FROM_ID" | __jq -r '.tag_name' || return $?
	}
	function __fetch_tag_of_release_from_id_via_diy {
		__fetch_json "$RELEASE_API_URL_FROM_ID" | __extract_value_from_json_property_from_stdin 'tag_name' || return $?
	}

	# fetch assets
	function __fetch_assets_of_release_from_api_url_via_jq {
		__fetch_json "$1" | __jq -r '.assets[] | (.name, .browser_download_url)' || return $?
	}
	function __fetch_assets_of_release_from_api_url_via_diy {
		# don't use jq, rg, sd, echo-regexp to accomplish this, as none of them would be installed
		# [tail -n+2] excludes the first line, which is the name of the repo
		# this is fragile as if the order of arguments change, it is all over
		# sed fixes minified json such as `},{` and `","`
		# @todo replace with `echo-regexp` and `echo-write`
		__fetch_json "$1" | "$bin_gsed_or_sed" -E $'s/,/,\\\n/g' | grep --extended-regexp --regexp='"(name|browser_download_url)":' | tail -n+2 | "$bin_gsed_or_sed" -E 's/.+: *"(.+)".*/\1/' || return $?
	}
	function __fetch_assets_of_release_from_alias_via_gh {
		gh release view --repo "$slug" --json assets --jq '.assets[] | (.name, .url)' || return $?
	}
	function __fetch_assets_of_release_from_alias_via_jq {
		__fetch_assets_of_release_from_api_url_via_jq "$RELEASE_API_URL_FROM_ALIAS" || return $?
	}
	function __fetch_assets_of_release_from_alias_via_diy {
		__fetch_assets_of_release_from_api_url_via_diy "$RELEASE_API_URL_FROM_ALIAS" || return $?
	}
	function __fetch_assets_of_release_from_id_via_jq {
		__fetch_assets_of_release_from_api_url_via_jq "$RELEASE_API_URL_FROM_ID" || return $?
	}
	function __fetch_assets_of_release_from_id_via_diy {
		__fetch_assets_of_release_from_api_url_via_diy "$RELEASE_API_URL_FROM_ID" || return $?
	}
	function __fetch_assets_of_release_from_tag_via_gh {
		gh release view --repo "$slug" --json assets --jq '.assets[] | (.name, .url)' "$tag" || return $?
	}
	function __fetch_assets_of_release_from_tag_via_jq {
		local url
		url="$(__fetch_api_url_of_release_from_tag_via_jq)" || return $?
		__fetch_assets_of_release_from_api_url_via_jq "$url" || return $?
	}
	function __fetch_assets_of_release_from_tag_via_diy {
		local url
		url="$(__fetch_api_url_of_release_from_tag_via_diy)" || return $?
		__fetch_assets_of_release_from_api_url_via_diy "$url" || return $?
	}

	# fetch tar
	function __fetch_tar_of_release_from_api_url_via_jq {
		__fetch_json "$1" | __jq -r '.tarball_url' || return $?
	}
	function __fetch_tar_of_release_from_api_url_via_diy {
		__fetch_json "$1" | __extract_value_from_json_property_from_stdin 'tarball_url' || return $?
	}
	function __fetch_tar_of_release_from_alias_via_gh {
		gh release view --repo "$slug" --json tarballUrl --jq '.tarballUrl' || return $?
	}
	function __fetch_tar_of_release_from_alias_via_jq {
		__fetch_tar_of_release_from_api_url_via_jq "$RELEASE_API_URL_FROM_ALIAS" || return $?
	}
	function __fetch_tar_of_release_from_alias_via_diy {
		__fetch_tar_of_release_from_api_url_via_diy "$RELEASE_API_URL_FROM_ALIAS" || return $?
	}
	function __fetch_tar_of_release_from_id_via_jq {
		__fetch_tar_of_release_from_api_url_via_jq "$RELEASE_API_URL_FROM_ID" || return $?
	}
	function __fetch_tar_of_release_from_id_via_diy {
		__fetch_tar_of_release_from_api_url_via_diy "$RELEASE_API_URL_FROM_ID" || return $?
	}
	function __fetch_tar_of_release_from_tag_via_gh {
		gh release view --repo "$slug" --json tarballUrl --jq '.tarballUrl' "$tag" || return $?
	}
	function __fetch_tar_of_release_from_tag_via_jq {
		local url
		url="$(__fetch_api_url_of_release_from_tag_via_jq)" || return $?
		__fetch_tar_of_release_from_api_url_via_jq "$url" || return $?
	}
	function __fetch_tar_of_release_from_tag_via_diy {
		local url
		url="$(__fetch_api_url_of_release_from_tag_via_diy)" || return $?
		__fetch_tar_of_release_from_api_url_via_diy "$url" || return $?
	}

	# =====================================
	# Action

	# wait on rate limits if necessary
	__wait_on_rate_limit || return $?

	# continue with the action
	if [[ $action == 'releases' ]]; then
		for technique in "${techniques[@]}"; do
			if [[ $technique == 'gh' ]]; then
				__fetch_table_of_releases || return $?
			else
				__fetch_json_of_releases || return $?
			fi
			return 0
		done
		__help 'Unable to fetch the releases:' --newline --variable={slug} --newline --variable={id} --newline --variable={alias} --newline --variable={tag} || return $?
		return 29 # ESPIPE 29 Illegal seek
	elif [[ $action == 'release' ]]; then
		# used to debug the other actions
		if [[ -n $id ]]; then
			__fetch_json "$RELEASE_API_URL_FROM_ID" || return $?
			return 0
		elif [[ -n $alias ]]; then
			__fetch_json "$RELEASE_API_URL_FROM_ALIAS" || return $?
			return 0
		elif [[ -n $tag ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'gh' ]]; then
					__fetch_json_of_release_from_tag_via_gh || return $?
				elif [[ $technique == 'jq' ]]; then
					__fetch_json_of_release_from_tag_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_json_of_release_from_tag_via_diy || return $?
				fi
				return 0
			done
		fi
		__help 'Unable to fetch the release json:' --newline --variable={slug} --newline --variable={id} --newline --variable={alias} --newline --variable={tag} || return $?
		return 29 # ESPIPE 29 Illegal seek
	elif [[ $action == 'api-url' ]]; then
		# used to debug the other actions
		if [[ -n $id ]]; then
			__print_lines "$RELEASE_API_URL_FROM_ID" || return $?
			return 0
		elif [[ -n $alias ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'gh' ]]; then
					__fetch_api_url_of_release_from_alias_via_gh || return $?
				elif [[ $technique == 'jq' ]]; then
					__fetch_api_url_of_release_from_alias_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_api_url_of_release_from_alias_via_diy || return $?
				fi
				return 0
			done
		elif [[ -n $tag ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'gh' ]]; then
					__fetch_api_url_of_release_from_tag_via_gh || return $?
				elif [[ $technique == 'jq' ]]; then
					__fetch_api_url_of_release_from_tag_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_api_url_of_release_from_tag_via_diy || return $?
				fi
				return 0
			done
		fi
		__help 'Unable to fetch the api url:' --newline --variable={slug} --newline --variable={id} --newline --variable={alias} --newline --variable={tag} || return $?
		return 29 # ESPIPE 29 Illegal seek
	elif [[ $action == 'tag' ]]; then
		# used by setup-util-elvish to fetch the latest tag name to then do a download from its website
		if [[ -n $tag ]]; then
			__print_lines "$tag" || return $?
			return 0
		elif [[ -n $id ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'jq' ]]; then
					__fetch_tag_of_release_from_id_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_tag_of_release_from_id_via_diy || return $?
				fi
				return 0
			done
		elif [[ -n $alias ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'gh' ]]; then
					__fetch_tag_of_release_from_alias_via_gh || return $?
				elif [[ $technique == 'jq' ]]; then
					__fetch_tag_of_release_from_alias_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_tag_of_release_from_alias_via_diy || return $?
				fi
				return 0
			done
		fi
		__help 'Unable to fetch the tag, likely because only an id was provided with gh:' --newline --variable={slug} --newline --variable={id} --newline --variable={alias} --newline --variable={tag} || return $?
		return 29 # ESPIPE 29 Illegal seek
	elif [[ $action == 'assets' ]]; then
		# used by setup-util-* to grab the appropriate asset for the current platform
		# id is first here, as id will incur less api calls
		if [[ -n $id ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'jq' ]]; then
					__fetch_assets_of_release_from_id_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_assets_of_release_from_id_via_diy || return $?
				fi
				return 0
			done
		elif [[ -n $alias ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'gh' ]]; then
					__fetch_assets_of_release_from_alias_via_gh || return $?
				elif [[ $technique == 'jq' ]]; then
					__fetch_assets_of_release_from_alias_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_assets_of_release_from_alias_via_diy || return $?
				fi
				return 0
			done
		elif [[ -n $tag ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'gh' ]]; then
					__fetch_assets_of_release_from_tag_via_gh || return $?
				elif [[ $technique == 'jq' ]]; then
					__fetch_assets_of_release_from_tag_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_assets_of_release_from_tag_via_diy || return $?
				fi
				return 0
			done
		fi
		__help 'Unable to fetch the assets, likely because only an id was provided with gh:' --newline --variable={slug} --newline --variable={id} --newline --variable={alias} --newline --variable={tag} || return $?
		return 29 # ESPIPE 29 Illegal seek
	elif [[ $action == 'tar' ]]; then
		if [[ -n $id ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'jq' ]]; then
					__fetch_tar_of_release_from_id_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_tar_of_release_from_id_via_diy || return $?
				fi
				return 0
			done
		elif [[ -n $alias ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'gh' ]]; then
					__fetch_tar_of_release_from_alias_via_gh || return $?
				elif [[ $technique == 'jq' ]]; then
					__fetch_tar_of_release_from_alias_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_tar_of_release_from_alias_via_diy || return $?
				fi
				return 0
			done
		elif [[ -n $tag ]]; then
			for technique in "${techniques[@]}"; do
				if [[ $technique == 'gh' ]]; then
					__fetch_tar_of_release_from_tag_via_gh || return $?
				elif [[ $technique == 'jq' ]]; then
					__fetch_tar_of_release_from_tag_via_jq || return $?
				elif [[ $technique == 'diy' ]]; then
					__fetch_tar_of_release_from_tag_via_diy || return $?
				fi
				return 0
			done
		fi
		__help 'Unable to fetch the tarball, likely because only an id was provided with gh:' --newline --variable={slug} --newline --variable={id} --newline --variable={alias} --newline --variable={tag} || return $?
		return 29 # ESPIPE 29 Illegal seek
	else
		__help 'Invalid action:' --newline --variable={action} --newline --variable={slug} --newline --variable={id} --newline --variable={alias} --newline --variable={tag} || return $?
		return 29 # ESPIPE 29 Illegal seek
	fi
	__help 'Unresolvable action:' --newline --variable={action} --newline --variable={slug} --newline --variable={id} --newline --variable={alias} --newline --variable={tag} || return $?
	return 29 # ESPIPE 29 Illegal seek
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		get_github_release_test
	else
		get_github_release "$@"
	fi
fi
