#!/usr/bin/env bash

# Vivaldi does not appear to be open-source

# https://vivaldi.com

# https://vivaldi.com/download/
# https://vivaldi.com/wp-content/vivaldi-versions.js?ver=1767772724
# https://vivaldi.com/wp-content/vivaldi-versions.js

# https://flathub.org/en/apps/com.vivaldi.Vivaldi

# https://repology.org/project/vivaldi/versions

function setup_util_vivaldi() (
	source "$DOROTHY/sources/bash.bash"

	# prepare
	local app_options=(
		--app='Vivaldi'
		--app='vivaldi-stable'
		--app='vivaldi-bin'
	)

	# options
	local option_reconfigure='yes'
	__flag --target={option_reconfigure} --name='reconfigure' --affirmative --coerce -- "$@"

	# helpers
	function __reconfigure {
		# if reconfigure is not desired, or if not installed, then don't reconfigure
		if [[ $option_reconfigure == 'no' ]] || get-app --first --quiet "${app_options[@]}"; then
			return 0
		fi

		# 1Password
		if setup-util-1password --check; then
			# https://www.1password.community/discussions/1password/browser---desktop-integration-vivaldi-on-linux-doesnt-work/97383
			fs-make --root='/etc/1password' --file='custom_allowed_browsers' --root --append-line='vivaldi-bin' --reason='Your password is required to momentarily grant privileges to enable 1Password Desktop integration with Vivaldi:' || return $?
		fi

		# AdGuard for Linux / AdGuard CLI
		# https://github.com/AdguardTeam/AdGuardCLI/issues/105#issuecomment-3712047838
		if setup-util-adguard-cli --check; then
			local browsers_config_path="$XDG_DATA_HOME/adguard-cli/browsers.yaml"
			if [[ -f $browsers_config_path ]]; then
				config-helper --file="$browsers_config_path" -- \
					--find=$'^- name: vivaldi-bin\n  action: default' --replace=$'- name: vivaldi-bin\n  action: default'
			fi
		fi
	}

	# setup
	local options=(
		--name='Vivaldi'
		"${app_options[@]}"
		"$@"
	)
	if __is_windows; then
		options+=(
			SCOOP_BUCKET='extras'
			SCOOP='vivaldi'
			WINGET='Vivaldi.Vivaldi'
		)
	else
		# improve performance for detectable utilities with conditional assets
		if setup-util --check "${app_options[@]}" "$@"; then
			__reconfigure
			return 0
		fi

		# setup
		options+=(
			EMERGE='www-client/vivaldi'
			FLATPAK='com.vivaldi.Vivaldi'
			NIX='vivaldi-stable'
			SNAP='vivaldi'
		)
		local arch json
		arch="$(__get_arch)"
		json="$(fetch 'https://vivaldi.com/wp-content/vivaldi-versions.js' | echo-regexp --regexp='^[^{]+' --replace='' || :)"
		if [[ -n $json ]]; then
			function __add_json_property_option {
				local property="$1"
				echo-json --property="$property" -- "$json"
			}
			function __add_download_dmg_option {
				local property="$1" url
				url="$(__add_json_property_option "$property")" || return $?
				options+=(
					DOWNLOAD="$url"
					DOWNLOAD_ARCHIVE_GLOB='*/Vivaldi.app'
					DOWNLOAD_FILENAME='Vivaldi.app'
				)
			}
			function __add_deb_option {
				local property="$1" url
				url="$(__add_json_property_option "$property")" || return $?
				options+=(DEB="$url")
			}
			function __add_rpm_option {
				local property="$1" url
				url="$(__add_json_property_option "$property")" || return $?
				options+=(RPM="$url")
			}
			if __is_macos; then
				__add_download_dmg_option 'vivaldi_version_mac'
			elif __is_linux; then
				if [[ $arch == 'x64' ]]; then
					__add_deb_option 'vivaldi_version_deb64' || :
					__add_rpm_option 'vivaldi_version_rpm64' || :
				elif [[ $arch == 'a64' ]]; then
					__add_deb_option 'vivaldi_version_arm64' || :
					__add_rpm_option 'vivaldi_version_arm64_rpm' || :
				fi
			fi
		fi
	fi
	setup-util "${options[@]}"
	__reconfigure
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_vivaldi "$@"
fi
