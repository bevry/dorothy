#!/usr/bin/env bash

function get_profile_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- get-profile --help
)

function get_profile() (
	source "$DOROTHY/sources/bash.bash"
	source "$DOROTHY/sources/config.sh"

	local available_properties=(
		name
		email
		url
		username
		possessive-pronoun
	)
	local available_sources=(
		config
		git
		npm
		os
	)

	# =====================================
	# Arguments

	function __help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Attempts to retrieve a profile property from one or more sources.

			USAGE:
			get-profile <property> [--] ...<source>

			CONFIGURATION:
			The \`config\` <source> uses the \`profile.bash\` user configuration file.

			OPTIONS:
			<property> | --property=<property>
			    The property of the profile to fetch.
			    If omitted, you will be prompted to select one.

			<property> ...<source> | -- ...<source> | --source=<source>
			    The source(s) to fetch the property from.
			    If omitted, all sources will be used.
			    If \`...\` is used, it will be expanded to all sources.

			PROPERTIES:
			$(__join --source={available_properties} --left='* ' --between=$'\n' --style='code')

			SOURCES:
			$(__join --source={available_sources} --left='* ' --between=$'\n' --style='code')
			* \`...\` shorthand for all sources.

			RETURNS:
			[0] if a value was found.
			STDOUT will output the fetched value.
			STDERR will be empty.

			[6] if no value was found.
			STDOUT will be empty.
			STDERR will output that the result is undefined.

			EXAMPLES:
			Attempt to retrieve the name from the first available source, these are equivalent:
			\`\`\`
			get-profile name
			get-profile name --
			get-profile name -- ...
			\`\`\`

			Attempt to retrieve the name from only npm:
			\`\`\`
			get-profile name -- npm
			\`\`\`

			Attempt to retrieve the name from the first available source, starting with npm and git:
			\`\`\`
			get-profile name -- npm git ...
			\`\`\`
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item
	local selected_property=''
	local selected_sources=()
	function __select_property {
		selected_property="$(
			choose --required \
				--question='Which profile property to fetch the value for?' -- \
				"${available_properties[@]}"
		)" || return $?
	}
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') __help || return $? ;;
		'--source=...' | '...') selected_sources+=("${available_sources[@]}") ;;
		'--source='*) selected_sources+=("${item#*=}") ;;
		'--property='*) selected_property="${item#*=}" ;;
		'--')
			# if moving onto sources, ensure property is selected, so we can handle all further options as sources
			if [[ -z $selected_property ]]; then
				__select_property || return $?
			fi
			continue
			;;
		*)
			if [[ -z $selected_property ]]; then
				selected_property="$item"
			else
				selected_sources+=("$item")
			fi
			;;
		esac
	done

	# if no property, then prompt the user
	if [[ -z $selected_property ]]; then
		__select_property || return $?
	fi

	# ensure all properties are valid
	if ! __has --source={available_properties} -- "$selected_property"; then
		help 'An unrecognised property was provided: ' --variable-value={selected_property} || return $?
	fi

	# if empty source selection, use all source options
	if [[ ${#selected_sources[@]} -eq 0 ]]; then
		selected_sources=("${available_sources[@]}")
	fi

	# =====================================
	# Action

	local result selected_source
	for selected_source in "${selected_sources[@]}"; do
		result=''
		case "$selected_source" in
		'config')
			load_dorothy_config 'profile.bash'
			case "$selected_property" in
			'name') result="${NAME-}" ;;
			'email') result="${EMAIL-}" ;;
			'url') result="${URL-}" ;;
			'username') result="${USERNAME-}" ;;
			'possessive-pronoun') result="${POSSESSIVE_PRONOUN-}" ;;
			*) ;; # continue to next source/property combination
			esac
			;;
		'git')
			case "$selected_property" in
			'name' | 'email') result="$(git config --global "user.${selected_property}")" || : ;;
			'username') result="$(git config --global 'github.user' || git config --global 'gitlab.user')" || : ;;
			*) ;; # continue to next source/property combination
			esac
			;;
		'npm')
			case "$selected_property" in
			'name' | 'email' | 'url')
				if __command_exists -- npm; then
					# 2>/dev/null to hide warning about old `.` instead of `-` format
					result="$(
						nvm-env -- npm config get "init-author-${selected_property}" 2>/dev/null || nvm-env -- npm config get "init.author.${selected_property}" 2>/dev/null
					)" || :
				fi
				;;
			*) ;; # continue to next source/property combination
			esac
			;;
		'os')
			case "$selected_property" in
			'name')
				if __is_macos; then
					# `-F` for `id` is only macOS
					__prepare_current_uid || :
					if [[ $CURRENT_UID != 0 ]]; then
						result="$(id -F "$CURRENT_UID" 2>/dev/null)" || :
					else
						__prepare_login_uid || :
						result="$(id -F "$LOGIN_UID" 2>/dev/null)" || :
					fi
				fi
				;;
			'username')
				__prepare_current_user || :
				if [[ $CURRENT_USER != 'root' ]]; then
					result="$CURRENT_USER"
				else
					__prepare_login_user || :
					result="$LOGIN_USER"
				fi
				;;
			*) ;; # continue to next source/property combination
			esac
			;;
		*) __help --help='An unrecognised <source> was provided: ' --variable-variable={selected_source} || return $? ;;
		esac

		# if we have a result, then exit with it
		if [[ -n $result ]]; then
			__print_lines "$result" || return $?
			return 0
		fi
	done

	# if we are here, then no result was found, so apply a default if supported
	if [[ $selected_property == 'possessive-pronoun' ]]; then
		__print_lines 'their' || return $?
		return 0
	fi

	# if still nothing, do not output anything, just return a failure
	# as outputting something causes that something to be visible to the user when doing things like `="$(get-profile ... || :)"` which is unintuitive
	return 6 # ENXIO 6 Device not configured
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		get_profile_test
	else
		get_profile "$@"
	fi
fi
