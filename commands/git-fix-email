#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

git shortlog -se

oldemail="$(ask-mandatory "What is the old email?" "{1-}")"
newemail="$(ask-mandatory "What is the new email?" "{2-}")"
newname="$(ask-mandatory "What is the old name?" "{3-}")"

rm -Rf .git/refs/original

git filter-branch --env-filter "
OLD_EMAIL=\"$oldemail\"
CORRECT_EMAIL=\"$newemail\"
CORRECT_NAME=\"$newname\"
if [ \"\$GIT_COMMITTER_EMAIL\" = \"\$OLD_EMAIL\" ]; then
	export GIT_COMMITTER_NAME=\"\$CORRECT_NAME\"
	export GIT_COMMITTER_EMAIL=\"\$CORRECT_EMAIL\"
fi
if [ \"\$GIT_AUTHOR_EMAIL\" = \"\$OLD_EMAIL\" ]; then
	export GIT_AUTHOR_NAME=\"\$CORRECT_NAME\"
	export GIT_AUTHOR_EMAIL=\"\$CORRECT_EMAIL\"
fi
" --tag-name-filter cat -- --branches --tags