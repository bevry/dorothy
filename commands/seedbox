#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"
source "$DOROTHY/sources/config.sh"
source "$DOROTHY/sources/arrays.bash"
if test "$ARRAYS" = 'no'; then
	echo "Array support required for: $0 $*" >/dev/stderr
	exit 95 # Operation not supported
fi

# prepare
image='haugene/transmission-openvpn'
version='3.7.1' # latest
actions=(create start status debug stop restart clean remove upgrade logs follow id)

# =====================================
# CONFIGURATION

# load configuration
config_file="$(get_dorothy_config 'seedbox.bash')"
load_dorothy_config 'seedbox.bash'
configure='no'

# load options
mapfile -t options < <(echo-before-separator "$@")
mapfile -t args < <(echo-after-separator "$@")

# options: action
option_action="$(get-flag-value action -- "${options[@]}")"
option_action="$(choose-option \
	--question='What action to perform?' \
	--filter="${option_action:-"$1"}" \
	-- "${actions[@]}")"

# options: configure
configure_options=()
configure="$(get-flag-value configure --missing=no -- "${options[@]}" | echo-affirmative)"
if test "$configure" = 'yes' -o ! -f "$config_file"; then
	configure='yes'
	configure_options+=('--confirm')
fi

# options: configuration
datapath="$(ask \
	"${configure_options[@]}" \
	--question="Where do you want your seedbox data to exist?" \
	--default="${datapath:-"$HOME/Downloads/seedbox"}" \
	--required)"
vpnuser="$(ask \
	"${configure_options[@]}" \
	--question="What is your NordVPN username?" \
	--default="${vpnuser-}" \
	--required)"
vpnpass="$(ask \
	"${configure_options[@]}" \
	--question="What is your NordVPN password?" \
	--default="${vpnpass-}" \
	--required --password)"

# update configuration
if test "$configure" = 'yes'; then
	cat <<EOF >"$config_file"
#!/usr/bin/env bash

if test "\$(get-hostname)" = '$(get-hostname)'; then
	export datapath='$datapath'
	export vpnuser='$vpnuser'
	export vpnpass='$vpnpass'
else
	echo 'Not running on an intended host.'
	exit 0
fi

EOF
	echo "Saved configuration: $config_file"
fi

# =====================================
# VALIDATE

mkdir -p "$datapath"

# validate
if test -z "${seedboxport-}"; then
	seedboxport='9091'
fi
if test -z "${vpnprovider-}"; then
	vpnprovider='NORDVPN'
fi
if test -z "${vpnprotocol-}"; then
	vpnprotocol='udp'
fi
if test -z "${datapath-}"; then
	stderr echo 'datapath configuration missing'
	exit 1
fi
if test -z "${vpnuser-}"; then
	stderr echo 'vpnuser configuration missing'
	exit 1
fi
if test -z "${vpnpass-}"; then
	stderr echo 'vpnpass configuration missing'
	exit 1
fi

# ensure data path exists already
function check_data {
	if test ! -d "$datapath"; then
		stderr "datapath does not appear mounted: $datapath"
		exit 1
	fi
}

# dependencies
if ! command-exists docker; then
	stderr echo "docker was not found, install it first with [setup-docker]"
	exit 1
fi

# check docker is working
silent sudo systemctl status docker --no-pager || {
	stderr echo 'docker not ready'
	exit 1
}

# =====================================
# HELPERS

# actions
function seedbox_ip {
	local id
	id="$(seedbox_id || :)"
	if test -z "$id"; then
		echo 'no seedbox present to get ip for'
		return 1
	fi
	docker exec -it "$id" curl -fsSL 'http://ipecho.net/plain'
}
function seedbox_id {
	# the bellow could hang if there is an issue, hence the timeout
	mapfile -t ids < <(timeout 60s docker ps -a --filter ancestor="$image:$version" --format '{{ .ID }}' || :)
	if test "${#ids[@]}" -eq 0; then
		stderr echo 'no seedbox present to get id for'
		return 1
	fi
	choose-option --question='Which container ID to use?' --required -- "${ids[@]}"
}
function seedbox_debug {
	local id
	id="$(seedbox_id || :)"
	if test -z "$id"; then
		echo 'no seedbox present to get debug for'
		return 1
	fi
	docker exec -it "$id" sh -c "$(cat "$DOROTHY/commands/debug-network")"
}
function seedbox_logs {
	local id
	id="$(seedbox_id || :)"
	if test -z "$id"; then
		echo 'no seedbox present to get logs for'
		return 1
	fi
	docker logs "$id" "$@"
}
function seedbox_follow {
	seedbox_logs --follow
}
function seedbox_status {
	local id localip hostip seedboxip details
	id="$(seedbox_id || :)"
	if test -z "$id"; then
		echo 'no seedbox present to get status for'
		return 1
	fi
	localip="$(ip-local)"
	hostip="$(ip-remote)"
	seedboxip="$(seedbox_ip)"
	details=(
		"host ip	     =  $hostip"
		"seedbox ip   =  $seedboxip"
		"seedbox url  =  http://$localip:$seedboxport"
	)
	if test "$hostip" != "$seedboxip"; then
		echo 'seedbox is running correctly'
		echo-lines "${details[@]}"
	else
		echo 'seedbox did not connect to the vpn it seems'
		echo-lines "${details[@]}"
		echo
		if confirm-positive 'Would you like to debug it?'; then
			seedbox_debug
		fi
		exit 1
	fi
}
function seedbox_create {
	local id dnsip

	check_data
	echo 'seedbox creating...'

	# prepare
	if test -z "${vpncountry-}"; then
		vpncountry="$(what-is-my-country)"
	fi
	dnsip="$(what-is-my-exposed-dns)"

	# create
	set -x # <debug>
	# https://github.com/haugene/docker-transmission-openvpn/blob/master/docker-compose.yml
	docker run \
		--detach \
		-v "$datapath":/data \
		-e OPENVPN_PROVIDER="$vpnprovider" \
		-e OPENVPN_USERNAME="$vpnuser" \
		-e OPENVPN_PASSWORD="$vpnpass" \
		-e OPENVPN_OPTS='--mute-replay-warnings' \
		-e NORDVPN_CATEGORY='P2P' \
		-e NORDVPN_COUNTRY="$vpncountry" \
		-e NORDVPN_PROTOCOL="$vpnprotocol" \
		-e LOCAL_NETWORK=192.168.0.0/16 \
		-e HEALTH_CHECK_HOST='api.nordvpn.com' \
		-e SELFHEAL=true \
		-e TRANSMISSION_WEB_UI=flood-for-transmission \
		-e WEBPROXY_ENABLED=false \
		--log-driver json-file --log-opt max-size=256kb \
		--cap-add=NET_ADMIN \
		--net=bridge --dns="$dnsip" \
		-p "$seedboxport":"$seedboxport" \
		"$image:$version"

	#  --inactive 0 --ping 0 --ping-exit 0 --ping-restart 0 --pull-filter ignore ping

	# --log-driver json-file \
	# doesn't seem to do anything

	# https://docs.docker.com/engine/reference/run/
	# https://docs.docker.com/engine/reference/run/#restart-policies---restart
	# --restart=on-failure
	# ^ Restart only if the container exits with a non-zero exit status. Optionally, limit the number of restart retries the Docker daemon attempts.
	# --restart=unless-stopped
	# ^ Always restart the container regardless of the exit status, including on daemon startup, except if the container was put into a stopped state before the Docker daemon was stopped
	# restart is handled via `docker update` commands before and after start/stop

	# -e OPENVPN_OPTS='-mute-replay-warnings' \
	# --sysctl net.ipv6.conf.all.disable_ipv6=1 \
	# Options error: the --route-pre-down directive should have at most 1 parameter.  To pass a list of arguments as one of the parameters, try enclosing them in double quotes ("").

	# https://openvpn.net/community-resources/reference-manual-for-openvpn-2-4/
	# OPENVPN_OPTS
	# --mute-replay-warnings
	# ^ Silence the output of replay warnings, which are a common false alarm on WiFi networks. This option preserves the security of the replay protection code without the verbosity associated with warnings about duplicate packets.
	# --inactive 0 --ping 0 --ping-exit 0 --ping-restart 0
	# --inactive 3600 --ping 10 --ping-exit 60
	# ^ when used on both peers will cause OpenVPN to exit within 60 seconds if its peer disconnects, but will exit after one hour if no actual tunnel data is exchanged.
	# --pull-filter ignore ping

	# https://haugene.github.io/docker-transmission-openvpn/config-options/#health_check_option
	# HEALTH_CHECK_HOST
	# Because your VPN connection can sometimes fail, Docker will run a health check on this container every 5 minutes to see if the container is still connected to the internet. By default, this check is done by pinging google.com once. You change the host that is pinged.

	# https://support.nordvpn.com/Connectivity/Linux/1047409422/How-can-I-connect-to-NordVPN-using-Linux-Terminal.htm
	# nordvpn recommends disabling ipv6, which the image syntax should be
	# https://haugene.github.io/docker-transmission-openvpn/provider-specific/
	# --sysctl net.ipv6.conf.all.disable_ipv6=1

	# -e TZ=UTC
	# -e NORDVPN_PROTOCOL=tcp

	# continue
	set +x # </debug>
	id="$(seedbox_id)"

	echo 'seedbox created'
}
function seedbox_stop {
	local id
	id="$(seedbox_id || :)"
	if test -z "$id"; then
		echo 'no seedbox present to stop'
		return 0
	fi
	echo "seedbox stopping... $(date)"
	set -x # <debug>
	docker update --restart=no "$id"
	#   -t, --time int   Seconds to wait for stop before killing it (default 10)
	docker stop --time 60 "$id"
	set +x # </debug>
	echo 'seedbox stopped'
}
function seedbox_start {
	local id
	check_data
	id="$(seedbox_id || :)"
	if test -z "$id"; then
		echo 'no seedbox present to start'
		return 1
	fi
	echo 'seedbox starting...'
	set -x # <debug>
	docker update --restart=always "$id"
	docker start "$id"
	set +x # </debug>
	echo 'seedbox started'
}
function seedbox_restart {
	seedbox_stop
	seedbox_start
}
function seedbox_remove {
	local id
	seedbox_stop
	id="$(seedbox_id || :)"
	if test -z "$id"; then
		echo 'no seedbox present to remove'
		return 0
	fi
	echo 'removing seedbox...'
	docker rm "$id"
	echo 'seedbox removed'
}
function seedbox_clean {
	seedbox_remove
	docker rmi "$image:$version" || :
}
function seedbox_upgrade {
	seedbox_clean
	echo 'upgrading image...'
	docker pull "$image:$version"
	echo 'upgraded image'
	seedbox_create
	seedbox_start
}

# =====================================
# ACT

# action
if test "$(type -t "seedbox_$option_action")" = 'function'; then
	"seedbox_$option_action" "${args[@]}"
else
	stderr echo 'action not yet implemented'
	exit 1
fi
exit "$?"
