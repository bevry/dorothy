#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# help
if is-help-empty "$@"; then
	stderr cat <<-EOF
		ABOUT:
		Keep trying to connect to a SSH server until there is a successful connection.

		USAGE:
		until-ssh-success [OPTIONS] [USER@]HOST [COMMAND]

		FLAGS:
		All the flags and arguments are the same as the [ssh] command.
	EOF
	exit 22 # Invalid argument
fi

# act
(ssh "$@") || {
	ec="$?" # 130 is ssh open the closed
	if test "$ec" -ne 130; then
		stderr echo "failed with $ec will try again in 10 seconds..."
		sleep 10
		until-ssh-success "$@"
	fi
}
