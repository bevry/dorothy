#!/usr/bin/env bash

function setup_mac_appstore_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- setup-mac-appstore --help
)

function setup_mac_appstore() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function __help {
		__print_help "$@" <<-EOF || return $?
			USAGE:
			Install using \`MAS_INSTALL\` from your \`setup.bash\` configuration file:
			\`setup-mac-appstore\`

			Install the specified Mac App Store apps:
			\`setup-mac-appstore -- ...<name/id>\`

			Prompts to configure \`MAS_INSTALL\` with what you currently have installed:
			\`setup-mac-appstore --configure\`
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_install='no' option_upgrade='no' option_configure='no' packages=()
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') __help ;;
		'--no-install'* | '--install'*) __flag --source={item} --target={option_install} --affirmative ;;
		'--no-upgrade'* | '--upgrade'*) __flag --source={item} --target={option_upgrade} --affirmative ;;
		'--no-configure'* | '--configure'*) __flag --source={item} --target={option_configure} --affirmative ;;
		'--')
			packages+=("$@")
			shift $#
			break
			;;
		'--'*) __help 'An unrecognised flag was provided: ' --variable-value={item} ;;
		*) __help 'An unrecognised argument was provided: ' --variable-value={item} ;;
		esac
	done

	# assert compatibility
	if ! __is_macos; then
		__help 'This command is only purposeful on macOS, which you are not running.' || :
		return 46 # EPFNOSUPPORT 46 Protocol family not supported
	fi

	# =====================================
	# Configuration

	source "$DOROTHY/sources/config.sh"

	# setup.bash provides:
	local MAS_INSTALL=() # tuple array of id, label
	local MAS_UPGRADE='no'
	load_dorothy_config 'setup.bash'

	# =====================================
	# Action

	# log
	__print_style --h1="Mac App Store"

	# dependencies
	__command_required -- 'mas' || return $?

	# action
	if [[ ${#packages[@]} -ne 0 ]]; then
		# use args
		setup-util --source=MAS -- "${packages[@]}"
	elif [[ ${#MAS_INSTALL[@]} -ne 0 && $option_install == 'yes' ]]; then
		# select packages
		local choices=()
		__split --target={choices} --no-zero-length --invoke -- \
			choose --multi \
			--question="Which Mac App Store apps would you like to install?" \
			--label -- "${MAS_INSTALL[@]}"
		setup-util --source=MAS -- "${choices[@]}"
	fi

	# upgrade
	if [[ $option_upgrade == 'yes' && $MAS_UPGRADE == 'yes' ]]; then
		# upgrade
		eval-helper --verbose --wrap -- \
			mas upgrade || :
	fi

	# configure
	if [[ $option_configure == 'yes' ]]; then
		# update MAS_INSTALL with all that are installed
		local id name
		while read -r id name; do
			if ! __has --source={MAS_INSTALL} -- "$id"; then
				MAS_INSTALL+=("$id" "$name")
			fi
		done <<<"$(mas list | cut -w -f1,2 | sort --ignore-case -k 2)"

		# save
		dorothy-config 'setup.bash' -- \
			--field='MAS_INSTALL' --columns=2 --array="$(__print_lines "${MAS_INSTALL[@]}" | sort --ignore-case -k 2)"
	fi

	# log
	__print_style --g1="Mac App Store"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		setup_mac_appstore_test
	else
		setup_mac_appstore "$@"
	fi
fi
