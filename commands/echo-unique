#!/usr/bin/env bash

function echo_unique_test() (
	source "$DOROTHY/sources/bash.bash"

	eval-tester --name='no args' -- \
		echo-unique

	eval-tester --name='no args' -- \
		echo-unique --

	# respect case
	eval-tester --stdout=$'A\nC\ne\na\nb\n' --trailing-newlines -- \
		echo-unique -- A C e a b a b

	__print_lines A C e a b a b | eval-tester --stdout=$'A\nC\ne\na\nb\n' --trailing-newlines -- \
		echo-unique --stdin

	# ignore case
	eval-tester --stdout=$'a\nc\ne\nb\n' --trailing-newlines -- \
		echo-unique --ignore-case -- A C e a b a b

	__print_lines A c e a b a b | eval-tester --stdout=$'a\nc\ne\nb\n' --trailing-newlines -- \
		echo-unique --stdin --ignore-case

	return 0
)
function echo_unique() (
	source "$DOROTHY/sources/stdinargs.bash"

	# =====================================
	# Arguments

	# trunk-ignore(shellcheck/SC2120)
	function __help {
		__print_help "$@" <<-EOF || return
			ABOUT:
			Output each input that is unique, in their original order, without the need to sort beforehand.

			USAGE:
			\`echo-unique [...options] [--] ...<input>\`
			\`echo-lines ...<input> | echo-unique [...options]\`

			OPTIONS:
			--[no-]lower-case | --[no-]ignore-case
			    If enabled, convert the input to lower-case to ignore-case.

			$(__stdinargs__help_options --)
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_lower_case='no' option_args=()
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		--help | -h) __help ;;
		--no-lower-case* | --lower-case* | --no-ignore-case* | --ignore-case*) __flag --source={item} --target={option_lower_case} --affirmative --coerce ;;
		# forward to stdinargs, however support mixing and matching of our options, with stdinargs options
		--)
			option_args+=("$item" "$@")
			shift $#
			break
			;;
		*) option_args+=("$item") ;;
		esac
	done

	# =====================================
	# Action

	local arguments=()
	function __on_piece {
		arguments+=("$1")
	}
	function __on_finish {
		if [[ $option_lower_case == 'yes' ]]; then
			__case --source+target={arguments} --lower || return
		fi
		__unique --source+target={arguments} || return
		__print_lines "${arguments[@]}" || return
	}

	stdinargs "${option_args[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		echo_unique_test
	else
		echo_unique "$@"
	fi
fi
