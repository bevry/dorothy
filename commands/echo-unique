#!/usr/bin/env bash

function echo_unique_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- echo-unique --help

	eval-tester --name='no args' -- \
		echo-unique

	eval-tester --name='no args' -- \
		echo-unique --

	# respect case
	eval-tester --stdout=$'A\nC\ne\na\nb\n' --trailing-newlines -- \
		echo-unique -- A C e a b a b

	__print_lines A C e a b a b | eval-tester --stdout=$'A\nC\ne\na\nb\n' --trailing-newlines -- \
		echo-unique --stdin

	# ignore case
	eval-tester --stdout=$'A\nC\ne\nb\n' --trailing-newlines -- \
		echo-unique --ignore-case -- A C e a b a B

	__print_lines A C e a b a B | eval-tester --stdout=$'A\nC\ne\nb\n' --trailing-newlines -- \
		echo-unique --stdin --ignore-case

	# lowercase
	eval-tester --stdout=$'a\nc\ne\nb\n' --trailing-newlines -- \
		echo-unique --lowercase -- A C e a b a B

	__print_lines A C e a b a B | eval-tester --stdout=$'a\nc\ne\nb\n' --trailing-newlines -- \
		echo-unique --stdin --lowercase

	# uppercase
	eval-tester --stdout=$'A\nC\nE\nB\n' --trailing-newlines -- \
		echo-unique --uppercase -- A C e a b a B

	__print_lines A C e a b a B | eval-tester --stdout=$'A\nC\nE\nB\n' --trailing-newlines -- \
		echo-unique --stdin --uppercase

	return 0
)
function echo_unique() (
	source "$DOROTHY/sources/stdinargs.bash"

	# =====================================
	# Arguments

	function __help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Output each input that is unique, in their original order, without the need to sort beforehand.

			USAGE:
			\`echo-unique [...options] [--] ...<input>\`
			\`echo-lines ...<input> | echo-unique [...options]\`

			OPTIONS:
			--case=lower | --lowercase
			    Compare elements of <input> irrespective of case, and return a lowercase result.
			--case=upper | --uppercase
			    Compare elements of <input> irrespective of case, and return an uppercase result.
			--case=ignore | --ignore-case
			    Compare elements of <input> irrespective of case.
			--case=sensitive
			    Compare elements of <input> normally, respecting case. The default behaviour.

			$(__stdinargs__help_options --)
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_case='sensitive' option_args=()
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') __help ;;
		'--case=lower' | '--lowercase') option_case='lower' ;;
		'--case=upper' | '--uppercase') option_case='upper' ;;
		'--case=ignore' | '--ignore-case') option_case='ignore' ;;
		'--case=sensitive') option_case='sensitive' ;;
		'--case=') : ;;
		# forward to stdinargs, however support mixing and matching of our options, with stdinargs options
		--)
			option_args+=("$item" "$@")
			shift $#
			break
			;;
		*) option_args+=("$item") ;;
		esac
	done

	# =====================================
	# Action

	local arguments=()
	function __on_piece {
		arguments+=("$1")
	}
	function __on_finish {
		__unique --source+target={arguments} --case="$option_case" || return $?
		__print_lines "${arguments[@]}" || return $?
	}

	stdinargs "${option_args[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		echo_unique_test
	else
		echo_unique "$@"
	fi
fi
