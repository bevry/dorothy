#!/usr/bin/env bash

function setup_util_nvm() (
	source "$DOROTHY/sources/bash.bash"
	# enable EVAL_INSTALL, etc
	source "$(type -P setup-util)"

	# ensure NVM_DIR, always set as always applicable right now
	if [[ -z ${NVM_DIR-} ]]; then
		export NVM_DIR="$HOME/.nvm"
	fi

	function nvm_install_or_upgrade {
		if [[ -d $NVM_DIR ]]; then
			cd "$NVM_DIR"
			git-helper verify
		else
			__mkdirp "$NVM_DIR"
			cd "$NVM_DIR"
			git init
			git remote add origin 'https://github.com/nvm-sh/nvm.git'
		fi
		# ensure git remote is usable
		git-helper protocol-update --remote=origin --protocol=https
		# fetch tags
		git fetch --tags origin
		# checkout latest stable tag
		git checkout "$(git describe --abbrev=0 --tags --match "v[0-9]*" "$(git rev-list --tags --max-count=1)")"
	}

	function nvm_uninstall {
		fs-remove --quiet --no-confirm -- "$NVM_DIR"
	}

	# setup
	local options=(
		--name='Node.js Version Manager (NVM)'
		--checker='nvm-env -- nvm --version'
		"$@"
		EVAL_INSTALL='nvm_install_or_upgrade'
		EVAL_UPGRADE='nvm_install_or_upgrade'
		EVAL_UNINSTALL='nvm_uninstall'
	)
	setup_util "${options[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_nvm "$@"
fi
