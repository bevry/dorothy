#!/usr/bin/env bash

function setup_util_nvm() (
	source "$DOROTHY/sources/bash.bash"
	# enable EVAL_INSTALL, etc
	source "$(type -P setup-util)"

	# ensure NVM_DIR, always set as always applicable right now
	if [[ -z ${NVM_DIR-} ]]; then
		export NVM_DIR="$HOME/.nvm"
	fi

	function __nvm_install_or_upgrade() (
		# create/init/configure the repo for this remote
		git-helper sync --path="$NVM_DIR" --remote='origin' --protocol='https' --url='https://github.com/nvm-sh/nvm.git' --no-update || return
		# update tags and checkout the latest stable tag
		cd "$NVM_DIR" || return
		git fetch --tags origin || return
		local hash tag
		hash="$(git rev-list --tags --max-count=1)" || return
		tag="$(git describe --abbrev=0 --tags --match "v[0-9]*" "$hash")" || return
		git checkout "$tag" || return
	)

	function __nvm_uninstall {
		fs-remove --quiet --no-confirm -- "$NVM_DIR" || return
	}

	# setup
	local options=(
		--name='Node.js Version Manager (NVM)'
		--checker='nvm-env -- nvm --version'
		"$@"
		EVAL_INSTALL='__nvm_install_or_upgrade'
		EVAL_UPGRADE='__nvm_install_or_upgrade'
		EVAL_UNINSTALL='__nvm_uninstall'
	)
	setup_util "${options[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_nvm "$@"
fi
