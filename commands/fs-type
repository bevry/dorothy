#!/usr/bin/env bash

function fs_type_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- fs-type --help

	# for whatever reason, what `file` returns deviates between systems
	local expected
	if __is_macos; then
		expected='HTML document text, Unicode text, UTF-8 text, with very long lines (694)'
	elif grep --quiet --ignore-case --extended-regexp --regexp='almalinux|openSUSE Leap 15' -- /etc/os-release 2>/dev/null; then
		expected='HTML document, UTF-8 Unicode text, with very long lines'
	else
		# linux generic, and opensuse/tumbleweed
		expected='HTML document, Unicode text, UTF-8 text, with very long lines (694)'
	fi

	# ignore-tty on this first one, as it may need to install dependencies
	eval-tester --ignore-tty --stdout="$DOROTHY/README.md: $expected" -- \
		fs-type -- "$DOROTHY/README.md"

	# not that dependencies are installed, that first command again
	eval-tester --stdout="$DOROTHY/README.md: $expected" -- \
		fs-type -- "$DOROTHY/README.md"

	# now try it it in brief mode
	eval-tester --stdout="$expected" -- \
		fs-type --brief -- "$DOROTHY/README.md"

	return 0
)
function fs_type() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Get file type identification of a <path>.

			USAGE:
			fs-type [...options] -- ...<path>

			OPTIONS:
			Forwarded to [file].
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_paths=() option_args=()
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--path='*) option_paths+=("${item#*=}") ;;
		'--')
			option_paths+=("$@")
			shift $#
			break
			;;
		*) option_args+=("$item") ;;
		esac
	done

	# check
	if [[ ${#option_paths[@]} -eq 0 ]]; then
		help 'No <path>s provided.'
	fi

	# =====================================
	# Dependencies

	__command_required -- 'file' || return $?

	# =====================================
	# Action

	local path
	for path in "${option_paths[@]}"; do
		file "${option_args[@]}" -- "$path" || return $?
	done
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		fs_type_test
	else
		fs_type "$@"
	fi
fi
