#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# check
if ! is-raspi; then
	exit 0
fi

echo
echo-color --oh1 --h1='Raspberry Pi Essentials' --ch1

# ensure raspi firmware is up to date
# otherwise newer operating system releases can cause issues

# install necessary packages
if is-apt; then
	env NAME='Raspberry Pi Firmware' APT='rpi-eeprom' setup-util apt
	env NAME='Raspberry Pi Configurator' APT='raspi-config' setup-util apt

	# https://bugs.launchpad.net/ubuntu/+source/linux-raspi/+bug/1946368/comments/48
	env NAME='Raspberry Pi Kernel' APT='linux-raspi' setup-util apt

	# Various kernel modules have been moved from the linux-modules-raspi package in order to reduce the initramfs size. This results in several applications (most notably Docker, bug 1947601 1) failing due to missing kernel modules. To work around this: sudo apt install linux-modules-extra-rapsi
	# https://discourse.ubuntu.com/t/impish-indri-release-notes/21951
	env \
		NAME='Ubuntu 21.10 Raspberry Pi Modules' \
		APT='linux-modules-raspi linux-modules-extra-raspi' \
		setup-util apt || :
fi

# ensure autoupdates on restart
sudo systemctl unmask rpi-eeprom-update

# prompt an update on next restart
if sudo rpi-eeprom-update -a | grep reboot; then
	echo 'An eeprom update is pending for your Raspberry Pi, to continue further you must reboot your machine.'
	exit 1
fi

echo-color --og1 --g1='Raspberry Pi Essentials' --cg1
