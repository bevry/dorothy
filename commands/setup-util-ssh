#!/usr/bin/env bash

# https://packages.debian.org/sid/amd64/openssh-server/filelist

# https://repology.org/project/openssh/versions
# https://packages.debian.org/bookworm/source/openssh
#
# https://packages.debian.org/bookworm/openssh-client
# https://packages.debian.org/sid/amd64/openssh-client/filelist
# /usr/bin/scp
# /usr/bin/sftp
# /usr/bin/slogin
# /usr/bin/ssh
# /usr/bin/ssh-add
# /usr/bin/ssh-agent
# /usr/bin/ssh-argv0
# /usr/bin/ssh-copy-id
# /usr/bin/ssh-keygen
# /usr/bin/ssh-keyscan
#
# https://packages.debian.org/bookworm/openssh-server
# https://packages.debian.org/sid/amd64/openssh-server/filelist
# /usr/sbin/sshd
#
# https://packages.debian.org/bookworm/ssh (meta package, installs both openssh-client and openssh-server)

function setup_util_ssh() (
	source "$DOROTHY/sources/bash.bash"

	# check for both client and server
	if setup-util --check --cli=ssh "$@" && setup-util --check --cli=sshd "$@"; then
		return 0
	fi

	# setup
	local options=(
		--name='OpenSSH'
		"$@"
		APK='openssh'  # ALPINE
		APT='openssh'  # UBUNTU
		AUR='openssh'  # ARCH
		BREW='openssh' # MACOS
		NIX='openssh'
		RPM='openssh'    # FEDORA
		ZYPPER='openssh' # SUSE
	)
	setup-util "${options[@]}"

	# if installed, configure
	if __command_exists -- sshd; then
		# macos, ubuntu, opensuse
		if service-helper --supported; then
			if __is_macos; then
				service-helper --ignore --enable --start -- system/com.openssh.sshd
			else
				service-helper --ignore --enable --start -- ssh || :
				# [sshd] service doesn't seem to exist anywhere...
			fi
		fi

		# opensuse
		if __command_exists -- firewall-cmd; then
			eval-helper --elevate -- firewall-cmd --permanent --add-service=ssh || :
			eval-helper --elevate -- firewall-cmd --reload || :
		fi
	fi
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_ssh "$@"
fi
