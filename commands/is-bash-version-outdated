#!/usr/bin/env bash

function is_bash_version_outdated_test() (
	source "$DOROTHY/sources/bash.bash"

	# `bash.bash` imports:
	# IS_BASH_VERSION_OUTDATED
	# BASH_VERSION_CURRENT
	# BASH_VERSION_LATEST

	# this test is now checking if the currently running bash version is outdated
	if [[ $IS_BASH_VERSION_OUTDATED == 'yes' ]]; then
		eval-tester --status=75 -- is-bash-version-outdated --quiet
		eval-tester --status=75 --ignore-stdout -- is-bash-version-outdated --verbose
	else
		eval-tester -- is-bash-version-outdated --quiet
		eval-tester --ignore-stdout -- is-bash-version-outdated --verbose
	fi

	# this test is to test if the known latest version is the latest available version
	# note that the url is unreliable and often hangs, @todo use a bevry cloudflare worker to cache it
	local bash_version_latest_available
	bash_version_latest_available="$(
		fetch 'https://ftp.gnu.org/gnu/bash/?C=M;O=D' | echo-regexp -o --regexp='href="bash-([0-9.]+?)[.]tar[.]gz"' --replace='$1'
	)"
	# to fetch all bash versions:
	# fetch 'https://ftp.gnu.org/gnu/bash/?C=M;O=D' | echo-regexp -go --regexp='href="bash-([0-9.]+?)[.]tar[.]gz"' --replace='$1'
	eval-tester --name='latest known bash version is latest available' --stdout="$bash_version_latest_available" -- \
		printf '%s' "$BASH_VERSION_LATEST"
)

function is_bash_version_outdated() (
	source "$DOROTHY/sources/bash.bash"

	# `bash.bash` imports:
	# IS_BASH_VERSION_OUTDATED
	# BASH_VERSION_CURRENT
	# BASH_VERSION_LATEST

	# =====================================
	# Arguments

	function help {
		cat <<-EOF >&2
			ABOUT:
			Output whether the current bash version is outdated.

			USAGE:
			is-bash-version-outdated [...options]

			OPTIONS:
			--quiet
			    Don't output anything, just return exit status.

			QUIRKS:
			This checks whether the current version is supported by Dorothy, not whether the current version is the latest version.
		EOF
		if [[ $# -ne 0 ]]; then
			__print_error "$@"
		fi
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_quiet='no'
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--no-verbose'* | '--verbose'*) __flag --source={item} --target={option_quiet} --non-affirmative ;;
		'--no-quiet'* | '--quiet'*) __flag --source={item} --target={option_quiet} --affirmative ;;
		'--'*) help "An unrecognised flag was provided: $item" ;;
		*) help "An unrecognised argument was provided: $item" ;;
		esac
	done

	# =====================================
	# Action

	if [[ $option_quiet == 'no' ]]; then
		__print_style \
			--bold='current bash version' ' = ' --invert="$BASH_VERSION_CURRENT" --newline \
			--bold='latest known bash version' ' = ' --invert="$BASH_VERSION_LATEST" --newline \
			--bold='version outdated' ' = ' --invert="$IS_BASH_VERSION_OUTDATED" --newline
	fi
	if [[ $IS_BASH_VERSION_OUTDATED == 'yes' ]]; then
		return 75 # EPROGMISMATCH 75 Program version wrong
	fi
	return 0
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		is_bash_version_outdated_test
	else
		is_bash_version_outdated "$@"
	fi
fi
