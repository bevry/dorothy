#!/usr/bin/env bash

# The official GitHub Desktop is not available on Linux
# https://github.com/desktop/desktop/releases
# NAMES:
# GitHub Desktop 3.5.4 macOS arm64
# GitHub Desktop 3.5.4 macOS x64
# GitHub Desktop 3.5.4 Windows x64 Delta Nupkg
# GitHub Desktop 3.5.4 Windows x64 Full Nupkg
# GitHub Desktop 3.5.4 Windows x64 EXE Installer
# GitHub Desktop 3.5.4 Windows x64 MSI Installer
# FILES:
# GitHub.Desktop-arm64.zip
# GitHub.Desktop-x64.zip
# GitHubDesktop-3.5.4-x64-delta.nupkg
# GitHubDesktop-3.5.4-x64-full.nupkg
# GitHubDesktopSetup-x64.exe
# GitHubDesktopSetup-x64.msi

# However, the fork, GitHub Desktop Plus, does have Linux Support
# https://github.com/desktop/desktop/issues/1525
# https://github.com/pol-rivero/github-desktop-plus

# https://github.com/pol-rivero/github-desktop-plus/releases
# GitHubDesktopPlus-v3.5.5.0-linux-arm64.AppImage
# GitHubDesktopPlus-v3.5.5.0-linux-arm64.deb
# GitHubDesktopPlus-v3.5.5.0-linux-arm64.rpm
# GitHubDesktopPlus-v3.5.5.0-linux-armhf.deb
# GitHubDesktopPlus-v3.5.5.0-linux-armv7l.AppImage
# GitHubDesktopPlus-v3.5.5.0-linux-armv7l.rpm
# GitHubDesktopPlus-v3.5.5.0-linux-x86_64.AppImage
# GitHubDesktopPlus-v3.5.5.0-linux-x86_64.deb
# GitHubDesktopPlus-v3.5.5.0-linux-x86_64.rpm
# GitHubDesktopPlus-v3.5.5.0-macOS-arm64.zip
# GitHubDesktopPlus-v3.5.5.0-macOS-x64.zip
# GitHubDesktopPlus-v3.5.5.0-windows-arm64.exe
# GitHubDesktopPlus-v3.5.5.0-windows-arm64.msi
# GitHubDesktopPlus-v3.5.5.0-windows-x64.exe
# GitHubDesktopPlus-v3.5.5.0-windows-x64.msi

# https://repology.org/project/github-desktop-plus/versions

function setup_util_github_desktop_plus() (
	source "$DOROTHY/sources/bash.bash"

	# app options
	local app_options=(
		--app='GitHub Desktop Plus' # macos, appimage via DOWNLOAD
		--app='github-desktop-plus' # .desktop
		--app='Desktop Plus'        # flatpak name
	)

	# improve performance for detectable utilities with conditional assets
	if setup-util --check "${app_options[@]}" "$@"; then
		return 0
	fi

	# setup
	local arch options=(
		"${app_options[@]}"
		"$@"
		AUR='github-desktop-plus-bin'
		APT_KEY='https://gpg.polrivero.com/public.key'
		APT_REPO='deb [arch={ARCH} signed-by={KEY}] https://deb.github-desktop.polrivero.com/ stable main'
		APT='github-desktop-plus'
		# skip rpm, as it requires key and repo, and so far 1password has such but done manually as `setup-util` doesn't yet support such
		FLATPAK='io.github.pol_rivero.github-desktop-plus'
	)
	arch="$(__get_arch)"
	function __get_github_asset_url {
		local repo="$1" suffix="$2" regexp
		regexp="$(echo-escape-regexp -- "$suffix")$" || return $?
		github-download --dry --slug="$repo" --latest --asset-regexp="$regexp" | echo-first-line || return $?
	}
	function __add_download_option {
		local repo="$1" suffix="$2" url
		url="$(__get_github_asset_url "$repo" "$suffix")" || return $?
		options+=(DOWNLOAD="$url")
	}
	function __add_deb_option {
		local repo="$1" suffix="$2" url
		url="$(__get_github_asset_url "$repo" "$suffix")" || return $?
		options+=(DEB="$url")
	}
	function __add_rpm_option {
		local repo="$1" suffix="$2" url
		url="$(__get_github_asset_url "$repo" "$suffix")" || return $?
		options+=(RPM="$url")
	}
	function __add_appimage_option {
		local repo="$1" suffix="$2" url
		url="$(__get_github_asset_url "$repo" "$suffix")" || return $?
		options+=(
			APPIMAGE="$url"
			APPIMAGE_FILENAME='GitHub Desktop Plus.appimage'
		)
	}
	if __is_macos; then
		if [[ $arch == 'a64' ]]; then
			__add_download_option 'pol-rivero/github-desktop-plus' '-macos-arm64.zip' || :
		elif [[ $arch == 'x64' ]]; then
			__add_download_option 'pol-rivero/github-desktop-plus' '-macos-x64.zip' || :
		fi
	elif __is_linux; then
		if [[ $arch == 'a64' ]]; then
			__add_deb_option 'pol-rivero/github-desktop-plus' '-linux-arm64.deb' || :
			__add_rpm_option 'pol-rivero/github-desktop-plus' '-linux-arm64.rpm' || :
			__add_appimage_option 'pol-rivero/github-desktop-plus' '-linux-arm64.AppImage' || :
		elif [[ $arch == 'a32' ]]; then
			__add_appimage_option 'pol-rivero/github-desktop-plus' '-linux-armv7l.AppImage' || :
		elif [[ $arch == 'x64' ]]; then
			__add_appimage_option 'pol-rivero/github-desktop-plus' '-linux-x86_64.AppImage' || :
		fi
	fi
	setup-util "${options[@]}"
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_github_desktop_plus "$@"
fi
