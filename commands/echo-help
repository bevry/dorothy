#!/usr/bin/env bash

function echo_help_test() (
	source "$DOROTHY/sources/bash.bash"

	# if there is invalid syntax, then the status won't be 0
	eval-tester --ignore-stderr -- echo-help 'first argument' --blue='second argument' <<-EOF
		This <bold> should be bold.
		This [dim] should be dim.
		This <bold[dim+bold<bold+dim[dim+bold]bold+dim>dim+bold]bold> should be combination.
		This [dim<bold+dim[dim+bold<bold+dim>dim+bold]bold+dim>dim] should be combination.
		This should be bold and dim [<bold-and-dim>]

		This \`\`\`<\`\`\` blah \`\`\`>\`\`\` should have no effect
		This \`\`\`< \`\`\` blah \`\`\` >\`\`\` should have no effect
		This \`\`\`[\`\`\` blah \`\`\`]\`\`\` should have no effect
		This \`\`\`[ \`\`\` blah \`\`\` ]\`\`\` should have no effect
		This \`\`\`<&\`\`\` blah \`\`\`>&\`\`\` should have no effect
		This \`\`\` <&\`\`\` blah \`\`\` >&\`\`\` should have no effect
		This \`\`\`<(\`\`\` blah \`\`\`)>\`\`\` should have no effect
		This \`\`\`<( \`\`\` blah \`\`\` )>\`\`\` should have no effect
		This \`\`\`<<\`\`\` blah \`\`\`>>\`\`\` should have no effect
		This \`\`\`<< \`\`\` blah \`\`\` >>\`\`\` should have no effect
		This \`\`\`<<<\`\`\` blah \`\`\`>>>\`\`\` should have no effect
		This \`\`\`<<< \`\`\` blah \`\`\` >>>\`\`\` should have no effect

		HEADER:
		\`command [...options] <argument> [--option=<value>]\`
		\`\`\`{ sleep 1; echo-lines -- 1 2; sleep 1; echo-style --green=3; sleep 1; echo-style --red=4; sleep 1; echo-style --blue=5; sleep 1; } 2>&1 | echo-revolving-door --lines=3\`\`\`

		OPTIONS:
		--a | b
		<value> | --value=<value>
		...<thing>
		| action
		    Description
		    --argument
		        If set to \`--option=<value> ...[--option=<value>]\`
		    --util=<utility> | --utils=<utility1,utility2,...>
		        Install additional utilities during installation.

		& review [...arguments]
		    Open the git repository in your desired git reviewer. Supports: \`GitFox\`, \`Tower\`
		    ...<argument>
		        Forwarded to the reviewer.

		EXAMPLES:
		Using arguments. Note that the argument technique should be discouraged, as can cause \`Argument list too long\` error:
		<https://github.com/bevry/dorothy/actions/runs/7622089094/job/20759535555#step:4:3259>
		\`printf '%s\n' 'sup'; printf 'a\nb\nc'
		echo-clear-lines -- \$'a\\nb\\nc'\`

		Using process substitution:
		\`\`\`
		printf '%s\n' 'sup'; printf 'a\nb\nc'
		echo-clear-lines --stdin < <(printf 'a\nb\nc')
		\`\`\`

		Do not use \`\`\`<<<\`\`\` as it prints a trailing newline, which would erase \`sup\`.

		Using STDIN:
		\`printf '%s\n' 'sup'; printf 'a\nb\nc'
		printf 'a\nb\nc' | echo-clear-lines\`

		Using \`tee\`:
		\`\`\`
		printf '%s\n' 'sup';
		file="\$(mktemp)"; printf 'a\nb\nc' | tee -- "\$file
		echo-clear-lines < "\$file"\`
		\`\`\`

		\`\`\`
		echo-escape-regexp -- '[a-z](?:test)/a/.*.+?'
		\`\`\`
		Outputs: \`\`\`\[a-z\]\(\?:test\)/a/\.\*\.\+\?\`\`\`
		Returns: [0]

		\`\`\`
		echo-lines -- '[a-z](?:test)/a/.*.+?' | echo-escape-regexp --stdin
		\`\`\`
		Outputs: \`\`\`\[a-z\]\(\?:test\)/a/\.\*\.\+\?\`\`\`
		Returns: [0]

		\`echo-split --needle=' ' -- 'a b' 'c d'\`
		\`echo-lines -- 'a b' 'c d' | echo-split --needle=' ' --stdin\`
		Outputs:
		\`a
		b
		c
		d\`
		Returns: [0]

		\`echo-verbose -- a b c\`
		\`echo-lines -- a b c | echo-verbose --stdin\`
		Outputs:
		\`\`\`
		[0] = [a]
		[1] = [b]
		[2] = [c]
		\`\`\`
		Returns: [0]

		\`echo-trim-zero-length -- 'a' '' 'b' ' ' 'c' 'null' 'd' 'false'\`
		\`echo-lines -- 'a' '' 'b' ' ' 'c' 'null' 'd' 'false' | echo-trim-zero-length --stdin\`
		Outputs:
		\`a
		b

		c
		null
		d
		false\`
		Returns: [1]

		CODE FENCES:
		\`\`\`
		[0] = <value>
		\`\`\`
		    Indented:
		    \`\`\`
		    [1] = <indented>
		    \`\`\`

		FOOTER:
		A <http://url> another <https://url>

		If you want to also do TTY content, do:
		    \`\`\`
		    TERMINAL_OUTPUT_TARGET=2 ... 2>&1 | echo-revolving-door ...
		    \`\`\`
		Note that would only hijack Dorothy TTY outputs, as other commands will just write to \`/dev/tty\` directly, rather than going through Dorothy's TTY helpers.

		LIST:
		* b
		*not a list
		- not a list
		--not a list
		-- not a list
		    * a
			*not a list
			- not a list
		    --not a list
		    -- not a list

		RETURNS:
		[0] success
		[1] error
		[*] error
		Returns: [*]
	EOF
	return 0
)
function echo_help() (
	source "$DOROTHY/sources/bash.bash"

	function __help {
		__print_help "$@" <<-HELPEOF || return $?
			ABOUT:
			Forward STDIN and arguments to Dorothy's \`bash.bash:__print_help\`.

			USAGE:
			\`\`\`
			echo-help [...<error-message>] <<-EOF
			    ABOUT:
				... your template
			EOF
			\`\`\`

			OPTIONS:
			...<error-message>
			    Your error message, each argument is sent to \`bash.bash:__print_style\` aka \`echo-style\`.
			    E.g. \`\`\`echo TEMPLATE | echo-help --help='The option <path> was set to ' --path='/invalid' ' which is not a valid path.'\`\`\`

			TEMPLATE:
			Numbers that are wrapped in square brackets indicates an exit status: [0] will be green. [1] and so on will be read. [*] will also be read.
			Text wrapped in square brackets indicates [optional] flags, e.g. --[no-]flag
			Text wrapped in angled brackets indicates a substitution, e.g. <value>.
			Text wrapped in a single backtick indicates renderable code that respects the above, e.g. \`--flag=<value>\`. Use in your USAGE section.
			You can combine these like so \`--timeout=<timeout:max|immediate|<seconds>>\`
			Text wrapped in three backticks indicates literal code that ignores the above, e.g. \`\`\`--timeout=<timeout:max|immediate|<seconds>>\`\`\`
			A URL wrapped in angled brackets indicates a URL: \`\`\`<https://dorothy.bevry.me>\`\`\` becomes <https://dorothy.bevry.me>

			A line that is all capitals with a trailing colon indicates a header.
			EXAMPLE:

			A line that starts with an asterisk \`*\` indicates a list item:
			* list item
			    * nested list item

			A line that starts with a an \`\`\`&\`\`\` indicates an action, and the \`\`\`&\`\`\` will be removed.
			& delete

			A line that starts looks like an option, e.g. starts with a dash, bracket, dot, pipe, or ampersand indicates an option:
			--option
			    Some documentation.
			    <value>
			       * If \`thing\`, do that.
			       * If \`other\`, do this.

			Arguments that are passed to \`echo-help\` will become errors that are appended to the bottom. It is will up to you to return the correct exit status.

			Exit status should typically be: \`return 22 # EINVAL 22 Invalid argument\`
		HELPEOF
		return 22 # EINVAL 22 Invalid argument
	}

	if [[ $* == '--help' ]]; then
		__help || return $?
	else
		__print_help "$@" || return $?
	fi
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		echo_help_test
	else
		echo_help "$@"
	fi
fi
