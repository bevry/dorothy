#!/usr/bin/env bash

# if you are using bash, use either
# __has --needle="$needle" -- a b c d
# if [[ $needle =~ ^(a|b|c|d)$ ]];

function is_needle_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- is-needle --help

	eval-tester --status=22 --ignore-stderr -- \
		is-needle

	eval-tester --status=22 --ignore-stderr -- \
		is-needle --

	eval-tester --status=22 --ignore-stderr -- \
		is-needle -- a b c

	eval-tester --status=22 --ignore-stderr -- \
		is-needle a b -- a b c

	eval-tester --status=22 --ignore-stderr -- \
		is-needle a b --

	eval-tester --status=22 --ignore-stderr -- \
		is-needle a b

	eval-tester --status=1 -- \
		is-needle a --

	eval-tester --status=1 -- \
		is-needle --any a b --

	eval-tester --status=1 -- \
		is-needle --all a b --

	# capture what [[ " ${items[*]} " =~ " $item " ]] cannot
	eval-tester --status=1 -- \
		is-needle b -- a 'b b b'

	eval-tester --status=1 -- \
		is-needle c -- a 'b b b'

	eval-tester --status=1 -- \
		is-needle --any b c -- a 'b b b'

	eval-tester --status=1 -- \
		is-needle --all b c -- a 'b b b'

	eval-tester -- \
		is-needle --any a 'b b b' -- a 'b b b'

	eval-tester -- \
		is-needle --all a 'b b b' -- a 'b b b'

	eval-tester -- \
		is-needle --any --needle=a --needle='b b b' -- a 'b b b'

	eval-tester -- \
		is-needle --all --needle=a --needle='b b b' -- a 'b b b'

	eval-tester -- \
		is-needle --any a a -- a 'b b b'

	eval-tester -- \
		is-needle --all a a -- a 'b b b'

	eval-tester -- \
		is-needle --any a c -- a 'b b b'

	eval-tester --status=1 -- \
		is-needle --all a c -- a 'b b b'

	eval-tester -- \
		is-needle --any a c -- a 'b b b'

	eval-tester -- \
		is-needle --all --ignore-case a C -- A 'b b b' c

	return 0
)
function is_needle() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	# @todo at some point deprecate these arguments to directly match `__has`
	function help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Check if the <needle> exists within the <input>s
			Equivalent to: $(__join --style=code --between=', ' -- 'is-either' 'is-neither').

			USAGE:
			\`is-needle  [...options] <needle> -- ...<input>\`

			OPTIONS:
			--all | --any
			    Required if multiple needles are provided: which technique to use for comparisons.

			--ignore-case
			    If provided, ignore case when comparing needle to inputs.

			--needle=<needle> | <needle>
			    Verify this <needle> exists within the <input>s
			    Note that you should always use \`--needle=<needle>\` as just doing <needle> will fail if the <needle> looks like a flag.

			RETURNS:
			[0] if the <needle> is found within the <input>s.
			[1] if the <needle> is not found.
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process our arguments
	local item option_mode='' option_ignore_case='no' option_lookups=() option_inputs=() option_inputs_defined='no'
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		--help | -h) help ;;
		--needle=*) option_lookups+=("$item") ;;
		--first) option_mode=first ;;
		--any) option_mode=any ;;
		--each) option_mode=each ;;
		--all) option_mode=all ;;
		--no-ignore-case* | --ignore-case*) __flag --source={item} --target={option_ignore_case} --affirmative ;;
		--)
			option_inputs_defined=yes
			option_inputs+=("$@")
			shift $#
			;;
		# enforce needle flag for items that look like flags
		--*) help 'An unrecognised flag was provided: ' --variable-value={item} ;;
		*) option_lookups+=("--needle=$item") ;;
		esac
	done

	# checks
	if [[ ${#option_lookups[@]} -eq 0 ]]; then
		help 'No <needle>s was provided.'
	fi
	if [[ $option_inputs_defined == 'no' ]]; then
		help 'The -- flag was not provided to separate <needle>s from <input>s, even if there are no <input>s it is required.'
	fi
	if [[ -z $option_mode ]]; then
		if [[ ${#option_lookups[@]} -eq 1 ]]; then
			option_mode='first'
		else
			help 'Multiple <needle>s were provided, but no --{first,any,each,all} flag was provided.'
		fi
	fi
	if [[ ${#option_inputs[@]} -eq 0 ]]; then
		return 1
	fi

	# =====================================
	# Action

	__has --source={option_inputs} --ignore-case="$option_ignore_case" --"$option_mode" --overlap "${option_lookups[@]}" || return 1
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		is_needle_test
	else
		is_needle "$@"
	fi
fi
