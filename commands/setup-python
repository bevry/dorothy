#!/usr/bin/env bash

function setup_python_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- setup-python --help
)

function setup_python() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Configuration

	source "$DOROTHY/sources/config.sh"

	# setup.bash provides:
	local PYTHON_INSTALL=()
	local PIP_INSTALL=()
	local PYTHON2_PIP_INSTALL=()
	local PYTHON3_PIP_INSTALL=()
	local PIPX_INSTALL=()
	local UV_INSTALL=()
	load_dorothy_config 'setup.bash'

	# deprecations
	local deprecations='no'
	if [[ ${#PIPX_INSTALL[@]} -ne 0 ]]; then
		__print_error 'Inside `setup.bash` user configuration, `PIPX_INSTALL` is deprecated, please use `PYTHON_INSTALL` or `UV_INSTALL` instead.'
		deprecations='yes'
	fi
	if [[ ${#PIP_INSTALL[@]} -ne 0 ]]; then
		__print_error 'Inside `setup.bash` user configuration, `PIP_INSTALL` is deprecated, please use `PYTHON_INSTALL` or `UV_INSTALL` instead.'
		deprecations='yes'
	fi
	if [[ ${#PYTHON2_PIP_INSTALL[@]} -ne 0 ]]; then
		__print_error 'Inside `setup.bash` user configuration, `PYTHON2_PIP_INSTALL` is deprecated, please use `PYTHON_INSTALL` or `UV_INSTALL` instead. Or send a PR for `PYTHON2_INSTALL` which uses UV in the background.'
		deprecations='yes'
	fi
	if [[ ${#PYTHON3_PIP_INSTALL[@]} -ne 0 ]]; then
		__print_error 'Inside `setup.bash` user configuration, `PYTHON3_PIP_INSTALL` is deprecated, please use `PYTHON_INSTALL` or `UV_INSTALL` instead.  Or send a PR for `PYTHON3_INSTALL` which uses UV in the background.'
		deprecations='yes'
	fi
	if [[ $deprecations == 'yes' ]]; then
		return 6 # ENXIO 6 Device not configured
	fi

	# adjustments
	__split --target={PYTHON_INSTALL} --no-zero-length --invoke -- \
		dorothy-config --packages-var='PYTHON_INSTALL' -- "${PYTHON_INSTALL[@]}"
	__split --target={UV_INSTALL} --no-zero-length --invoke -- \
		dorothy-config --packages-var='UV_INSTALL' -- "${UV_INSTALL[@]}"

	# =====================================
	# Arguments

	function help {
		__print_help "$@" <<-EOF || return $?
			Setup the Python ecosystem via uv.

			USAGE:
			\`setup-python [...options] [install|update|setup|configure]\`

			OPTIONS:
			--[no-]configure
			    Whether to prompt, confirm, or save configuration changes.
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_configure=''
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		# install|update|setup|configure
		'setup') ;;
		'update')
			option_configure='no'
			;;
		'install' | 'configure')
			option_configure='yes'
			;;
		'--no-configure'* | '--configure'*) __flag --source={item} --target={option_configure} --affirmative ;;
		'--'*) help 'An unrecognised flag was provided: ' --variable-value={item} ;;
		*) help 'An unrecognised argument was provided: ' --variable-value={item} ;;
		esac
	done

	# check
	if [[ -z "${PYTHON_INSTALL[*]}${UV_INSTALL[*]}" ]]; then
		if [[ $option_configure == 'no' ]]; then
			__print_style --dim='Setup of Python ecosystem skipped.'
			return 0
		elif ! confirm --negative --ppid=$$ -- 'Setup Python ecosystem?'; then
			return 0
		fi
	fi

	# =====================================
	# Start

	__print_style --h1='Setup Python'

	# =====================================
	# Install

	# log
	__print_style --h2="Install Python"
	setup-util-python
	source "$DOROTHY/sources/environment.sh"
	__print_style --g2="Install Python"

	# =====================================
	# Packages

	# there use to be support for pip and pipx here, but it was dropped, as uv is superior

	# @todo update uv to also handle the PYTHON2 and PYTHON3 options, via PYTHON2_INSTALL and PYTHON3_INSTALL, or have UV_INSTALL include a python specifier
	local uv_install=("${UV_INSTALL[@]}" "${PYTHON_INSTALL[@]}")
	if [[ ${#uv_install[@]} -ne 0 ]]; then
		__print_style --h3="install ${#uv_install[@]} uv packages"
		setup-util --source=UV -- "${uv_install[@]}"
		__print_style --g3="install ${#uv_install[@]} uv packages"
	fi

	# =====================================
	# Finish

	__print_style --g1='Setup Python'
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		setup_python_test
	else
		setup_python "$@"
	fi
fi
