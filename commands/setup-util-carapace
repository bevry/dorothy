#!/usr/bin/env bash

# https://carapace-sh.github.io/carapace-bin/install.html

# https://github.com/carapace-sh/carapace-bin/releases
# carapace-bin_1.5.1_android_386.termux.deb
# carapace-bin_1.5.1_android_amd64.termux.deb
# carapace-bin_1.5.1_android_arm64.termux.deb
# carapace-bin_1.5.1_android_armv6.termux.deb
# carapace-bin_1.5.1_darwin_amd64.tar.gz
# carapace-bin_1.5.1_darwin_arm64.tar.gz
# carapace-bin_1.5.1_linux_386.apk
# carapace-bin_1.5.1_linux_386.deb
# carapace-bin_1.5.1_linux_386.rpm
# carapace-bin_1.5.1_linux_386.tar.gz
# carapace-bin_1.5.1_linux_amd64.apk
# carapace-bin_1.5.1_linux_amd64.deb
# carapace-bin_1.5.1_linux_amd64.rpm
# carapace-bin_1.5.1_linux_amd64.tar.gz
# carapace-bin_1.5.1_linux_arm64.apk
# carapace-bin_1.5.1_linux_arm64.deb
# carapace-bin_1.5.1_linux_arm64.rpm
# carapace-bin_1.5.1_linux_arm64.tar.gz
# carapace-bin_1.5.1_termux_386.tar.gz
# carapace-bin_1.5.1_termux_amd64.tar.gz
# carapace-bin_1.5.1_termux_arm64.tar.gz
# carapace-bin_1.5.1_termux_armv6.tar.gz
# carapace-bin_1.5.1_windows_386.zip
# carapace-bin_1.5.1_windows_amd64.zip
# carapace-bin_1.5.1_windows_arm64.zip

# https://repology.org/project/carapace/versions

function setup_util_carapace() (
	source "$DOROTHY/sources/bash.bash"

	# options
	local option_reconfigure='yes'
	__flag --target={option_reconfigure} --name='reconfigure' --affirmative --coerce -- "$@"

	# helpers
	function __reconfigure {
		# if reconfigure is not desired, then don't reconfigure
		if [[ $option_reconfigure == 'no' ]]; then
			return 0
		fi

		# reconfigure nushell regardless of carapace existence
		if __command_exists -- nu; then
			setup-util-nu --configure --quiet || return $?
		fi
	}

	# improve performance for detectable utilities with conditional assets
	if setup-util --check --cli=carapace "$@"; then
		__reconfigure
		return 0
	fi

	# setup
	# couldn't get APT to work, APT_REPO was malformed
	local arch options=(
		--cli='carapace'
		"$@"
		AUR='carapace-bin' # ARCH
		BREW_TAP='rsteube/homebrew-tap'
		BREW='rsteube/tap/carapace'
		NIX='carapace'
		VOID='carapace'
		WINGET='rsteube.Carapace'
		YUM_REPO="$(
			cat <<-EOF
				[fury]
				name=Gemfury Private Repo
				baseurl=https://yum.fury.io/rsteube/
				enabled=1
				gpgcheck=0
			EOF
		)"
		YUM='carapace-bin'
	)
	function __get_github_asset_url {
		local regexp
		regexp="$(echo-escape-regexp -- "$1")$" || return $?
		github-download --dry --slug="${2:-"rsteube/carapace-bin"}" --latest --asset-regexp="$regexp" | echo-first-line || return $?
	}
	function __add_download_option {
		local url
		url="$(__get_github_asset_url "$1")" || return $?
		options+=(
			DOWNLOAD="$url"
			DOWNLOAD_ARCHIVE_GLOB="$2"
		)
	}
	function __add_apk_option {
		local url
		url="$(__get_github_asset_url "$1")" || return $?
		options+=(
			APK="$url"
		)
	}
	function __add_deb_option {
		local url
		url="$(__get_github_asset_url "$1")" || return $?
		options+=(
			DEB="$url"
		)
	}
	function __add_rpm_option {
		local url
		url="$(__get_github_asset_url "$1")" || return $?
		options+=(
			RPM="$url"
		)
	}
	arch="$(get-arch)"
	if is-mac; then
		if [[ $arch == 'a64' ]]; then
			__add_download_option '_darwin_arm64.tar.gz' 'carapace' || :
		elif [[ $arch == 'x64' ]]; then
			__add_download_option '_darwin_amd64.tar.gz' 'carapace' || :
		fi
	elif is-linux; then
		if [[ $arch == 'a64' ]]; then
			__add_apk_option '_linux_arm64.apk' || :
			__add_deb_option '_linux_arm64.deb' || :
			__add_rpm_option '_linux_arm64.rpm' || :
			__add_download_option '_linux_arm64.tar.gz' 'carapace' || :
		elif [[ $arch == 'x64' ]]; then
			__add_apk_option '_linux_amd64.apk' || :
			__add_deb_option '_linux_amd64.deb' || :
			__add_rpm_option '_linux_amd64.rpm' || :
			__add_download_option '_linux_amd64.tar.gz' 'carapace' || :
		elif [[ $arch == 'x32' ]]; then
			__add_apk_option '_linux_386.apk' || :
			__add_deb_option '_linux_386.deb' || :
			__add_rpm_option '_linux_386.rpm' || :
			__add_download_option '_linux_386.tar.gz' 'carapace' || :
		fi
	elif is-windows; then
		if [[ $arch == 'a64' ]]; then
			__add_download_option '_windows_arm64.zip' 'carapace.exe' || :
		elif [[ $arch == 'x64' ]]; then
			__add_download_option '_windows_amd64.zip' 'carapace.exe' || :
		elif [[ $arch == 'x32' ]]; then
			__add_download_option '_windows_386.zip' 'carapace.exe' || :
		fi
	fi
	setup-util "${options[@]}"

	# finish
	__reconfigure
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_carapace "$@"
fi
