#!/usr/bin/env bash

function get_terminal_color_support_test() (
	source "$DOROTHY/sources/bash.bash"
	eval-tester --ignore-stderr --status=22 -- get-terminal-color-support --help
)

function get_terminal_color_support() (
	source "$DOROTHY/sources/bash.bash"

	function __help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Outputs [yes], [no], or empty string [], based on comprehensive COLOR mode detection.

			USAGE:
			\`get-terminal-color-support [...options] [-- "\$@"]\`

			OPTIONS:
			--fallback=<fallback>
			    If provided, use this value if color support could not be determined.

			--quiet
			    If enabled, do not output anything, instead return the exit status [0] if quiet, [1] if not. [91] is returned if not determined (no fallback).

			-- "\$@"
			    All arguments passed to your command, so we can scan them for relevant flags.

			QUIRKS:
			Checks for \`--[no-]color[s][=<yes|no>]\` arguments, as well as \`[NO[_]]COLOR\` and \`CRON\`, \`CRONITOR_EXEC\`, and \`TERM\` environment variables.

			RETURNS:
			If in quiet mode:
			[0] if enabled
			[1] if disabled
			[91] if not determined (no fallback).

			If not in quiet mode:
			[0] if enabled or disabled
			[91] if not determined (no fallback).
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	if [[ $* == '--help' ]]; then
		__help || return $?
	else
		__get_terminal_color_support "$@" || return $?
	fi
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	if [[ $* == '--test' ]]; then
		get_terminal_color_support_test
	else
		get_terminal_color_support "$@"
	fi
fi
