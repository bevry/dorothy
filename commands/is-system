#!/usr/bin/env bash

function is_system() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Helpers

	function __is_headful {
		[[ -n ${XDG_CURRENT_DESKTOP-} || -n ${DESKTOP_SESSION-} ]] || __is_macos || __is_windows || return 93 # ENOATTR 93 Attribute not found
	}

	function __is_headless {
		! __is_headful || return 93 # ENOATTR 93 Attribute not found
	}

	function __is_windows {
		__uname_regexp 'MINGW64_NT|-WSL' || return $?
	}

	function __is_desktop_session {
		local regexp="$1"
		if [[ -n ${DESKTOP_SESSION-} ]]; then
			if [[ $DESKTOP_SESSION =~ $regexp ]]; then
				return 0
			else
				return 93 # ENOATTR 93 Attribute not found
			fi
		else
			# macOS has no DESKTOP_SESSION
			return 46 # EPFNOSUPPORT 46 Protocol family not supported
		fi
	}

	function __is_apple_silicon {
		if __is_macos; then
			local arch
			arch="$(__get_arch)" || return $?
			if [[ $arch == 'a64' ]]; then
				return 0
			else
				return 93 # ENOATTR 93 Attribute not found
			fi
		else
			return 46 # EPFNOSUPPORT 46 Protocol family not supported
		fi
	}

	function __uname_regexp {
		local regexp="$1"
		{
			uname -a || return 46 # EPFNOSUPPORT 46 Protocol family not supported
		} | {
			grep --quiet --ignore-case --extended-regexp --regexp="$1" 2>/dev/null || return 93 # ENOATTR 93 Attribute not found
		} || return $?
	}

	function __os_regexp {
		local regexp="$1"
		if [[ -f /etc/os-release ]]; then
			if grep --quiet --ignore-case --extended-regexp --regexp="$regexp" -- /etc/os-release 2>/dev/null; then
				return 0
			else
				return 93 # ENOATTR 93 Attribute not found
			fi
		else
			return 46 # EPFNOSUPPORT 46 Protocol family not supported
		fi
	}

	function __os_id {
		local id="$1"
		# some distros have quotes for the ID (almalinux, openmandriva) and some don't (ubuntu)
		__os_regexp "ID=\"?${id}\"?" || return $?
	}

	# =====================================
	# Arguments

	function help {
		__print_help "$@" <<-EOF || return $?
			ABOUT:
			Checks if the system matches.

			USAGE:
			is-system [...options]

			OPTIONS:
			--regexp=<regexp>
			    Checks \`/etc/os-release\` for the case-insensitive extended regular expression <regexp>.
			    Uses \`grep\` for extended regexp matching.
			--id=<id>
			    Checks \`/etc/os-release\` for the case-insensitive ID.

			--almalinux
			    Checks if the OS is AlmaLinux.
			--alpine
			    Checks if the OS is Alpine Linux.
			--apk
			    Checks if \`apk\` exists.
			--appimage
			    Checks if AppImage tools exist.
			--apple-silicon
			    Checks if the system is running on Apple Silicon (ARM) architecture.
			--apt
			    Checks if \`apt-get\` exists.
			--arch
			    Checks if the OS is Arch Linux.
			--brew | --homebrew
			    Checks if Homebrew exists.
			--deb
			    Checks if \`apt-get\` or \`dpkg\` exists.
			--debian
			    Checks if the OS is Debian.
			--dnf
			    Checks if \`dnf\` exists.
			--flatpak
			    Checks if \`flatpak\` exists.
			--gnome
			    Checks if the desktop session is GNOME.
			--headful
			    Checks if the system is headful (has a desktop environment).
			--headless
			    Checks if the system is headless (no desktop environment).
			--kde
			    Checks if the desktop session is KDE or LXDE.
			--linux
			    Checks if the OS is Linux.
			--mac | --macos | --darwin
			    Checks if the OS is macOS.
			--manjaro
			    Checks if the OS is Manjaro.
			--openmandriva
			    Checks if the OS is OpenMandriva.
			--opensuse
			    Checks if the OS is openSUSE.
			--raspi | --raspberry-pi | --raspberrypi
			    Checks if the system is a Raspberry Pi.
			--rpm
			    Checks if \`dnf\`, \`rpm\`, \`urpmi\`, or \`yum\` exists.
			--scoop
			    Checks if \`scoop\` exists.
			--snap
			    Checks if \`snap\` exists.
			--ubuntu
			    Checks if the OS is Ubuntu.
			--windows
			    Checks if the OS is Windows (including WSL).
			--winget
			    Checks if \`winget\` exists.
			--wsl
			    Checks if the OS is Windows Subsystem for Linux (WSL).
			--yum
			    Checks if \`yum\` exists.

			RETURNS:
			[0] if the pattern was found (is linux and the desired distro)
			[22] if no options were provided
			[93] if the pattern was not found (is linux, but not the desired distro)
			[46] if the operation is not supported (not linux)

			QUIRKS:
			If multiple options are provided, all must match for a [0] return.
		EOF
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item
	if [[ $# -eq 0 ]]; then
		help 'No options were provided.' || return $?
	fi
	while [[ $# -ne 0 ]]; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		# generic
		'--id='*) __os_id "${item#*=}" || return $? ;;
		'--regexp='*) __os_regexp "${item#*=}" || return $? ;;
		# specific
		# NAME="AlmaLinux"
		# ID="almalinux"
		# ID_LIKE="rhel centos fedora"
		'--almalinux') __os_id 'almalinux' || return $? ;;
		'--alpine') __os_id 'alpine' || return $? ;;
		'--apk') __command_exists -- apk || return 93 ;;
		'--appimage') __command_exists -- 'appimaged' 'appimagetool' 'mkappimage' || return 93 ;;
		'--apple-silicon') __is_apple_silicon || return $? ;;
		'--apt') __command_exists -- apt-get || return 93 ;;
		'--arch') [[ -f '/etc/arch-release' ]] || return 93 ;;
		'--brew' | '--homebrew') __is_brew || return 93 ;;
		# for some reason, `apt` exists on macos at /usr/bin/apt, so use `apt-get` instead
		'--deb') __command_exists -- apt-get || __command_exists -- dpkg || return 93 ;;
		# ID=debian
		'--debian') __os_id 'debian' || return $? ;;
		'--dnf') __command_exists -- dnf || return 93 ;;
		'--flatpak') __command_exists -- flatpak || return 93 ;;
		'--gnome') __is_desktop_session '^gnome$' || return $? ;;
		'--headful') __is_headful || return $? ;;
		'--headless') __is_headless || return $? ;;
		'--kde') __is_desktop_session '^(LXDE|KDE)' || return $? ;;
		'--linux') __is_linux || return 93 ;;
		'--mac' | '--macos' | '--darwin') __is_macos || return $? ;;
		# `uname -r` is release level
		# `uname -r` = `6.11.0-1018-azure`
		# `ID=manjaro`
		'--manjaro') __os_id 'manjaro' || return $? ;;
		# ID="openmandriva"
		'--openmandriva') __os_id 'openmandriva' || return $? ;;
		# NAME="openSUSE Tumbleweed"
		# ID="opensuse-tumbleweed"
		# ID_LIKE="opensuse suse"
		'--opensuse') __os_regexp 'openSUSE' || return $? ;;
		'--raspi' | '--raspberry-pi' | '--raspberrypi') __uname_regexp 'raspi' || return $? ;;
		'--rpm') __command_exists -- dnf || __command_exists -- rpm || __command_exists -- urpmi || __command_exists -- yum || return 93 ;;
		'--scoop') __command_exists -- scoop || return 93 ;;
		'--snap') __command_exists -- snap || return 93 ;;
		'--ubuntu') __os_id 'ubuntu' || return $? ;;
		# CI:
		# OSTYPE: msys
		# uname -a: MINGW64_NT-10.0-26100 fv-az1791-892 3.6.3-086201ea.x86_64 2025-06-05 13:51 UTC x86_64 Msys
		# WSL:
		# OSTYPE: linux-gnu
		# uname -a: Linux balupton-windows 6.6.87.2-microsoft-standard-WSL2 #1 SMP PREEMPT_DYNAMIC Thu Jun  5 18:30:46 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux
		'--windows') __is_windows || return $? ;;
		'--winget') __command_exists -- winget.exe || return 93 ;;
		'--wsl') __is_wsl || return 93 ;;
		'--yum') __command_exists -- yum || return 93 ;;
		# unrecognised
		'--'*) help 'An unrecognised flag was provided: ' --variable-value={item} ;;
		*) help 'An unrecognised argument was provided: ' --variable-value={item} ;;
		esac
	done
	return 0
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	is_system "$@"
fi
