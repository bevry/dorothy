#!/usr/bin/env bash

function researchgate_rename() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function help {
		cat <<-EOF >/dev/stderr
			ABOUT:
			Rename papers downloaded from Research Gate to be consistent.

			USAGE:
			researchgate-rename
		EOF
		if test "$#" -ne 0; then
			echo-error "$@"
		fi
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item
	while test "$#" -ne 0; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--'*) help "An unrecognised flag was provided: $item" ;;
		*) help "An unrecognised argument was provided: $item" ;;
		esac
	done

	# =====================================
	# Dependencies

	setup-util-sd --quiet
	setup-util-python --quiet

	# =====================================
	# Action

	local regex file id name year f nf np dir filename dup

	regex='researchgate.net/publication/(\w+)'
	for file in "$@"; do
		id=''
		name=''
		year=''
		f="$(mktemp)"
		pdftotext -layout -eol unix "$file" "$f"
		while read -r line; do
			# echo $line
			if test -z "$id"; then
				# find id
				id="$(print_line "$line" | python-regex "$regex")"
			elif test -z "$name"; then
				# trim possibly invalid chars from name
				name="$(print_line "$line" | echo-trim-special --stdin)"
			elif test -z "$year"; then
				year="$(print_line "$line" | python-regex '[^\d](\d\d\d\d)[^\d]')"
			else
				break
			fi
		done < <(grep --after-context=10 --extended-regexp --regexp="$regex" <"$f" | grep --regexp='.')

		# print_line "id=[$id] year=[$year]"
		#id="$(python-regex "$f" "$regex")"
		#url="https://www.researchgate.net/publication/$id"

		if test -n "$id" -a -n "$name"; then
			if test -n "$year"; then
				nf="$year - $name [$id].pdf"
			else
				nf="$name [$id].pdf"
			fi
			dir="$(dirname "$file")"
			filename="$(basename "$file")"
			np="$dir/$nf"
			if test "$file" = "$np"; then
				cat <<-EOF
					$filename
					=> already named correctly
				EOF
			else
				dup=1
				while test -f "$np"; do
					if is-same summary --algorithm=sha256sum -- "$file" "$np"; then
						rm "$file"
						cat <<-EOF
							$filename
							=> duplicate, removed
						EOF
						np=''
						break
					fi
					dup=$((dup + 1))
					nf="${nf%.pdf*} [$dup].pdf"
					np="$dir/$nf"
				done
				if test -n "$np"; then
					mv "$file" "$np"
					cat <<-EOF
						$filename
						=> $nf
					EOF
				fi
			fi
		fi
	done
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	researchgate_rename "$@"
fi
