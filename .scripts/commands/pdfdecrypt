#!/usr/bin/env bash
set -e

p="$(pwd)"
password="$1"
outdir="$2"
if is_empty_string "$outdir"; then
	outdir="out"
fi
outdir="$(fullpath "$outdir")"
mkdir -p "$outdir"

function decrypt {
	local input="$(fullpath "$1")"
	local inputdir="$(dirname "$input")"
	local inputfile="$(basename "$input")"
	local output="$outdir/$(basename "$1")"
	cd "$inputdir"
	echo "$1 to $output"
	while is_file "$output"; do
		output="${output%.*}!.pdf"
	done
	qpdf -password="$password" -decrypt "$input" "$output" && echo "SUCCESS" || echo "FAILURE"
	cd "$p"
}

if is_string "$password"; then
	findfiles pdf | while read -r file; do
		decrypt "$file" "$2" "$1"
	done
else
	echo "decrypt <password>"
fi
